<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Br√∏yterute ‚Äì v9.10 (Romerike Trefelling)</title>
<meta name="theme-color" content="#0f9d58">
<link rel="manifest" href="manifest.json">

<!-- Leaflet + Draw (for Admin kart/tegning) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="">
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" integrity="" crossorigin="">
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>
<script defer src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" integrity="" crossorigin=""></script>

<style>
:root{
  --bg:#111; --fg:#f5f7fa; --muted:#b9c2cc;
  --card:#181a1e; --cardBorder:#2a2f36;
  --green:#0f9d58; --blue:#0b66ff; --red:#c21d03; --gray:#2f3337;
  --purple:#7c3aed;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#fafafa; --fg:#0b0b0b; --muted:#5b6673;
         --card:#ffffff; --cardBorder:#e6e7ea; --gray:#e5e7eb; }
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
body{background:var(--bg);color:var(--fg)}
a{color:inherit;text-decoration:none}
button{cursor:pointer}
input,select,textarea{
  background:transparent;color:inherit;border:1px solid var(--cardBorder);
  border-radius:10px;padding:10px;font-size:16px
}

#app{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}

header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#0b0b0b;color:#fff;border-bottom:1px solid #141414}
header h1{margin:0;font-size:16px}
.spacer{flex:1}

.nav{display:flex;gap:8px;flex-wrap:wrap}
.tab{border:none;border-radius:12px;padding:8px 12px;background:#25282e;color:#fff}
.tab.active{background:var(--green)}

.page{display:none;padding:14px}
.page.active{display:block}

.card{background:var(--card);border:1px solid var(--cardBorder);border-radius:16px;padding:14px}
.stack{display:flex;flex-direction:column;gap:12px}
.row{display:flex;flex-wrap:wrap;gap:10px}

.btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700}
.btn-green{background:var(--green);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-gray{background:var(--gray);color:#111}
.btn-purple{background:var(--purple);color:#fff}

.title-lg{font-size:26px;font-weight:800}
.muted{color:var(--muted)}
.small{font-size:12px}

.progress{width:100%;height:14px;border-radius:999px;background:#242830;border:1px solid var(--cardBorder);overflow:hidden}
.progress>.bar{height:100%;width:0%;background:linear-gradient(90deg,#0f9d58,#22c55e);transition:width .25s ease}

.footer{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 12px;background:#0b0b0b;color:#fff;border-top:1px solid #141414;font-size:12px}

.install{border:1px dashed #334;border-radius:12px;padding:10px;background:#15181d}

/* V√¶r-widget: time-for-time (n√• + 3 neste timer) */
.weather{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.weather .pill{border:1px solid var(--cardBorder);border-radius:999px;padding:6px 10px}
.weather .now{font-weight:700}
#weatherTimeline{display:flex;gap:8px;flex-wrap:wrap}
#weatherTimeline .slot{border:1px solid var(--cardBorder);border-radius:12px;padding:6px 10px;min-width:90px}

/* Hanske-modus */
.hanske .btn{font-size:22px;padding:16px 20px;border-radius:18px}

/* Service: bokser under hverandre */
.service-list{display:flex;flex-direction:column;gap:6px}
.service-item{display:flex;align-items:center;gap:8px}

/* Leaflet container */
#adminMap{width:100%;min-height:360px;border:1px solid var(--cardBorder);border-radius:12px;overflow:hidden}
.leaflet-container{background:#0b0b0b}

/* Badges */
.badge{display:inline-block;border:1px solid var(--cardBorder);border-radius:999px;padding:2px 8px;font-size:12px}
.badge.warn{border-color:#d97706;color:#f59e0b}

/* Reset-knapp */
.reset-row{margin-top:6px}
</style>

<script>
/* ===== Globale konstanter (brukes i alle deler) ===== */
window.BROYTE_CFG = {
  VERSION: "9.10",
  // JSONBin: faste + dine oppgitte bin-id'er
  BINS: {
    MASTER: "68e774c9ae596e708f0b9977",         // rute/status
    CATALOG: "68e782f3d0ea881f409ae08a",        // katalog
    INBOX: "68e7833843b1c97be95ff286",          // forslag
    BACKUP: "68e7b4d2ae596e708f0bde7d",         // backup
    REPORT: "68e89e3443b1c97be9611c48",         // dagsrapporter
    POSITIONS: "68ed41ee43b1c97be9661c65",      // ‚Üê dine live-posisjoner
    MAP_LAYERS: "68ed425cae596e708f11d25f"      // ‚Üê dine tegnelag
  },
  HEARTBEAT_MS: 30000,
  BASE_ADDR: "Hagavegen 8, 2072 Dal",
  GRAVEL_ADDR: "Dal pukkverk",                  // oppdatert iht. √∏nsket
  FUEL_CHOICES: [
    {name:"Driv Dal", q:"Driv Dal avgiftsfri diesel"},
    {name:"Esso Energi Dal", q:"Esso Energi Dal avgiftsfri diesel"}
  ],
  DEFAULT_TASKS: [
    "Sn√∏",
    "Sn√∏ og grus",
    "Sn√∏ + br√∏ytestikker",
    "Sn√∏ og grus + br√∏ytestikker"
  ]
};
// default n√∏kkel (kan overskrives lokalt av bruker i UI)
window.DEFAULT_JSONBIN_KEY = "$2a$10$DK3EUoEj/YsimWzgYG.DMOb4aEFFUiRPdJgmkOzfPQ3Jx2evIIWma";
</script>
</head>
<body>
<div id="app">
  <!-- HEADER / NAV -->
  <header>
    <h1>Br√∏yterute</h1>
    <div class="spacer"></div>
    <div class="nav">
      <button class="tab active" data-tab="home">Hjem</button>
      <button class="tab" data-tab="work">Under arbeid</button>
      <button class="tab" data-tab="register">Adresse-register</button>
      <button class="tab" data-tab="admin">Admin</button>
      <button class="tab" data-tab="service">Service</button>
    </div>
  </header>

  <!-- HJEM -->
  <div id="page-home" class="page active">
    <div class="card stack">
      <h2>Innstillinger</h2>

      <div class="row">
        <label>Rolle</label>
        <select id="role">
          <option value="driver1">Sj√•f√∏r 1</option>
          <option value="driver2">Sj√•f√∏r 2</option>
          <option value="driver3">Sj√•f√∏r 3</option>
          <option value="driver4">Sj√•f√∏r 4</option>
          <option value="admin">Admin (lese)</option>
        </select>

        <label>Retning</label>
        <select id="direction">
          <option value="forward">Vanlig</option>
          <option value="reverse">Baklengs</option>
        </select>

        <label style="display:flex;gap:6px;align-items:center">
          <input id="useCustomName" type="checkbox"> Bruk eget navn
        </label>
        <input id="customName" type="text" placeholder="Skriv navnet ditt" style="min-width:220px;display:none">

        <label><input id="bigBtn" type="checkbox"> Hanske-modus</label>
        <label><input id="autoCheck" type="checkbox" checked> Auto sjekk-inn</label>
      </div>

      <div class="row">
        <label>Tema</label>
        <select id="themeSel">
          <option value="auto">Auto (system)</option>
          <option value="dark">M√∏rk</option>
          <option value="light">Lys</option>
        </select>
      </div>

      <div class="row" id="syncRow" style="align-items:center;gap:8px">
        <label id="keyBlock">
          Synk-n√∏kkel
          <input id="apiKey" type="password" placeholder="Lim inn X-Master-Key (lokalt)">
        </label>
        <button id="saveKey" class="btn btn-blue">Lagre n√∏kkel</button>
        <span id="syncStatus" class="badge">Synk ‚Äì</span>
        <a id="editKey" href="#" class="small" style="display:none">Endre n√∏kkel</a>
      </div>

      <div class="row">
        <button id="btnRoundByEquip" class="btn btn-blue">Start ny runde (etter utstyr)</button>
        <button id="btnResetAll" class="btn btn-red">Nullstill alle</button>
        <button id="btnStart" class="btn btn-green">Start runde ‚Üí</button>
        <button id="btnSyncNow" class="btn btn-gray">Synk n√•</button>
      </div>

      <div class="row reset-row">
        <button id="btnHardReset" class="btn btn-red">üßπ T√∏m cache og start p√• nytt</button>
      </div>

      <div class="small muted" id="lastSyncText">‚Äî</div>
      <div class="muted" id="directionNote">‚Äî</div>
    </div>

    <!-- Installer som app -->
    <div id="installCard" class="card install" style="display:none">
      <h3>Installer som app</h3>
      <div class="small muted">For fullskjerm uten adressefelt.</div>
      <div class="row">
        <button id="btnInstall" class="btn btn-green">üì≤ Installer app</button>
        <button id="btnInstallHelp" class="btn btn-gray">Hvordan?</button>
      </div>
      <div id="installHelp" class="small" style="display:none">
        <p><b>iPhone (Safari)</b>: Del-ikon ‚Üí <i>Legg til p√• Hjem-skjermen</i>.</p>
        <p><b>Android (Chrome)</b>: Meny ‚ãÆ ‚Üí <i>Installer app</i>.</p>
      </div>
    </div>

    <div class="card stack">
      <h3>Utstyr</h3>
      <div class="row">
        <label><input id="eq_plog" type="checkbox" checked> Plog</label>
        <label><input id="eq_fres" type="checkbox"> Fres</label>
        <label><input id="eq_stro" type="checkbox"> Str√∏kasse</label>
      </div>
    </div>
  </div>

  <!-- UNDER ARBEID -->
  <div id="page-work" class="page">
    <div class="card stack">
      <div class="row" style="align-items:center;gap:8px">
        <div id="driverLbl" class="muted">Rolle: ‚Äî</div>
        <div id="directionLbl" class="badge">Retning: ‚Äî</div>
        <div id="claimWarn" class="badge warn" style="display:none">‚ö†Ô∏è Delt retning</div>
      </div>

      <h2 id="curName" class="title-lg">‚Äî</h2>
      <div class="muted">Oppgave: <span id="curTask">‚Äî</span></div>
      <div class="muted">Neste: <span id="curNext">‚Äî</span></div>

      <div class="progress-row" style="display:flex;align-items:center;gap:10px">
        <div class="muted" id="progTxt">0 % fullf√∏rt (0/0)</div>
        <div class="progress" style="flex:1;min-width:160px">
          <div class="bar" id="progBar"></div>
        </div>
      </div>
      <div class="small muted" id="lastSyncTextWork">‚Äî</div>

      <div class="thumbs" id="thumbs"></div>

      <div class="row">
        <button id="ongo" class="btn btn-gray">‚ñ∂Ô∏è P√•g√•r</button>
        <button id="done" class="btn btn-green">‚úÖ Utf√∏rt</button>
        <button id="block" class="btn btn-red">‚õî Ikke mulig</button>
        <button id="photo" class="btn btn-gray">üì∑ Foto</button>
        <button id="nav" class="btn btn-blue">üß≠ Naviger</button>
        <button id="next" class="btn btn-gray">üîÅ Neste</button>
        <button id="incident" class="btn btn-red">‚ùó Uhell</button>
      </div>

      <div class="row">
        <button id="goBase" class="btn btn-purple">üè† Kj√∏r til base</button>
        <button id="fillGravel" class="btn btn-blue">ü™® Fyll grus</button>
        <button id="fillFuel" class="btn btn-blue">‚õΩ Fyll drivstoff</button>
        <button id="cheapestFuel" class="btn btn-gray">üí∏ Finn billigste (s√∏k)</button>
      </div>

      <!-- V√ÜR: n√• + neste 3 timer, time-for-time -->
      <div id="weatherCard" class="card">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div><b>V√¶r (n√• + 3t, time for time)</b> <span class="small muted" id="weatherAt">‚Äì</span></div>
          <div class="small muted" id="weatherLoc">‚Äî</div>
        </div>
        <div class="weather" id="weatherRow">
          <span class="pill">Laster ‚Ä¶</span>
        </div>
        <div id="weatherTimeline"></div>
      </div>
    </div>
  </div>

  <!-- ADRESSE-REGISTER -->
  <div id="page-register" class="page">
    <div class="card stack">
      <div class="row">
        <button id="btnCatalogPull" class="btn btn-blue">‚ÜòÔ∏é Hent fra katalog</button>
        <button id="btnPropose" class="btn btn-gray">‚úçÔ∏è Foresl√• endring/ny</button>
      </div>
      <div class="small muted">
        Katalogen er ¬´felles liste¬ª. Lokale tillegg under p√•virker kun din enhet (til neste publisering).
      </div>

      <div id="pinFilters" class="row">
        <button class="btn btn-gray" data-pf="all">Alle</button>
        <button class="btn btn-gray" data-pf="pending">Uten br√∏ytestikker i √•r</button>
        <button class="btn btn-gray" data-pf="done">Med br√∏ytestikker i √•r</button>
        <span id="pinFilterInfo" class="small muted">‚Äî</span>
      </div>
    </div>

    <div id="list"></div>

    <div class="card stack">
      <h3>Legg til ny adresse (lokalt)</h3>
      <div class="row">
        <input id="addr" type="text" placeholder="Adresse / omr√•de" style="flex:2">
        <!-- FYLLES AV JS MED window.BROYTE_CFG.DEFAULT_TASKS -->
        <select id="taskSel" style="flex:1"></select>
      </div>

      <div class="row">
        <label style="display:flex;gap:6px;align-items:center">
          <input id="twoDriverRec" type="checkbox"> Anbefalt 2 sj√•f√∏rer
        </label>
        <div style="flex:1"></div>
        <button id="add" class="btn btn-green">+ Legg til</button>
      </div>

      <div class="small muted">Tips: Enter i adressefeltet = legg til raskt.</div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="page-admin" class="page">
    <div class="card stack">
      <h2>Admin</h2>
      <div class="row">
        <button id="adminSync" class="btn btn-gray">Hent status n√•</button>
        <span id="adminSyncTxt" class="muted">‚Äî</span>
      </div>

      <div class="row" id="pinFiltersAdmin">
        <button class="btn btn-gray" data-pfa="all">Alle</button>
        <button class="btn btn-gray" data-pfa="pending">Uten br√∏ytestikker i √•r</button>
        <button class="btn btn-gray" data-pfa="done">Med br√∏ytestikker i √•r</button>
        <span id="pinFilterInfoAdmin" class="small muted">‚Äî</span>
      </div>

      <!-- KART + TEGN -->
      <div class="card stack">
        <h3>Kart (live posisjon + tegn verkt√∏y)</h3>
        <div id="adminMap"></div>
        <div class="small muted">
          Lagre/last kartlag synkes mot JSONBin (MapLayers). Live posisjoner hentes fra Positions.
        </div>
        <div class="row">
          <button id="mapSave" class="btn btn-green">üíæ Lagre lag</button>
          <button id="mapLoad" class="btn btn-blue">üì• Last lag</button>
          <button id="mapClear" class="btn btn-red">üóë T√∏m lag (lokalt)</button>
        </div>
      </div>

      <div id="adminStats" class="muted">Ingen data enda.</div>
      <div id="adminList"></div>
    </div>

    <div class="card stack">
      <h3>Katalog (felles) ‚Äì rediger</h3>
      <div class="small muted">Endringer lagres til katalogen og backup tas automatisk.</div>
      <div class="row">
        <button id="catLoad" class="btn btn-gray">Last katalog</button>
        <button id="catAdd" class="btn btn-blue">‚ûï Legg til</button>
        <button id="catSave" class="btn btn-green">üíæ Lagre katalog</button>
        <button id="catPublish" class="btn btn-blue">üöÄ Publiser til MASTER</button>
        <button id="catExportCsv" class="btn btn-gray">‚¨áÔ∏é Eksporter CSV</button>
      </div>
      <div id="catMsg" class="small muted">‚Äî</div>
      <div id="catList"></div>
      <div class="row">
        <button id="catRestore" class="btn btn-red">‚è™ Gjenopprett fra backup</button>
      </div>
    </div>

    <div class="card stack">
      <h3>Forslag (INBOX)</h3>
      <div class="row">
        <button id="adminInbox" class="btn btn-gray">Hent forslag</button>
        <span id="adminInboxTxt" class="muted">‚Äî</span>
      </div>
      <div id="inboxList"></div>
    </div>
  </div>

  <!-- SERVICE -->
  <div id="page-service" class="page">
    <div class="card stack">
      <h2>Service / Vedlikehold</h2>
      <div class="service-list">
        <label class="service-item"><input id="svc_plog" type="checkbox"> Smurt plog</label>
        <label class="service-item"><input id="svc_fres" type="checkbox"> Smurt fres</label>
        <label class="service-item"><input id="svc_stro" type="checkbox"> Smurt str√∏kasse</label>
        <label class="service-item"><input id="svc_oil_front" type="checkbox"> Sjekk olje (foran)</label>
        <label class="service-item"><input id="svc_oil_back" type="checkbox"> Sjekk olje (bak)</label>
        <label class="service-item"><input id="svc_steering" type="checkbox"> Forstilling smurt</label>
        <label class="service-item"><input id="svc_other" type="checkbox"> Annet</label>
      </div>

      <textarea id="svcNotes" placeholder="Anmerkninger ‚Ä¶" style="width:100%;min-height:120px"></textarea>

      <div class="row">
        <button id="svcSave" class="btn btn-green">üì§ Lagre og del CSV</button>
        <button id="svcGuide" class="btn btn-gray">üßæ Last ned brukerark (TXT)</button>
        <button id="svcSaveHtml" class="btn btn-blue">üóÇÔ∏è Lag HTML-rapport (dag)</button>
      </div>

      <div class="small muted">
        HTML-rapport inkluderer bilder, oppgaver, hvem som utf√∏rte og v√¶r-notater som ble lagret underveis.
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div id="pos">‚Äî</div>
    <div>v<span id="verLbl">9.10</span> ‚Äì Romerike Trefelling</div>
  </div>

  <!-- Foto-opplasting -->
  <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">
</div>
<script>
/* ====== KONFIG / VERSJON ====== */
window.BROYTE_CFG = {
  VERSION: "9.10",
  HEARTBEAT_MS: 30000,

  // JSONBin
  DEFAULT_API_KEY: "$2a$10$DK3EUoEj/YsimWzgYG.DMOb4aEFFUiRPdJgmkOzfPQ3Jx2evIIWma",
  BINS: {
    MASTER:    "68e774c9ae596e708f0b9977", // rute/status
    CATALOG:   "68e782f3d0ea881f409ae08a", // katalog
    INBOX:     "68e7833843b1c97be95ff286", // forslag
    BACKUP:    "68e7b4d2ae596e708f0bde7d", // backup
    REPORTS:   "68e89e3443b1c97be9611c48", // dagsrapporter
    POSITIONS: "68ed41ee43b1c97be9661c65", // live posisjoner (ny)
    MAPLAYERS: "68ed425cae596e708f11d25f"  // kartlag (ny)
  },

  // Standardadresser
  BASE_ADDR: "Hagavegen 8, 2072 Dal",
  GRAVEL_ADDR: "Dal pukkverk",

  // Oppgaver (kun de du √∏nsket)
  DEFAULT_TASKS: [
    "Sn√∏ + br√∏ytestikker",
    "Sn√∏ og grus + br√∏ytestikker"
  ]
};

/* ====== LS-KEY + STATE ====== */
const LS_KEY = "broyte_v910_state";
let state = loadState() || makeDefaultState();

function makeDefaultState(){
  return {
    role: "driver1",
    direction: "forward",
    equipment: { plog: true, fres: false, stro: false },
    autoCheck: true,
    hanske: false,
    useCustomName: false,
    customName: "",
    theme: "auto",

    stops: [],

    service: {
      plog: false,
      fres: false,
      stro: false,
      oilFront: false,
      oilBack: false,
      steering: false,   // Forstilling smurt
      other: false,
      notes: ""
    },

    lastSyncAt: null,
    lastSyncBy: "",
    ui: { pinFilter: "all", adminPinFilter: "all" },
    lastActiveAt: Date.now(),

    // Daglig logg (for HTML-rapport)
    dayLog: {
      dateKey: dateKey(new Date()),
      entries: [] // {ts,type,name,task,note,who,photos,weather}
    }
  };
}

/* ====== DOM SHORTCUT ====== */
const $ = id => document.getElementById(id);

/* ====== STORAGE ====== */
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){
  try { return JSON.parse(localStorage.getItem(LS_KEY) || ""); }
  catch { return null; }
}

/* ====== API KEY / HEADERS ====== */
function apiKey(){
  return localStorage.getItem("broyte_api_key") || window.BROYTE_CFG.DEFAULT_API_KEY;
}
function headers(){
  return { "Content-Type":"application/json", "X-Master-Key": apiKey() };
}

/* ====== UTIL ====== */
const esc = s => String(s ?? "");
const fmtTime = ts => ts ? new Date(ts).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",second:"2-digit"}) : "‚Äî";
const fmtDT   = ts => ts ? new Date(ts).toLocaleString("no-NO") : "‚Äî";

function displayName(){
  return state.useCustomName && state.customName
    ? state.customName
    : (state.role || "Sj√•f√∏r");
}
function dateKey(d){ return d.toISOString().slice(0,10); }
function seasonKey(){
  const d=new Date(), y=d.getFullYear(), m=d.getMonth()+1;
  return m>=7 ? `${y}/${(y+1).toString().slice(-2)}` : `${y-1}/${y.toString().slice(-2)}`;
}
function touchActivity(){ state.lastActiveAt = Date.now(); save(); }
function applyTheme(mode){ document.documentElement.dataset.theme = mode; }

/* ====== RUTEHJELPERE ====== */
function idxList(){
  const rem = state.stops.map((s,i)=>({i,s}))
                         .filter(x=>!x.s.f && !x.s.b)
                         .map(x=>x.i);
  return state.direction === "forward" ? rem : rem.slice().reverse();
}
function cur(){ const l=idxList(); return l.length ? state.stops[l[0]] : null; }
function curIndex(){ const l=idxList(); return l.length ? l[0] : -1; }
function nxt(){ const l=idxList(); return l.length>1 ? state.stops[l[1]] : null; }
function prog(){
  const total = state.stops.length;
  const done = state.stops.filter(s=>s.f).length;
  const blocked = state.stops.filter(s=>s.b).length;
  const cleared = done + blocked;
  const pct = total ? Math.round(100*cleared/total) : 0;
  return { total, done, blocked, cleared, pct };
}

/* ====== NAVIGASJON ====== */
function navTo(address){
  if(!address) return;
  location.href = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(address);
}
function mapsSearch(q){
  location.href = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(q);
}

/* ====== GEOPOSISJON FOOTER ====== */
function initGeolocation(){
  const posEl = $("pos"); if(!posEl) return;
  if(!navigator.geolocation){
    posEl.textContent = "Posisjon ikke tilgjengelig"; return;
  }
  const fmt=n=>Number.isFinite(n)?n.toFixed(5):"‚Äî";
  navigator.geolocation.watchPosition(
    (p)=>{ const {latitude,longitude,accuracy}=p.coords||{};
           posEl.textContent = `${fmt(latitude)}, ${fmt(longitude)} (¬±${Math.round(accuracy||0)} m)`; },
    ()=>{ posEl.textContent = "Posisjon utilgjengelig"; },
    { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
  );
}

/* ====== FEIL-BANNER (DEV-HJELP) ====== */
window.addEventListener('error', (ev) => {
  try{
    const bar = document.createElement('div');
    bar.style.cssText = 'position:fixed;left:0;right:0;bottom:0;background:#b00020;color:#fff;padding:8px 12px;font:12px system-ui;z-index:99999';
    bar.textContent = 'JS-feil: ' + (ev.message || 'ukjent') + (ev.filename ? ' @ ' + ev.filename + ':' + ev.lineno : '');
    document.body.appendChild(bar);
    console.error('JS error', ev);
  }catch(_){}
});

/* ====== BOOT DEFAULTS (f√∏rste gangs bruk) ====== */
function bootDefaults(){
  if(!Array.isArray(state.stops)) state.stops = [];
  if(state.stops.length===0){
    state.stops = [
      { n:"AMFI Eidsvoll (R√•holt)", t: window.BROYTE_CFG.DEFAULT_TASKS[0], f:false, b:false, p:[], twoDriverRec:false, pinsCount:0, pinsLockedYear:null },
      { n:"R√•holt barneskole",      t: window.BROYTE_CFG.DEFAULT_TASKS[1], f:false, b:false, p:[], twoDriverRec:true,  pinsCount:0, pinsLockedYear:null },
      { n:"R√•holt ungdomsskole",    t: window.BROYTE_CFG.DEFAULT_TASKS[0], f:false, b:false, p:[], twoDriverRec:false, pinsCount:0, pinsLockedYear:null }
    ];
    save();
  }
}

/* ====== GLOBAL EKSPORT FOR SENERE DELER ====== */
window.BroyteHelpers = {
  $, save, loadState, apiKey, headers, esc, fmtTime, fmtDT,
  displayName, dateKey, seasonKey, touchActivity, applyTheme,
  idxList, cur, curIndex, nxt, prog, navTo, mapsSearch,
  initGeolocation, bootDefaults
};
</script>
<script>
/* ===== Del D: Sync + v√¶r (H+1..H+3) + live pos + render ===== */
(() => {
  const CFG = window.BROYTE_CFG;
  const H = window.BroyteHelpers;
  const { $, save, apiKey, headers, esc, fmtTime, fmtDT,
          displayName, dateKey, seasonKey, touchActivity,
          idxList, cur, curIndex, nxt, prog, navTo, mapsSearch } = H;

  /* ---------- SYNC (MASTER) ---------- */
  async function syncPull(){
    try{
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MASTER}/latest`, { headers: headers() });
      const js = await r.json();
      if(js?.record?.stops){
        // Normaliser
        const norm = s => ({
          n: s.n, t: s.t,
          f: !!s.f, b: !!s.b,
          p: Array.isArray(s.p)? s.p : [],
          started: s.started||null, finished: s.finished||null,
          details: s.details||"",
          twoDriverRec: !!s.twoDriverRec,
          pinsCount: s.pinsCount||0,
          pinsLockedYear: s.pinsLockedYear||null
        });
        state.stops = js.record.stops.map(norm);
        state.lastSyncAt = js.record.lastSyncAt || Date.now();
        state.lastSyncBy = js.record.lastSyncBy || displayName();
        save(); renderWork(); renderRegister(); renderAdmin();
        if ($('syncStatus')) $('syncStatus').textContent = "Synk ‚Äì Pull OK";
        hideKeyRow();
      }else{
        if ($('syncStatus')) $('syncStatus').textContent = "Synk ‚Äì Pull tom";
      }
    }catch(e){
      if ($('syncStatus')) $('syncStatus').textContent = "Synk ‚Äì Pull FEIL";
      showKeyRow();
    }
  }
  async function syncPush(){
    try{
      const payload={ version: CFG.VERSION, updated: Date.now(), lastSyncAt: Date.now(), lastSyncBy: displayName(), stops: state.stops, meta:{role:state.role, direction:state.direction} };
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MASTER}`, { method:"PUT", headers: headers(), body: JSON.stringify(payload) });
      if(!r.ok) throw 0;
      state.lastSyncAt = payload.lastSyncAt; state.lastSyncBy = payload.lastSyncBy; save(); renderWork();
      if ($('syncStatus')) $('syncStatus').textContent = "Synk ‚Äì Push OK";
      hideKeyRow();
    }catch(e){
      if ($('syncStatus')) $('syncStatus').textContent = "Synk ‚Äì Push FEIL";
      showKeyRow();
    }
  }
  function hideKeyRow(){ const kb=$('keyBlock'), sk=$('saveKey'), ek=$('editKey'); if(kb) kb.style.display="none"; if(sk) sk.style.display="none"; if(ek) ek.style.display="inline"; }
  function showKeyRow(){ const kb=$('keyBlock'), sk=$('saveKey'), ek=$('editKey'); if(kb) kb.style.display="inline-block"; if(sk) sk.style.display="inline-block"; if(ek) ek.style.display="none"; }

  /* ---------- KATALOG (pull ‚Üí lokal) ---------- */
  async function catalogPull(){
    try{
      $('btnCatalogPull')?.setAttribute("disabled","disabled");
      $('btnCatalogPull')?.classList.add("muted");
      if ($('pinFilterInfo')) $('pinFilterInfo').textContent = "Henter katalog ‚Ä¶";

      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.CATALOG}/latest`);
      const js = await r.json();
      const cat = js?.record?.addresses || [];
      const active = cat.filter(a => a?.active !== false);

      const stops = active.map(a => ({
        n: a.name || "",
        t: a.task || CFG.DEFAULT_TASKS[0],
        f: false, b: false, p: [],
        started: null, finished: null, details: "",
        twoDriverRec: !!a.twoDriverRec,
        pinsCount: 0, pinsLockedYear: null
      }));

      if (!stops.length){
        alert("Ingen aktive adresser i katalogen.");
        if ($('pinFilterInfo')) $('pinFilterInfo').textContent = "Ingen aktive adresser i katalog.";
        return;
      }

      state.stops = stops;
      save(); renderRegister(); renderWork();

      try{
        await syncPush();
        if ($('pinFilterInfo')) $('pinFilterInfo').textContent = `Katalog hentet: ${stops.length} adresser.`;
        alert(`Katalog hentet ‚úÖ (${stops.length} adresser).`);
      }catch(_){
        if ($('pinFilterInfo')) $('pinFilterInfo').textContent = `Lokalt oppdatert: ${stops.length} adresser (push feilet ‚Äì sjekk n√∏kkel).`;
        alert(`Katalog hentet lokalt ‚úÖ (${stops.length}). Push feilet ‚Äì sjekk synk-n√∏kkel.`);
      }
    }catch(e){
      console.error(e);
      alert("Feil ved henting av katalog.");
      if ($('pinFilterInfo')) $('pinFilterInfo').textContent = "Feil ved henting.";
    }finally{
      $('btnCatalogPull')?.removeAttribute("disabled");
      $('btnCatalogPull')?.classList.remove("muted");
    }
  }

  /* ---------- INBOX (forslag) ---------- */
  async function sendProposal(obj){
    try{
      const latest = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.INBOX}/latest`, { headers: headers() }).then(r=>r.json());
      const rec = latest?.record || {version:CFG.VERSION, updated:0, proposals:[]};
      rec.proposals = rec.proposals || [];
      rec.proposals.push({ id: Math.random().toString(36).slice(2), type: obj.type||"add", from: displayName(), payload: obj, ts: Date.now(), status:"pending", note:"" });
      rec.updated = Date.now();
      await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.INBOX}`, { method:"PUT", headers: headers(), body: JSON.stringify(rec) });
      alert("Forslag sendt üëç");
    }catch(e){ alert("Kunne ikke sende forslag. Sjekk n√∏kkel."); }
  }
  async function loadInbox(){
    try{
      const js = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.INBOX}/latest`, { headers: headers() }).then(r=>r.json());
      const props = js?.record?.proposals||[];
      if ($('adminInboxTxt')) $('adminInboxTxt').textContent = "Forslag: " + props.length;
      if ($('inboxList')) $('inboxList').innerHTML = props.slice(-50).reverse().map(p=>`
        <div class="item">
          <b>${(p.type||'').toUpperCase()}</b> ‚Äì fra ${esc(p.from||'?')} ‚Äì ${new Date(p.ts).toLocaleString('no-NO')}<br>
          <span class="muted">${esc(p.payload?.name||'')} ${esc(p.payload?.task||'')}</span><br>
          <span class="badge">${p.status||'pending'}</span>
        </div>`).join("");
    }catch(e){ if ($('adminInboxTxt')) $('adminInboxTxt').textContent = "Feil ved henting."; }
  }

  /* ---------- V√ÜR: n√• + neste 3 timer (H+1..H+3) ---------- */
  let lastWeather = null;
  async function refreshWeather(){
    try{
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude:lat, longitude:lon} = pos.coords||{};
        if(!isFinite(lat)||!isFinite(lon)) return;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation&hourly=temperature_2m,precipitation&forecast_days=1&timezone=auto`;
        const r = await fetch(url);
        const js = await r.json();

        const nowT = js?.current?.temperature_2m ?? null;
        const nowP = js?.current?.precipitation ?? 0;
        const times = js?.hourly?.time||[];
        const temps = js?.hourly?.temperature_2m||[];
        const precs = js?.hourly?.precipitation||[];

        // Finn n√•-indeks (n√¶rmeste time)
        const nowISO = new Date().toISOString().slice(0,13); // YYYY-MM-DDTHH
        let idx = Math.max(0, times.findIndex(t => t.startsWith(nowISO)));
        // H+1..H+3
        const horizon = [idx+1, idx+2, idx+3].filter(i=>i<times.length);

        const pillNow = `<span class="pill now">N√•: ${Number.isFinite(nowT)?Math.round(nowT):'‚Äì'}¬∞C ¬∑ ${(nowP||0)>0 ? (nowP.toFixed(1)+' mm'):'0 mm'}</span>`;
        const pills = horizon.map(i=>{
          const t = new Date(times[i]);
          const hh = t.toLocaleTimeString('no-NO',{hour:'2-digit'});
          const tp = temps[i]; const pr = precs[i]||0;
          const isSnow = pr>0; // enkel indikator
          return `<span class="pill">${hh}: ${Math.round(tp)}¬∞C ¬∑ ${pr.toFixed(1)} mm ${isSnow?'(sn√∏)':''}</span>`;
        }).join("");

        if ($('weatherRow')) $('weatherRow').innerHTML = pillNow + pills;
        if ($('weatherAt')) $('weatherAt').textContent = new Date().toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'});
        if ($('weatherLoc')) $('weatherLoc').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;

        lastWeather = { ts: Date.now(), lat, lon, nowT, nowP,
                        next: horizon.map(i=>({time:times[i], t:temps[i], p:precs[i]})) };
      }, ()=>{/* ignore */}, {enableHighAccuracy:true,timeout:10000,maximumAge:60000});
    }catch(_){}
  }

  /* ---------- RENDERING ---------- */
  function hasPinsThisSeason(s){
    const y = s.pinsLockedYear;
    const sk = seasonKey();
    return y && String(y)===sk;
  }
  function renderWork(){
    const c=cur(), n=nxt();
    if ($('driverLbl')) $('driverLbl').textContent = "Rolle: " + displayName();
    if ($('directionLbl')) $('directionLbl').textContent = "Retning: " + (state.direction==="forward"?"Vanlig":"Baklengs");
    if ($('curName')) $('curName').textContent = c? esc(c.n) : "‚Äî";
    if ($('curTask')) $('curTask').textContent = c? esc(c.t) : "‚Äî";
    if ($('curNext')) $('curNext').textContent = n? esc(n.n) : "‚Äî";
    if ($('thumbs')) $('thumbs').innerHTML = c?.p?.length ? c.p.map(src=>`<img src="${src}" alt="foto">`).join("") : "";
    const {pct,cleared,total} = prog();
    if ($('progBar')) $('progBar').style.width = pct+"%";
    if ($('progTxt')) $('progTxt').textContent = `${pct} % fullf√∏rt (${cleared}/${total})`;
    if ($('directionNote')) $('directionNote').textContent = `Du kj√∏rer i ${(state.direction==="forward"?'vanlig':'baklengs')} rekkef√∏lge. (${displayName()})`;
    if ($('lastSyncText')) $('lastSyncText').textContent = `Sist synk: ${fmtTime(state.lastSyncAt)} (${state.lastSyncBy||'‚Äî'})`;
    if ($('lastSyncTextWork')) $('lastSyncTextWork').textContent = `Sist synk: ${fmtTime(state.lastSyncAt)} (${state.lastSyncBy||'‚Äî'})`;
    refreshWeather();
  }
  function renderRegister(){
    const pf = state.ui?.pinFilter || "all";
    let rows = state.stops.slice();
    if (pf === "pending") rows = rows.filter(s => !hasPinsThisSeason(s));
    if (pf === "done")    rows = rows.filter(hasPinsThisSeason);

    const label = pf==="all" ? "Alle" : (pf==="pending" ? "Uten pinner i √•r" : "Med pinner i √•r");
    const donePins = state.stops.filter(hasPinsThisSeason).length;
    const pendingPins = state.stops.length - donePins;
    if ($('pinFilterInfo')) $('pinFilterInfo').textContent =
      `${label}: ${rows.length} viste ¬∑ ${donePins} med pinner ¬∑ ${pendingPins} uten (sesong ${seasonKey()})`;

    if ($('list')) $('list').innerHTML = rows.length
      ? rows.map((s)=>`
          <div class="item">
            <b>${esc(s.n)}</b>
            ${s.twoDriverRec?`<span class="badge note">üë• 2 sj√•f√∏rer</span>`:""}
            ${s.pinsLockedYear ? `<span class="badge" title="Br√∏ytestikker l√•st ${s.pinsLockedYear}">üìç ${s.pinsCount??0} ‚Äì l√•st ${esc(s.pinsLockedYear)}</span>` : ``}
            <br><span class="muted">${esc(s.t)}</span> ${s.f?'‚úÖ':''} ${s.b?'‚õî':''}
          </div>`).join("")
      : `<div class="item muted">Ingen adresser enda. Hent fra katalog eller legg til lokalt.</div>`;
  }
  function renderAdmin(){
    const sk = seasonKey();
    const total = state.stops.length;
    const donePins = state.stops.filter(hasPinsThisSeason).length;
    const pendingPins = total - donePins;

    const pf = state.ui?.adminPinFilter || "all";
    let rows = state.stops.slice();
    if (pf === "pending") rows = rows.filter(s => !hasPinsThisSeason(s));
    if (pf === "done")    rows = rows.filter(hasPinsThisSeason);

    const pct = total ? Math.round(100 * (state.stops.filter(s=>s.f||s.b).length) / total) : 0;
    if ($('adminSyncTxt')) $('adminSyncTxt').textContent = `Viser lokal status (Synk n√• for MASTER).`;
    if ($('adminStats')) $('adminStats').innerHTML = `Totalt: ${total} ‚Äì Ferdig: ${state.stops.filter(s=>s.f).length} ‚Äì Ikke mulig: ${state.stops.filter(s=>s.b).length} ‚Äì ${pct}%`;
    const label = pf==="all" ? "Alle" : (pf==="pending" ? "Uten pinner i √•r" : "Med pinner i √•r");
    if ($('pinFilterInfoAdmin')) $('pinFilterInfoAdmin').textContent = `${label}: ${rows.length} viste ¬∑ ${donePins} med pinner ¬∑ ${pendingPins} uten (sesong ${sk})`;

    if ($('adminList')) $('adminList').innerHTML = rows.map((s)=>`
      <div class="item">
        <b>${esc(s.n)}</b>
        ${s.twoDriverRec?`<span class="badge note">üë• 2 sj√•f√∏rer</span>`:""}
        ${s.pinsLockedYear ? `<span class="badge" title="Br√∏ytestikker l√•st ${s.pinsLockedYear}">üìç ${s.pinsCount??0} ‚Äì l√•st ${esc(s.pinsLockedYear)}</span>` : ``}
        <br><span class="muted">${esc(s.t)}</span>
        <div class="small">Sist oppdatert av: ${esc(state.lastSyncBy||'‚Äî')}</div>
      </div>
    `).join("");
  }

  /* ---------- UNDER ARBEID: handlers ---------- */
  function onPhotoChosen(e){
    const f = e.target.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{ const c=cur(); if(!c) return; (c.p||(c.p=[])).push(r.result); logEntry('photo',c,"",[r.result]); save(); renderWork(); syncPush(); };
    r.readAsDataURL(f); e.target.value="";
  }
  function logEntry(type, stop, note="", photos=[]){
    const dk = dateKey(new Date());
    if(state.dayLog.dateKey !== dk){ state.dayLog={dateKey:dk,entries:[]}; }
    state.dayLog.entries.push({
      ts: Date.now(),
      type, name: stop?.n||"", task: stop?.t||"", note,
      who: displayName(),
      photos, weather: lastWeather
    });
    save();
  }
  function maybeTwoDriverPrompt(current){
    try{
      if(!current?.twoDriverRec) return;
      alert(`üë• Anbefalt 2 sj√•f√∏rer: ${current.n}\nKan du bidra? Trykk OK for √• √•pne navigasjon.`);
      navTo(current.n);
    }catch(_){}
  }
  function doneHandler(){
    touchActivity();
    const c = cur(); if(!c) return;

    // Dersom oppgaven inkluderer br√∏ytestikker ‚Üí sp√∏r antall
    if(/br√∏ytestikker/i.test(c.t)){
      const v = prompt("Antall br√∏ytestikker brukt?",""); if(v===null) return;
      c.pinsCount = parseInt(v||"0",10)||0;
      c.pinsLockedYear = seasonKey();
    }

    c.f = true; c.finished = Date.now();
    logEntry('done',c, c.details||"");
    save(); renderWork(); syncPush();
    const n = nxt(); if(n) navTo(n.n);
  }
  function blockHandler(){
    touchActivity();
    const c = cur(); if(!c) return;
    const r = prompt("Hvorfor ikke mulig √• utf√∏re? (valgfritt)","")||"";
    if(r) c.details = (c.details?c.details+" ¬∑ ":"") + "√Örsak: " + r;
    c.b = true; c.finished = Date.now();
    logEntry('block',c,r);
    save(); renderWork(); syncPush();
  }
  function nextHandler(){
    touchActivity();
    const c = cur(); if(!c) return;
    if(confirm("Markere utf√∏rt f√∏r neste?")){ c.f=true; c.finished=Date.now(); logEntry('done',c); save(); syncPush(); }
    renderWork(); const n=nxt(); if(n) navTo(n.n);
  }
  function incidentHandler(){
    const c=cur();
    const note = prompt("Kort beskrivelse av uhell (valgfritt):","")||"";
    logEntry('incident', c||{n:"(ukjent)",t:""}, note);
    alert("Uhell logget. Ta gjerne bilder med üì∑-knappen.");
  }

  /* ---------- LIVE POSISJON (heartbeat) ---------- */
  let lastSentPosTs = 0;
  function startLivePosition(){
    if(!navigator.geolocation) return;
    navigator.geolocation.watchPosition(async p=>{
      const now = Date.now();
      if (now - lastSentPosTs < 15000) return; // maks ~ hvert 15. sekund
      lastSentPosTs = now;

      const payload = {
        version: CFG.VERSION,
        updated: now,
        actor: displayName(),
        role: state.role,
        dir: state.direction,
        pos: {
          lat: p.coords.latitude,
          lon: p.coords.longitude,
          acc: p.coords.accuracy||null
        }
      };
      try{
        // Hent siste -> oppdater/append denne sj√•f√∏ren
        const latest = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.POSITIONS}/latest`, { headers: headers() }).then(r=>r.json()).catch(()=>({record:{positions:[]}}));
        const rec = latest?.record || {positions:[]};
        rec.positions = Array.isArray(rec.positions) ? rec.positions : [];
        const key = displayName() + '|' + (state.role||'driver');
        const idx = rec.positions.findIndex(x => x.key===key);
        const entry = { key, ...payload };
        if (idx >= 0) rec.positions[idx] = entry; else rec.positions.push(entry);

        await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.POSITIONS}`, {
          method:"PUT", headers: headers(), body: JSON.stringify(rec)
        });
      }catch(_){ /* ignorer feil ‚Äì pr√∏v igjen ved neste m√•ling */ }
    }, ()=>{}, { enableHighAccuracy:true, maximumAge:5000, timeout:15000 });
  }

  /* ---------- MAP LAYERS (leses for admin-kart; tegning i Del E) ---------- */
  async function loadMapLayers(){
    try{
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MAPLAYERS}/latest`, { headers: headers() });
      const js = await r.json();
      return js?.record || {layers:[], updated:0};
    }catch(_){ return {layers:[], updated:0}; }
  }

  /* ---------- EXPORTER TIL GLOBALT ---------- */
  window.BroyteSync = { syncPull, syncPush, catalogPull, sendProposal, loadInbox };
  window.BroyteWeather = { refreshWeather };
  window.BroyteWork = { renderWork, renderRegister, renderAdmin, onPhotoChosen,
                        doneHandler, blockHandler, nextHandler, incidentHandler };
  window.BroyteLive = { startLivePosition };
  window.BroyteMap = { loadMapLayers };

})();
</script>
<script>
/* ===== Del E: Kart (Leaflet), tegning av linjer/omr√•der/punkt, lagring til MAPLAYERS, og live-posisjon i Admin ===== */
(() => {
  const CFG = window.BROYTE_CFG;
  const H = window.BroyteHelpers;
  const { $, headers, displayName } = H;

  /* ---------- Dynamisk lasting av Leaflet ---------- */
  function ensureLeaflet(){
    return new Promise((resolve,reject)=>{
      if (window.L && L.map) return resolve();
      const css = document.createElement('link');
      css.rel = 'stylesheet';
      css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      const js  = document.createElement('script');
      js.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      css.onload = ()=>{};
      js.onload  = ()=> resolve();
      js.onerror = reject;
      document.head.appendChild(css);
      document.head.appendChild(js);
    });
  }

  /* ---------- UI: bygg kartkort i Admin ved behov ---------- */
  function ensureAdminMapCard(){
    const host = $('#page-admin');
    if (!host) return null;
    let card = document.getElementById('mapCard');
    if (card) return card;
    card = document.createElement('div');
    card.className = 'card stack';
    card.id = 'mapCard';
    card.innerHTML = `
      <h3>Kart (Admin)</h3>
      <div class="small muted">Se sj√•f√∏rers live-posisjon og tegn linjer/omr√•der/punkt for ruter, sperringer og soner. Lagres i ¬´Maplayers¬ª.</div>
      <div class="row" style="gap:8px;align-items:center">
        <button id="mapBtnReload" class="btn btn-gray">‚ü≥ Last lag</button>
        <button id="mapBtnDrawPt" class="btn btn-blue">‚úèÔ∏è Punkt</button>
        <button id="mapBtnDrawLine" class="btn btn-blue">„Ä∞Ô∏è Linje</button>
        <button id="mapBtnDrawPoly" class="btn btn-blue">‚¨õ Omr√•de</button>
        <button id="mapBtnFinish" class="btn btn-gray">‚úîÔ∏é Fullf√∏r</button>
        <button id="mapBtnCancel" class="btn btn-gray">‚Ü©Ô∏é Avbryt</button>
        <button id="mapBtnDeleteSel" class="btn btn-red">üóëÔ∏è Slett valgt</button>
        <button id="mapBtnSave" class="btn btn-green">üíæ Lagre lag</button>
        <span id="mapStatus" class="small muted">‚Äî</span>
      </div>
      <div id="adminMap" style="width:100%;height:480px;border:1px solid var(--cardBorder);border-radius:12px;overflow:hidden"></div>
      <div class="small muted">Tips: Klikk i kartet for √• legge til punkt. Dobbelklikk for √• fullf√∏re linje/omr√•de, eller bruk ¬´Fullf√∏r¬ª.</div>
    `;
    host.insertBefore(card, host.firstChild);
    return card;
  }

  /* ---------- Lagring/lasting av lag (JSONBin) ---------- */
  async function loadLayers(){
    try{
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MAPLAYERS}/latest`, { headers: headers() });
      const js = await r.json();
      return js?.record || {layers:[], updated:0};
    }catch(_){ return {layers:[], updated:0}; }
  }
  async function saveLayers(record){
    const rec = {
      version: CFG.VERSION,
      updated: Date.now(),
      by: displayName(),
      layers: record.layers || []
    };
    await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MAPLAYERS}`, {
      method:'PUT', headers: headers(), body: JSON.stringify(rec)
    });
    return rec;
  }

  /* ---------- Live-posisjoner ---------- */
  async function fetchPositions(){
    try{
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.POSITIONS}/latest`, { headers: headers() });
      const js = await r.json();
      return js?.record?.positions || [];
    }catch(_){ return []; }
  }

  /* ---------- Tegneverkt√∏y (lettvekts) ---------- */
  function asLatLngArr(coords){ return (coords||[]).map(x=>[x.lat, x.lon]); }
  function toCoords(latlngs){
    return latlngs.map(p=>{
      const o = (Array.isArray(p)? {lat:p[0], lon:p[1]} : {lat:p.lat, lon:p.lng});
      return {lat:o.lat, lon:o.lon};
    });
  }

  function attachMapHandlers(ctx){
    const { map } = ctx;

    map.on('click', (e)=>{
      if (ctx.mode === 'point'){
        const m = L.marker(e.latlng, {draggable:true}).addTo(ctx.layerUser);
        m.bindTooltip('Punkt', {permanent:false});
        m.on('click', ()=> selectShape(ctx, m));
        m.on('dragstart', ()=> selectShape(ctx, m));
        ctx.shapes.push({type:'marker', ref:m});
      }
      if (ctx.mode === 'line'){
        ctx._seed = ctx._seed || [];
        ctx._seed.push(e.latlng);
        if (!ctx._preview){
          ctx._preview = L.polyline(ctx._seed,{color:'#0b66ff'}).addTo(ctx.layerUser);
          ctx._preview.on('click', ()=> selectShape(ctx, ctx._preview));
        }else{
          ctx._preview.setLatLngs(ctx._seed);
        }
      }
      if (ctx.mode === 'poly'){
        ctx._seed = ctx._seed || [];
        ctx._seed.push(e.latlng);
        if (!ctx._preview){
          ctx._preview = L.polygon(ctx._seed,{color:'#7c3aed', fillOpacity:0.2}).addTo(ctx.layerUser);
          ctx._preview.on('click', ()=> selectShape(ctx, ctx._preview));
        }else{
          ctx._preview.setLatLngs(ctx._seed);
        }
      }
    });
    map.on('dblclick', ()=> finishCurrent(ctx));
  }

  function clearPreview(ctx){
    if (ctx._preview){ ctx.layerUser.removeLayer(ctx._preview); ctx._preview=null; }
    ctx._seed = null;
  }

  function setMode(ctx, mode){
    ctx.mode = mode; // 'point' | 'line' | 'poly' | null
    $('#mapStatus').textContent = mode
      ? `Tegnemodus: ${mode==='point'?'Punkt':mode==='line'?'Linje':'Omr√•de'}`
      : '‚Äî';
    clearPreview(ctx);
  }

  function finishCurrent(ctx){
    if (!ctx._seed || !ctx._seed.length) { setMode(ctx, null); return; }
    if (ctx.mode === 'line'){
      const pl = L.polyline(ctx._seed, {color:'#0b66ff'}).addTo(ctx.layerUser);
      pl.on('click', ()=> selectShape(ctx, pl));
      ctx.shapes.push({type:'polyline', ref:pl});
    }
    if (ctx.mode === 'poly'){
      const pg = L.polygon(ctx._seed, {color:'#7c3aed', fillOpacity:0.2}).addTo(ctx.layerUser);
      pg.on('click', ()=> selectShape(ctx, pg));
      ctx.shapes.push({type:'polygon', ref:pg});
    }
    clearPreview(ctx);
    setMode(ctx, null);
  }

  function selectShape(ctx, layer){
    ctx.selected?.setStyle?.({weight:3});
    ctx.selected = layer;
    // fremhev
    if (layer.setStyle){
      layer.setStyle({weight:6});
      setTimeout(()=>{ try{ layer.setStyle({weight:4}); }catch{} }, 150);
    }
  }

  function deleteSelected(ctx){
    if (!ctx.selected) return;
    const i = ctx.shapes.findIndex(s => s.ref === ctx.selected);
    if (i>=0){
      ctx.layerUser.removeLayer(ctx.selected);
      ctx.shapes.splice(i,1);
      ctx.selected = null;
    }
  }

  /* ---------- Import/Export av lag ---------- */
  function loadLayersToMap(ctx, record){
    // t√∏m eksisterende
    ctx.layerDB.clearLayers();
    (record.layers||[]).forEach(l=>{
      if (l.type === 'marker'){
        const m = L.marker([l.coords[0]?.lat, l.coords[0]?.lon]).addTo(ctx.layerDB);
        if (l.name) m.bindTooltip(l.name);
      }
      if (l.type === 'polyline'){
        const pl = L.polyline(asLatLngArr(l.coords), {color: l.color || '#0b66ff'}).addTo(ctx.layerDB);
        if (l.name) pl.bindTooltip(l.name);
      }
      if (l.type === 'polygon'){
        const pg = L.polygon(asLatLngArr(l.coords), {color: l.color || '#7c3aed', fillOpacity:0.2}).addTo(ctx.layerDB);
        if (l.name) pg.bindTooltip(l.name);
      }
    });
  }

  function collectUserShapes(ctx){
    const out = [];
    // 1) Former i ¬´DB¬ª-laget (behold ‚Äì de er fra server)
    // De lagres p√• nytt sammen med brukerlag ‚Äì enklest er √• kombinere:
    // Start med √• lese det som st√•r i layerDB (gjeldende lastet)
    ctx.layerDB.eachLayer(layer=>{
      if (layer instanceof L.Marker){
        const ll = layer.getLatLng();
        out.push({type:'marker', coords:[{lat:ll.lat, lon:ll.lng}], name: layer._tooltip?.getContent?.()||''});
      }else if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)){
        const pts = layer.getLatLngs().map(p=>({lat:p.lat, lon:p.lng}));
        out.push({type:'polyline', coords: pts, color:'#0b66ff', name: layer._tooltip?.getContent?.()||''});
      }else if (layer instanceof L.Polygon){
        const pts = layer.getLatLngs()[0]?.map(p=>({lat:p.lat, lon:p.lng})) || [];
        out.push({type:'polygon', coords: pts, color:'#7c3aed', name: layer._tooltip?.getContent?.()||''});
      }
    });
    // 2) Nye shapes i ¬´User¬ª-laget
    ctx.shapes.forEach(s=>{
      if (s.type==='marker'){
        const ll = s.ref.getLatLng();
        out.push({type:'marker', coords:[{lat:ll.lat, lon:ll.lng}]});
      }
      if (s.type==='polyline'){
        out.push({type:'polyline', coords: toCoords(s.ref.getLatLngs()), color:'#0b66ff'});
      }
      if (s.type==='polygon'){
        out.push({type:'polygon', coords: toCoords(s.ref.getLatLngs()[0]||[]), color:'#7c3aed'});
      }
    });
    return out;
  }

  /* ---------- Live-posisjoner p√• kart ---------- */
  function paintPositions(ctx, arr){
    ctx.layerPos.clearLayers();
    arr.forEach(p=>{
      if (!p?.pos) return;
      const m = L.circleMarker([p.pos.lat, p.pos.lon], {radius:6, weight:2});
      m.addTo(ctx.layerPos);
      const who = (p.actor || p.key || 'Sj√•f√∏r');
      const acc = p.pos.acc? ` (¬±${Math.round(p.pos.acc)} m)`:'';
      m.bindTooltip(`${who}${acc}`, {permanent:false});
    });
  }

  /* ---------- Init Admin Map ---------- */
  async function initAdminMap(){
    const card = ensureAdminMapCard();
    if (!card) return;

    await ensureLeaflet();

    const map = L.map('adminMap', { zoomControl:true, doubleClickZoom:false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // default view: Dal / Romerike
    map.setView([60.268, 11.198], 12);

    const layerDB  = L.layerGroup().addTo(map);   // lagrede lag (fra JSONBin)
    const layerUser= L.layerGroup().addTo(map);   // nye tegninger
    const layerPos = L.layerGroup().addTo(map);   // live-posisjoner
    const ctx = { map, layerDB, layerUser, layerPos, shapes:[], selected:null, mode:null, _seed:null, _preview:null };

    attachMapHandlers(ctx);

    // Knapper
    $('#mapBtnReload').onclick = async ()=>{
      $('#mapStatus').textContent = 'Laster lag ‚Ä¶';
      const rec = await loadLayers();
      loadLayersToMap(ctx, rec);
      $('#mapStatus').textContent = `Lastet ${rec.layers?.length||0} lag.`;
    };
    $('#mapBtnDrawPt').onclick   = ()=> setMode(ctx,'point');
    $('#mapBtnDrawLine').onclick = ()=> setMode(ctx,'line');
    $('#mapBtnDrawPoly').onclick = ()=> setMode(ctx,'poly');
    $('#mapBtnFinish').onclick   = ()=> finishCurrent(ctx);
    $('#mapBtnCancel').onclick   = ()=> { setMode(ctx, null); };
    $('#mapBtnDeleteSel').onclick= ()=> deleteSelected(ctx);
    $('#mapBtnSave').onclick     = async ()=>{
      try{
        $('#mapStatus').textContent = 'Lagrer ‚Ä¶';
        // kombiner eksisterende (layerDB) + nye (layerUser)
        const layers = collectUserShapes(ctx);
        const rec = await saveLayers({layers});
        // etter lagring: flytt nye shapes til DB-laget for ¬´ren¬ª state
        layerUser.clearLayers();
        ctx.shapes = [];
        loadLayersToMap(ctx, rec);
        $('#mapStatus').textContent = `Lagret ${rec.layers.length} elementer ‚úîÔ∏é`;
      }catch(_){
        $('#mapStatus').textContent = 'Feil ved lagring (sjekk n√∏kkel).';
      }
    };

    // F√∏rste last
    $('#mapBtnReload').click();

    // Live-pos oppdatering
    async function refreshPos(){
      const arr = await fetchPositions();
      paintPositions(ctx, arr);
    }
    refreshPos();
    setInterval(refreshPos, 15000);

    // Zoom til posisjon (hvis tillatt)
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>{
        map.setView([p.coords.latitude, p.coords.longitude], 13);
      }, ()=>{}, {enableHighAccuracy:true, timeout:8000, maximumAge:60000});
    }

    // Expose for debugging om √∏nskelig
    window.__BroyteAdminMap = ctx;
  }

  /* ---------- Auto-init n√•r Admin-fanen √•pnes ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    const adminTab = document.querySelector('.tab[data-tab="admin"]');
    if (!adminTab) return;
    adminTab.addEventListener('click', ()=>{
      // init √©n gang
      if (!document.getElementById('adminMap')){
        setTimeout(()=> initAdminMap(), 0);
      }
    });
  });

  // Eksporter
  window.BroyteMapUI = { initAdminMap };

})();
</script>
<script>
/* ===== Del F: Oppstart, PWA-registrering, cache-t√∏mming, heartbeat og init ===== */
(() => {
  const CFG = window.BROYTE_CFG;
  const H   = window.BroyteHelpers;
  const SY  = window.BroyteSync;
  const WV  = window.BroyteWeather;
  const WK  = window.BroyteWork;
  const LV  = window.BroyteLive;
  const MP  = window.BroyteMapUI;
  const { $, save, bootDefaults, applyTheme, touchActivity } = H;

  /* ---------- PWA-registrering ---------- */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    });
  }

  /* ---------- T√∏m cache og reload ---------- */
  async function hardReset(){
    if(!confirm('T√∏mme all lokal data og laste siden p√• nytt?')) return;
    try{
      localStorage.clear();
      if ('caches' in window){
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }
    }catch(_){}
    location.reload(true);
  }

  /* ---------- Heartbeat (synk + posisjon) ---------- */
  function startHeartbeat(){
    setInterval(async ()=>{
      try { await SY.syncPush(); } catch(_){}
    }, CFG.HEARTBEAT_MS);
    // start samtidig live-posisjon
    LV.startLivePosition();
  }

  /* ---------- Init ved DOMContentLoaded ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      // Eventer for knapper som ikke var bundet tidligere
      const hardBtn = $('btnHardReset');
      if (hardBtn) hardBtn.onclick = hardReset;

      // Boot defaults + tema
      bootDefaults();
      applyTheme(state.theme || 'auto');

      // Init geolokasjon-footer
      H.initGeolocation();

      // Start v√¶r-henting
      WV.refreshWeather();

      // Start heartbeat
      startHeartbeat();

      // Oppdater status-tekst
      const footerVer = document.querySelector('.footer div:last-child');
      if (footerVer) footerVer.textContent = `v${CFG.VERSION} ‚Äì Romerike Trefelling`;

      console.log('%cBr√∏yterute v' + CFG.VERSION + ' klar', 'color:lime');
    }catch(err){
      console.error('Init-feil:', err);
      alert('Feil under oppstart: ' + err.message);
    }
  });
})();
</script>
</body>
</html>