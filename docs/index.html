<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Br√∏yterute v9.12h ‚Äì Hybrid</title>
  <style>
    :root { --b:#e5e7eb; --m:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fff; color:#111; }
    header.app { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--b); padding:12px 16px; z-index:5;}
    h1 { margin: 0; font-size: 20px; }
    nav.tabs { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    nav.tabs button { padding:8px 12px; border:1px solid var(--b); background:#f8fafc; border-radius:10px; }
    nav.tabs button.active { background:#eef2ff; border-color:#c7d2fe; }
    main { padding:16px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid var(--b); border-radius: 10px; padding: 10px; margin: 8px 0; background:#fff; }
    .card header { display: flex; justify-content:space-between; align-items:center; font-weight: 600; }
    .muted { color: var(--m); font-size: 12px; }
    button { padding: 8px 10px; border: 1px solid var(--b); border-radius: 8px; background: #f6f6f6; }
    button:active { transform: scale(0.98); }
    select, input[type="text"], input[type="number"], textarea { padding: 8px; border: 1px solid var(--b); border-radius: 8px; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 999px; background:#f1f1f1; border:1px solid #e3e3e3; }
    .stack { display: grid; gap: 6px; }
    .toolbar { display:flex; gap:8px; flex-wrap: wrap; margin: 8px 0; }
    .right { display:flex; align-items:center; gap:6px; }
    .grow { flex:1; min-width:160px; }
    .ok { color:#0a7c2f; }
    .err { color:#b00020; }
    .grid { display:grid; gap:8px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width:720px){ .grid.cols-2 { grid-template-columns: 1fr; } }
    .hidden{ display:none !important; }
    footer.app { padding:12px 16px; border-top:1px solid var(--b); color:var(--m); font-size:12px;}
    .badge { font-size:11px; border:1px solid var(--b); border-radius:999px; padding:2px 6px; background:#fafafa; }
  </style>

  <!-- Konfig -->
  <script>
    window.APP_CFG = {
      API_BASE: 'https://jsonbin-proxy.oysgjer.workers.dev/jsonbin/',
      BIN_ID:   '68e7b4d2ae596e708f0bde7d',
      APP_VER:  '9.12h ‚Äì Romerike Trefelling'
    };

    /************ Sesong (br√∏ytestikker tas kun √©n gang pr sesong) ************/
    const LS_SEASON = 'broyt_v912h_season';
    function defaultSeason() {
      const now = new Date();
      const y = now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear()-1; // sesong starter aug
      return `${y}-${String((y+1)).slice(2)}`; // 2025-26
    }
    let CURRENT_SEASON = localStorage.getItem(LS_SEASON) || defaultSeason();
    localStorage.setItem(LS_SEASON, CURRENT_SEASON);
  </script>
</head>
<body>
  <header class="app">
    <h1>Br√∏yterute v9.12h</h1>
    <nav class="tabs">
      <button data-tab="home" class="active">Hjem</button>
      <button data-tab="work">Under arbeid</button>
      <button data-tab="register">Adresse-register</button>
      <button data-tab="admin">Admin</button>
      <button data-tab="service">Service/Vedlikehold</button>
    </nav>
  </header>

  <main>
    <!-- HJEM -->
    <section id="tab-home">
      <section class="card">
        <div class="row">
          <label for="driverName">F√∏rer-navn:</label>
          <input id="driverName" type="text" placeholder="√òystein" class="grow">
        </div>
        <div class="row" style="margin-top:8px">
          <label for="direction">Retning:</label>
          <select id="direction">
            <option>Standard</option>
            <option>Mot klokka</option>
            <option>Med klokka</option>
          </select>
          <span class="pill">Runde: <span id="roundNo">1</span></span>
          <span class="pill">Versjon: <span id="appVer">‚Äî</span></span>
          <span class="pill">Sesong: <span id="seasonLbl">‚Äî</span></span>
          <span class="pill">Synk: <span id="syncLabel">‚Äî</span></span>
        </div>
        <div class="row" style="margin-top:8px">
          <span>Utstyr:</span>
          <label><input type="checkbox" id="eq_plow"> Br√∏yteskj√¶r</label>
          <label><input type="checkbox" id="eq_fres"> Fres</label>
          <label><input type="checkbox" id="eq_sand"> Str√∏/sand</label>
        </div>
        <div class="toolbar">
          <button id="btnSync">‚ü≥ Hent (synk fra sky)</button>
          <button id="btnSave">üíæ Lagre til sky</button>
          <button id="btnStartRunde">üèÅ Start ny runde</button>
          <span id="syncStatus" class="muted"></span>
        </div>
      </section>

      <section class="stack">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <strong>Adresse-liste</strong>
          <div class="right muted">
            <span id="addrCount">0 adresser</span>
          </div>
        </div>
        <div id="addrList"></div>
      </section>
    </section>

    <!-- UNDER ARBEID -->
    <section id="tab-work" class="hidden">
      <section class="card">
        <div class="row">
          <strong>Under arbeid</strong>
          <span class="pill">√Öpne: <span id="uaOpen">0</span></span>
          <span class="pill">Ferdige: <span id="uaDone">0</span></span>
        </div>
        <div class="toolbar">
          <button id="uaShowOpen">Vis kun √•pne</button>
          <button id="uaShowAll">Vis alle</button>
          <button id="uaMarkAllDone">Marker alt som ferdig</button>
        </div>
      </section>
      <div id="uaList"></div>
    </section>

    <!-- ADRESSE-REGISTER -->
    <section id="tab-register" class="hidden">
      <section class="card">
        <strong>Adresse-register</strong>
        <div class="grid cols-2" style="margin-top:8px">
          <input id="arName" placeholder="Adressetekst (navn)"/>
          <input id="arGroup" placeholder="Gruppe (valgfritt)"/>
          <!-- Task er alltid Sn√∏, ikke redigerbar -->
          <input id="arTaskFixed" value="Sn√∏" disabled />
          <input id="arEquip" placeholder="Utstyr komma-separert (fres, stro)"/>
        </div>
        <div class="toolbar">
          <button id="arAdd">‚ûï Legg til</button>
          <button id="arClearDone">Fjern ferdige</button>
          <button id="arSortAlpha">Sorter A‚Äì√Ö</button>
        </div>
      </section>
      <div id="arList"></div>
    </section>

    <!-- ADMIN -->
    <section id="tab-admin" class="hidden">
      <section class="card">
        <strong>Admin</strong>
        <div class="grid" style="margin-top:8px">
          <div class="row">
            <button id="adExportJson">‚¨áÔ∏è Last ned JSON</button>
            <button id="adImportJson">‚¨ÜÔ∏è Importer JSON</button>
            <input id="adFile" type="file" accept="application/json" class="hidden">
          </div>
          <div class="row">
            <button id="adBackup">üóÇ Lag snapshot (lokal)</button>
            <button id="adRestore">‚Ü©Ô∏è Gjenopprett snapshot</button>
          </div>
          <div class="row">
            <button id="adPublish">üöÄ Publiser til sky (PUT)</button>
            <span id="adStatus" class="muted"></span>
          </div>
        </div>
      </section>
      <section class="card">
        <strong>Meta</strong>
        <div class="grid" style="margin-top:8px">
          <div class="muted">Version: <span id="adVer">‚Äî</span></div>
          <div class="muted">Oppdatert: <span id="adUpdated">‚Äî</span></div>
          <div class="muted">Antall adresser: <span id="adCount">0</span></div>
        </div>
      </section>
    </section>

    <!-- SERVICE / VEDLIKEHOLD -->
    <section id="tab-service" class="hidden">
      <section class="card">
        <strong>Service / Vedlikehold</strong>
        <div class="grid" style="margin-top:8px">
          <button id="svExportZip">üì¶ Eksporter logg + bilder (ZIP) ‚Äì kommer straks</button>
          <button id="svNewSeason">Start ny sesong (nullstill br√∏ytestikker)</button>
          <textarea id="svNotes" rows="4" placeholder="Service-notater for denne runden‚Ä¶"></textarea>
          <div class="row">
            <button id="svClearLocal">T√∏m lokal lagring</button>
            <button id="svDownloadLog">Last ned logg (JSON)</button>
          </div>
        </div>
      </section>
      <div id="svMsg" class="muted"></div>
    </section>
  </main>

  <footer class="app">v9.12h ‚Äì Romerike Trefelling</footer>

  <script>
    /************ Tabs ************/
    const tabs = document.querySelectorAll('nav.tabs button');
    const sections = {
      home: document.getElementById('tab-home'),
      work: document.getElementById('tab-work'),
      register: document.getElementById('tab-register'),
      admin: document.getElementById('tab-admin'),
      service: document.getElementById('tab-service')
    };
    function showTab(id){
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
      Object.entries(sections).forEach(([k,el])=> el.classList.toggle('hidden', k!==id));
      if(id==='work') renderUnderArbeid();
      if(id==='register') renderRegister();
      if(id==='admin') renderAdminMeta();
    }
    tabs.forEach(b=>b.addEventListener('click', ()=> showTab(b.dataset.tab)));

    /************ Data Access (JSONBin via Worker) ************/
    const addressStore = (() => {
      const { API_BASE, BIN_ID } = window.APP_CFG;

      async function getLatest() {
        const r = await fetch(`${API_BASE}b/${BIN_ID}/latest`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`GET ${r.status}`);
        const data = await r.json();
        return data && data.record ? data.record : data;
      }

      async function put(payload) {
        const r = await fetch(`${API_BASE}b/${BIN_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(`PUT ${r.status}`);
        const data = await r.json();
        return data && data.record ? data.record : data;
      }

      return { getLatest, put };
    })();

    /************ App State ************/
    const UI = {
      // home
      list: document.getElementById('addrList'),
      status: document.getElementById('syncStatus'),
      driverName: document.getElementById('driverName'),
      direction: document.getElementById('direction'),
      eq: {
        plow: document.getElementById('eq_plow'),
        fres: document.getElementById('eq_fres'),
        sand: document.getElementById('eq_sand')
      },
      syncBtn: document.getElementById('btnSync'),
      saveBtn: document.getElementById('btnSave'),
      startBtn: document.getElementById('btnStartRunde'),
      roundNo: document.getElementById('roundNo'),
      appVer: document.getElementById('appVer'),
      addrCount: document.getElementById('addrCount'),
      syncLabel: document.getElementById('syncLabel'),
      seasonLbl: document.getElementById('seasonLbl'),
      // under arbeid
      uaList: document.getElementById('uaList'),
      uaOpen: document.getElementById('uaOpen'),
      uaDone: document.getElementById('uaDone'),
      uaShowOpen: document.getElementById('uaShowOpen'),
      uaShowAll: document.getElementById('uaShowAll'),
      uaMarkAllDone: document.getElementById('uaMarkAllDone'),
      // register
      arList: document.getElementById('arList'),
      arName: document.getElementById('arName'),
      arGroup: document.getElementById('arGroup'),
      arEquip: document.getElementById('arEquip'),
      arAdd: document.getElementById('arAdd'),
      arClearDone: document.getElementById('arClearDone'),
      arSortAlpha: document.getElementById('arSortAlpha'),
      // admin
      adExportJson: document.getElementById('adExportJson'),
      adImportJson: document.getElementById('adImportJson'),
      adFile: document.getElementById('adFile'),
      adBackup: document.getElementById('adBackup'),
      adRestore: document.getElementById('adRestore'),
      adPublish: document.getElementById('adPublish'),
      adStatus: document.getElementById('adStatus'),
      adVer: document.getElementById('adVer'),
      adUpdated: document.getElementById('adUpdated'),
      adCount: document.getElementById('adCount'),
      // service
      svExportZip: document.getElementById('svExportZip'),
      svNewSeason: document.getElementById('svNewSeason'),
      svNotes: document.getElementById('svNotes'),
      svClearLocal: document.getElementById('svClearLocal'),
      svDownloadLog: document.getElementById('svDownloadLog'),
      svMsg: document.getElementById('svMsg')
    };

    // Task er fast "Sn√∏" i hele appen
    const TASKS = ['Sn√∏'];

    let appState = {
      version: window.APP_CFG.APP_VER,
      round: 1,
      updated: Date.now(),
      by: '',
      driver: {
        name: '',
        direction: 'Standard',
        equipment: { plow:false, fres:false, sand:false }
      },
      // felter per adresse:
      // done (runde), grusDone (runde), stikkerSeason {season, done, doneAt}
      addresses: []
    };

    /************ LocalStorage helpers ************/
    const LS_PREF = 'broyt_v912h_prefs';
    const LS_SNAP = 'broyt_v912h_snapshot';
    function loadPrefs() {
      try {
        const raw = localStorage.getItem(LS_PREF);
        if (!raw) return;
        const p = JSON.parse(raw);
        if (p?.driver?.name) UI.driverName.value = p.driver.name;
        if (p?.driver?.direction) UI.direction.value = p.driver.direction;
        if (p?.driver?.equipment) {
          UI.eq.plow.checked = !!p.driver.equipment.plow;
          UI.eq.fres.checked = !!p.driver.equipment.fres;
          UI.eq.sand.checked = !!p.driver.equipment.sand;
        }
      } catch {}
    }
    function savePrefs() {
      const prefs = { driver: currentDriver() };
      localStorage.setItem(LS_PREF, JSON.stringify(prefs));
    }

    function currentDriver() {
      return {
        name: UI.driverName.value.trim(),
        direction: UI.direction.value,
        equipment: {
          plow: !!UI.eq.plow.checked,
          fres: !!UI.eq.fres.checked,
          sand: !!UI.eq.sand.checked
        }
      };
    }

    /************ Rendering ‚Äì Hjem ************/
    function renderMeta() {
      UI.roundNo.textContent = appState.round;
      UI.appVer.textContent = appState.version;
      UI.addrCount.textContent = `${appState.addresses.length} adresser`;
      UI.seasonLbl.textContent = CURRENT_SEASON;
    }

    function renderList() {
      UI.list.innerHTML = '';
      appState.addresses.forEach((a, idx) => {
        // init standardfelter hvis mangler
        if (!a.stikkerSeason) a.stikkerSeason = { season: CURRENT_SEASON, done: false, doneAt: null };
        if (a.stikkerSeason.season !== CURRENT_SEASON) {
          a.stikkerSeason = { season: CURRENT_SEASON, done: false, doneAt: null };
        }
        if (typeof a.grusDone !== 'boolean') a.grusDone = false;
        if (typeof a.done !== 'boolean') a.done = false;

        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.idx = idx;

        const done = a.done ? 'checked' : '';
        const grus = a.grusDone ? 'checked' : '';
        const stikkerDone = a.stikkerSeason.done ? 'checked' : '';
        const stikkerInfo = a.stikkerSeason.doneAt
          ? ` | Stikker satt: ${new Date(a.stikkerSeason.doneAt).toLocaleDateString()}`
          : '';

        const eqStr = Array.isArray(a.equipment) && a.equipment.length
          ? ` | Utstyr: ${a.equipment.join(', ')}`
          : '';

        card.innerHTML = `
          <header>
            <div>${a.name || 'Uten navn'}</div>
            <div class="right">
              <span class="badge">Sn√∏</span>
              <label class="muted"><input type="checkbox" data-k="done" ${done}> Ferdig (runde)</label>
            </div>
          </header>
          <div class="muted" style="margin-top:4px">Gruppe: ${a.group || '-'}${eqStr}${stikkerInfo}</div>
          <div class="row" style="margin-top:8px">
            <button data-k="up">‚Üë</button>
            <button data-k="down">‚Üì</button>
            <button data-k="top">‚á§ Topp</button>
          </div>
          <div class="row" style="margin-top:8px">
            <label class="muted"><input type="checkbox" data-k="grus" ${grus}> Grus utf√∏rt (runde)</label>
          </div>
          <div class="row" style="margin-top:8px">
            <label class="muted"><input type="checkbox" data-k="stikker" ${stikkerDone}> Br√∏ytestikker satt (sesong ${CURRENT_SEASON})</label>
          </div>
        `;
        UI.list.appendChild(card);
      });
      renderMeta();
    }

    /************ Rendering ‚Äì Under arbeid ************/
    let uaFilterOpenOnly = true;
    function renderUnderArbeid(){
      const src = uaFilterOpenOnly ? appState.addresses.filter(a=>!a.done) : appState.addresses;
      UI.uaList.innerHTML = '';
      src.forEach((a)=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <header>
            <div>${a.name}</div>
            <div class="right"><span class="badge">Sn√∏</span></div>
          </header>
          <div class="muted" style="margin-top:4px">
            Gruppe: ${a.group || '-'} | Utstyr: ${(a.equipment||[]).join(', ') || '-'}
            ${a.grusDone ? ' | Grus utf√∏rt ‚úÖ' : ''}
            ${a.stikkerSeason?.done ? ` | Stikker ‚úÖ (${new Date(a.stikkerSeason.doneAt).toLocaleDateString()})` : ''}
          </div>
        `;
        UI.uaList.appendChild(div);
      });
      const doneCount = appState.addresses.filter(a=>a.done).length;
      UI.uaOpen.textContent = appState.addresses.length - doneCount;
      UI.uaDone.textContent = doneCount;
    }

    /************ Rendering ‚Äì Register ************/
    function renderRegister(){
      UI.arList.innerHTML = '';
      appState.addresses.forEach((a, i)=>{
        const row = document.createElement('div');
        row.className = 'card';
        row.innerHTML = `
          <header>
            <div>${a.name}</div>
            <div class="right">
              <span class="badge">Sn√∏</span>
              <button data-k="del" data-i="${i}">üóë</button>
            </div>
          </header>
          <div class="grid cols-2" style="margin-top:8px">
            <input data-k="name" data-i="${i}" value="${a.name}">
            <input data-k="group" data-i="${i}" value="${a.group || ''}" placeholder="Gruppe">
            <input data-k="equipment" data-i="${i}" value="${(a.equipment||[]).join(', ')}" placeholder="fres, stro">
            <div class="muted">Task: Sn√∏ (fast)</div>
          </div>
        `;
        UI.arList.appendChild(row);
      });
    }

    /************ Reorder helpers ************/
    function swap(i, j) {
      if (i<0 || j<0 || i>=appState.addresses.length || j>=appState.addresses.length) return;
      const tmp = appState.addresses[i];
      appState.addresses[i] = appState.addresses[j];
      appState.addresses[j] = tmp;
    }

    /************ Events ‚Äì Hjem ************/
    UI.list.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const card = e.target.closest('.card');
      const idx = Number(card.dataset.idx);

      if (btn.dataset.k === 'up') { swap(idx, idx-1); renderList(); }
      if (btn.dataset.k === 'down') { swap(idx, idx+1); renderList(); }
      if (btn.dataset.k === 'top') {
        const [item] = appState.addresses.splice(idx,1);
        appState.addresses.unshift(item);
        renderList();
      }
    });

    UI.list.addEventListener('change', (e) => {
      const card = e.target.closest('.card'); if (!card) return;
      const idx = Number(card.dataset.idx);
      const k = e.target.dataset.k;

      if (k === 'done') appState.addresses[idx].done = !!e.target.checked;
      if (k === 'grus') appState.addresses[idx].grusDone = !!e.target.checked;
      if (k === 'stikker') {
        const now = Date.now();
        appState.addresses[idx].stikkerSeason = appState.addresses[idx].stikkerSeason || { season: CURRENT_SEASON, done:false, doneAt:null };
        appState.addresses[idx].stikkerSeason.season = CURRENT_SEASON;
        appState.addresses[idx].stikkerSeason.done = !!e.target.checked;
        appState.addresses[idx].stikkerSeason.doneAt = e.target.checked ? now : null;
      }
    });

    document.getElementById('driverName').addEventListener('input', savePrefs);
    document.getElementById('direction').addEventListener('change', savePrefs);
    document.getElementById('eq_plow').addEventListener('change', savePrefs);
    document.getElementById('eq_fres').addEventListener('change', savePrefs);
    document.getElementById('eq_sand').addEventListener('change', savePrefs);

    document.getElementById('btnSync').addEventListener('click', async () => { await syncFromCloud(); });
    document.getElementById('btnSave').addEventListener('click', async () => { await saveToCloud(); });
    document.getElementById('btnStartRunde').addEventListener('click', () => {
      appState.addresses = appState.addresses.map(a => ({ ...a, done:false, grusDone:false }));
      appState.round = (appState.round || 0) + 1;
      appState.updated = Date.now();
      renderList();
      toast('Ny runde: ferdig + grus nullstilt. Stikker beholdt.', true);
    });

    /************ Events ‚Äì Under arbeid ************/
    document.getElementById('uaShowOpen').addEventListener('click', ()=>{ uaFilterOpenOnly = true; renderUnderArbeid(); });
    document.getElementById('uaShowAll').addEventListener('click', ()=>{ uaFilterOpenOnly = false; renderUnderArbeid(); });
    document.getElementById('uaMarkAllDone').addEventListener('click', ()=>{
      appState.addresses.forEach(a=> a.done = true);
      renderUnderArbeid(); renderList();
    });

    /************ Events ‚Äì Register ************/
    document.getElementById('arAdd').addEventListener('click', ()=>{
      const name = UI.arName.value.trim();
      if(!name) return;
      const group = UI.arGroup.value.trim();
      const equipment = UI.arEquip.value.split(',').map(s=>s.trim()).filter(Boolean);
      appState.addresses.push({ name, group, task:'Sn√∏', equipment, done:false, grusDone:false, active:true });
      UI.arName.value=''; UI.arGroup.value=''; UI.arEquip.value='';
      renderRegister(); renderList();
    });

    document.getElementById('arClearDone').addEventListener('click', ()=>{
      appState.addresses = appState.addresses.filter(a=>!a.done);
      renderRegister(); renderList();
    });

    document.getElementById('arSortAlpha').addEventListener('click', ()=>{
      appState.addresses.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      renderRegister(); renderList();
    });

    document.getElementById('arList').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(btn.dataset.k==='del'){
        const i = +btn.dataset.i;
        appState.addresses.splice(i,1);
        renderRegister(); renderList();
      }
    });

    document.getElementById('arList').addEventListener('input', (e)=>{
      const k = e.target.dataset.k; const i = +e.target.dataset.i; if(k==null) return;
      if(k==='name') appState.addresses[i].name = e.target.value;
      if(k==='group') appState.addresses[i].group = e.target.value;
      if(k==='equipment') appState.addresses[i].equipment = e.target.value.split(',').map(s=>s.trim()).filter(Boolean);
    });

    /************ Events ‚Äì Admin ************/
    document.getElementById('adExportJson').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(appState,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `broeyting_snapshot_runde${appState.round}.json`;
      a.click();
    });
    document.getElementById('adImportJson').addEventListener('click', ()=> document.getElementById('adFile').click());
    document.getElementById('adFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const txt = await f.text();
      try {
        const obj = JSON.parse(txt);
        if(Array.isArray(obj)) { appState.addresses = obj; }
        else if (Array.isArray(obj.addresses)) { appState = { ...appState, ...obj, addresses: obj.addresses }; }
        renderList(); renderRegister(); renderAdminMeta();
        document.getElementById('adStatus').textContent = 'Importert.';
      } catch { document.getElementById('adStatus').textContent = 'Feil i JSON.'; }
    });
    document.getElementById('adBackup').addEventListener('click', ()=>{
      localStorage.setItem(LS_SNAP, JSON.stringify(appState));
      document.getElementById('adStatus').textContent = 'Snapshot lagret lokalt.';
    });
    document.getElementById('adRestore').addEventListener('click', ()=>{
      const raw = localStorage.getItem(LS_SNAP);
      if(!raw) { document.getElementById('adStatus').textContent = 'Ingen snapshot funnet.'; return; }
      try {
        const snap = JSON.parse(raw);
        appState = { ...appState, ...snap };
        renderList(); renderRegister(); renderAdminMeta();
        document.getElementById('adStatus').textContent = 'Snapshot gjenopprettet.';
      } catch { document.getElementById('adStatus').textContent = 'Kunne ikke lese snapshot.'; }
    });
    document.getElementById('adPublish').addEventListener('click', async ()=>{
      try{
        document.getElementById('adStatus').textContent = 'Publiserer...';
        await saveToCloud();
        document.getElementById('adStatus').textContent = 'Publisert til sky.';
      }catch(e){ document.getElementById('adStatus').textContent = 'Publisering feilet.'; }
    });

    function renderAdminMeta(){
      document.getElementById('adVer').textContent = appState.version;
      document.getElementById('adUpdated').textContent = new Date(appState.updated).toLocaleString();
      document.getElementById('adCount').textContent = appState.addresses.length;
    }

    /************ Events ‚Äì Service ************/
    document.getElementById('svNewSeason').addEventListener('click', ()=>{
      // Neste sesong
      const parts = CURRENT_SEASON.split('-'); // "2025-26"
      const startYear = parseInt(parts[0],10) + 1;
      const next = `${startYear}-${String(startYear+1).slice(2)}`;
      CURRENT_SEASON = next;
      localStorage.setItem(LS_SEASON, CURRENT_SEASON);

      // Nullstill kun br√∏ytestikker
      appState.addresses = appState.addresses.map(a => ({
        ...a,
        stikkerSeason: { season: CURRENT_SEASON, done:false, doneAt:null }
      }));
      appState.updated = Date.now();
      renderList(); renderUnderArbeid(); renderRegister(); renderAdminMeta();
      document.getElementById('svMsg').textContent = `Ny sesong startet: ${CURRENT_SEASON}. Br√∏ytestikker nullstilt.`;
    });

    document.getElementById('svClearLocal').addEventListener('click', ()=>{
      localStorage.removeItem(LS_PREF);
      localStorage.removeItem(LS_SNAP);
      document.getElementById('svMsg').textContent = 'Lokal lagring t√∏mt.';
    });
    document.getElementById('svDownloadLog').addEventListener('click', ()=>{
      const log = {
        round: appState.round,
        updated: appState.updated,
        season: CURRENT_SEASON,
        driver: appState.driver,
        notes: document.getElementById('svNotes').value,
        done: appState.addresses.filter(a=>a.done).map(a=>a.name),
        grus: appState.addresses.filter(a=>a.grusDone).map(a=>a.name),
        stikker: appState.addresses.filter(a=>a.stikkerSeason?.done).map(a=>a.name),
        open: appState.addresses.filter(a=>!a.done).map(a=>a.name)
      };
      const blob = new Blob([JSON.stringify(log,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `broeyting_logg_runde${appState.round}_${CURRENT_SEASON}.json`;
      a.click();
    });

    /************ Sync / Save ************/
    function toast(msg, ok=false) {
      UI.status.textContent = msg;
      UI.status.className = `muted ${ok ? 'ok':'err'}`;
      UI.syncLabel.textContent = ok ? 'OK' : 'Feil';
      setTimeout(()=>{ UI.status.textContent=''; UI.status.className='muted'; }, 4000);
    }

    async function syncFromCloud() {
      try {
        UI.status.textContent = 'Henter...';
        const cloud = await addressStore.getLatest();

        // St√∏tt tre formater: ren array, {addresses}, {snapshot:{addresses}}
        const addresses =
          Array.isArray(cloud) ? cloud :
          Array.isArray(cloud.addresses) ? cloud.addresses :
          (cloud.snapshot && Array.isArray(cloud.snapshot.addresses)) ? cloud.snapshot.addresses :
          [];

        const active = addresses.filter(a => (a.active === undefined ? true : !!a.active));

        appState.addresses = active.map(a => {
          // mappe legacy "task" som kan inneholde "grus" / "br√∏ytestikker" til nye felt
          const rawTask = (a.task || '').toLowerCase();
          const hasGrus = rawTask.includes('grus');
          const hadStikkerWord = rawTask.includes('br√∏ytestikker');

          const stikkerSeason = a.stikkerSeason && a.stikkerSeason.season === CURRENT_SEASON
            ? a.stikkerSeason
            : { season: CURRENT_SEASON, done:false, doneAt:null };

          return {
            name: a.name || 'Uten navn',
            group: a.group || '',
            equipment: a.equipment || [],
            active: a.active !== false,
            // runde-felter:
            done: !!a.done,
            grusDone: typeof a.grusDone === 'boolean' ? a.grusDone : false,
            // sesong-felt:
            stikkerSeason: stikkerSeason,
            // fast task:
            task: 'Sn√∏',
            // hint hvis legacy indikerte behov ‚Äì (vi setter IKKE som gjort)
            _legacyNeedsGrus: hasGrus,
            _legacyHadStikkerWord: hadStikkerWord
          };
        });

        appState.version = cloud.version || (cloud.snapshot && cloud.snapshot.version) || window.APP_CFG.APP_VER;
        appState.updated = Date.now();

        renderList(); renderUnderArbeid(); renderRegister(); renderAdminMeta();
        toast('Synk OK', true);
      } catch (e) {
        console.error(e);
        toast(`Synk feilet: ${e.message}`);
      }
    }

    async function saveToCloud() {
      UI.status.textContent = 'Lagrer...';
      appState.by = (UI.driverName.value.trim() || 'driver1');
      appState.driver = currentDriver();
      appState.updated = Date.now();

      const payload = {
        version: appState.version,
        round: appState.round,
        updated: appState.updated,
        by: appState.by,
        driver: appState.driver,
        season: CURRENT_SEASON,
        addresses: appState.addresses
      };
      await addressStore.put(payload);
      toast('Lagret til sky', true);
      renderAdminMeta();
    }

    /************ Boot ************/
    (async function init(){
      document.getElementById('seasonLbl').textContent = CURRENT_SEASON;
      loadPrefs();
      renderMeta();
      showTab('home');
      await syncFromCloud(); // hent ved start
    })();
  </script>
</body>
</html>