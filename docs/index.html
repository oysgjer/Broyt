<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BrÃ¸yterute â€“ Romerike Trefelling</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0a0f1c">
<link rel="apple-touch-icon" href="./icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- CSS -->
<link rel="stylesheet" href="./del-B.css">

<!-- JS-deler -->
<script defer src="./del-A.js"></script>  <!-- JSONBIN helpers + nÃ¸kkel-sjekk -->
<script defer src="./del-E.js"></script>  <!-- Admin (redigering + flytt opp/ned + lagre) -->

<style>
/* ramme rundt appen (navigasjon/top) */
body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0a0f1c; color:#e6edf3; }
nav { display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:10px; border-bottom:1px solid #2b3445; background:#0a0f1c; position:sticky; top:0; z-index:5; }
nav button { border-radius:10px; padding:8px 14px; font-size:16px; border:1px solid #3b465a; background:#182233; color:#f0f4f8; }
nav button.active { background:#1e3a8a; border-color:#60a5fa; }
main { max-width: 900px; margin: auto; padding: 12px; }
.card { background:#0b1220; border:1px solid #2b3445; border-radius:14px; padding:16px; margin:12px 0; }

@media (prefers-color-scheme: light){
  body{ background:#fafafa; color:#111; }
  nav{ background:#fff; border-bottom-color:#e5e7eb; }
  nav button{ background:#e9eef6; color:#111; border-color:#cfd8e3; }
  nav button.active{ background:#007aff; border-color:#007aff; color:#fff; }
  .card{ background:#fff; border-color:#e5e7eb; }
}

.install-hint{ display:none; background:#1d4ed8; color:#fff; text-align:center; padding:10px; border-radius:10px; margin-top:12px; font-size:15px; }
</style>
</head>

<body>
<nav>
  <button id="nav-home"  onclick="showPage('home')">Hjem</button>
  <button id="nav-work"  onclick="showPage('work')">Under arbeid</button>
  <button id="nav-service" onclick="showPage('service')">Service</button>
  <button id="nav-status" onclick="showPage('status')">Status</button>
  <button id="nav-admin"  onclick="showPage('admin')">Admin</button>
  <span style="margin-left:auto;font-size:12px;opacity:.7">v9.12i</span>
</nav>

<main>
  <!-- HJEM -->
  <section id="home" class="card">
    <h2 class="title">Hjem</h2>
    <p>Sett fÃ¸rer, retning og utstyr. Start runde nÃ¥r du er klar.</p>

    <label>FÃ¸rer:<br>
      <input id="a_driver" placeholder="Navn" style="width:100%">
    </label><br><br>

    <label>Retning rute:<br>
      <select id="a_dir" style="width:100%">
        <option value="Normal">Normal</option>
        <option value="Motsatt">Motsatt</option>
      </select>
    </label><br><br>

    <fieldset class="card" style="margin:0">
      <legend>Utstyr</legend>
      <label><input type="checkbox" id="a_eq_plow"> BrÃ¸yteskjÃ¦r</label><br>
      <label><input type="checkbox" id="a_eq_fres"> Fres</label><br>
      <label><input type="checkbox" id="a_eq_sand"> StrÃ¸/sand</label>
    </fieldset><br>

    <button id="a_start" class="btn btn-lg">ğŸ Start runde</button>
    <div id="installPrompt" class="install-hint">ğŸ“² Installer BrÃ¸yterute pÃ¥ Hjem-skjerm</div>
  </section>

  <!-- UNDER ARBEID -->
  <section id="work" class="card" style="display:none">
    <h2 class="title">Under arbeid</h2>

    <div class="progress-all">
      <div id="b_prog_me" class="bar bar-me" style="width:0%"></div>
      <div id="b_prog_other" class="bar bar-other" style="width:0%"></div>
    </div>

    <!-- NÃ¥/Neste â€“ bredt kort for NÃ¥ -->
    <div class="now-stack">
      <div class="now now-wide">
        <div class="now-head"><span class="now-icon">ğŸšœ</span><span class="lbl">NÃ¥</span></div>
        <div id="b_now" class="val now-val">â€“</div>
      </div>
      <div class="next now-wide">
        <div class="next-head"><span class="next-icon">â¡ï¸</span><span class="lbl">Neste</span></div>
        <div id="b_next" class="val next-val">â€“</div>
      </div>
    </div>

    <!-- Handlinger -->
    <div class="actions-grid">
      <button id="act_start" class="btn btn-lg" type="button">â–¶ï¸ Start</button>
      <button id="act_skip"  class="btn btn-lg" type="button">â­ï¸ Hopp over</button>
      <button id="act_block" class="btn btn-lg btn-warn" type="button">ğŸš« Ikke mulig</button>
      <button id="act_done"  class="btn btn-lg btn-affirm" type="button">âœ… Ferdig</button>
      <button id="act_acc"   class="btn btn-lg btn-ghost" type="button">âš ï¸ Uhell</button>
    </div>

    <p id="b_status" class="status muted">Ikke pÃ¥begynt</p>

    <!-- Kontrollpanel nederst -->
    <div id="work-controls" class="card" style="margin-top:14px">
      <div class="pills" style="margin-bottom:10px">
        <span class="pill">Runde: <strong id="b_round">â€“</strong></span>
        <span class="pill">Oppdrag: <strong id="b_job">â€“</strong></span>
        <span class="pill">Retning: <strong id="b_dir">â€“</strong></span>
        <span class="pill">Sesong: <strong id="b_season">â€“</strong></span>
        <span class="pill">Synk: <strong id="b_sync">â€”</strong></span>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <button id="b_nav_top"    class="btn btn-primary btn-lg" type="button">ğŸ§­ NAVIGER</button>
        <button id="b_sync_btn"   class="btn btn-lg" type="button">â†» Synk</button>
        <button id="b_save_btn"   class="btn btn-lg" type="button">ğŸ’¾ Lagre</button>
        <button id="b_finish_btn" class="btn btn-lg" type="button">ğŸ Avslutt runde</button>
      </div>
    </div>
  </section>

  <!-- SERVICE -->
  <section id="service" class="card" style="display:none">
    <h2 class="title">Service</h2>
    <p>Etter runden â€“ huk av for utfÃ¸rt vedlikehold:</p>
    <label><input type="checkbox"> SkjÃ¦r smurt</label><br>
    <label><input type="checkbox"> Fres smurt</label><br>
    <label><input type="checkbox"> Forstilling smurt</label><br>
    <label><input type="checkbox"> OljenivÃ¥ sjekket foran</label><br>
    <label><input type="checkbox"> OljenivÃ¥ sjekket bak</label><br>
    <label><input type="checkbox"> Etterfylt olje</label><br>
    <label><input type="checkbox"> Fylt diesel</label><br>
    <label><input type="checkbox"> Annet</label><br><br>
    <textarea rows="4" style="width:100%" placeholder="Notaterâ€¦"></textarea><br>
    <button class="btn btn-lg">ğŸ’¾ Lagre service</button>
  </section>

  <!-- STATUS (placeholder â€“ behold din nÃ¥vÃ¦rende del-C hvis du har) -->
  <section id="status" class="card" style="display:none">
    <h2 class="title">Status</h2>
    <p>Se eksisterende statusvisning (din `del-C.js`) â€“ denne indexen har kun skall.</p>
  </section>

  <!-- ADMIN â€“ Liste med redigering + flytt opp/ned -->
  <section id="admin" class="card" style="display:none">
    <h2 class="title">Admin â€“ Adresse-liste</h2>

    <div class="card" style="margin-top:0">
      <h3 style="margin:0 0 8px 0">JSONBin-nÃ¸kkel</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="adm_key" type="password" placeholder="Lim inn X-Master-Key her"
               style="flex:1;min-width:240px;padding:8px;border-radius:8px;border:1px solid #334155;background:#0a1422;color:#e6edf3">
        <button id="adm_key_save" class="btn btn-primary">Lagre nÃ¸kkel</button>
        <button id="adm_key_clear" class="btn btn-ghost">Fjern</button>
      </div>
      <div id="adm_key_status" class="small muted" style="margin-top:6px">â€”</div>
    </div>

    <div class="row" style="gap:8px;flex-wrap:wrap;margin:10px 0 8px">
      <button id="adm_reload" class="btn">âŸ³ Hent fra sky</button>
      <button id="adm_save" class="btn btn-primary">ğŸ’¾ Lagre</button>
      <span id="adm_status" class="small muted">â€”</span>
    </div>

    <div class="small muted" style="margin-bottom:8px">
      Bruk â¬†ï¸/â¬‡ï¸ for rekkefÃ¸lge. Rediger <em>navn/gruppe/oppdrag</em> (SnÃ¸ / SnÃ¸ og grus). Kryss av <em>Aktiv</em>.
    </div>

    <ul id="adm_list" class="sort-list" aria-label="Adresse-rekkefÃ¸lge og redigering"></ul>
  </section>
</main>

<script>
/* enkel ruter */
function showPage(id){
  document.querySelectorAll('main section').forEach(s=>s.style.display='none');
  const el = document.getElementById(id);
  if (el) el.style.display='block';
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  const b = document.getElementById('nav-'+id); if (b) b.classList.add('active');
  location.hash = '#'+id;
}
window.addEventListener('hashchange', ()=>{
  const id = (location.hash||'#home').replace('#','');
  showPage(document.getElementById(id)?id:'home');
});
window.addEventListener('DOMContentLoaded', ()=>{
  const id = (location.hash||'#home').replace('#','');
  showPage(document.getElementById(id)?id:'home');
});

/* ====== Enkel state for Under arbeid ====== */
const S = {
  dir: 'Normal',
  addresses: [],
  idx: 0
};

function uiSetWork() {
  const now = S.addresses[S.idx] || null;
  const nextIdx = (S.dir === 'Motsatt') ? S.idx - 1 : S.idx + 1;
  const next = S.addresses[nextIdx] || null;

  document.getElementById('b_now').textContent  = now ? (now.name || 'â€“')  : 'â€“';
  document.getElementById('b_next').textContent = next ? (next.name || 'â€“') : 'â€“';
  document.getElementById('b_dir').textContent  = S.dir;
  document.getElementById('b_round').textContent = new Date().toLocaleDateString('no-NO');
  document.getElementById('b_job').textContent   = 'Rute';
  document.getElementById('b_season').textContent = (new Date().getMonth()>=7)
    ? `${new Date().getFullYear()}-${(new Date().getFullYear()+1).toString().slice(-2)}`
    : `${new Date().getFullYear()-1}-${new Date().getFullYear().toString().slice(-2)}`;
  document.getElementById('b_sync').textContent = 'â€”';
}

/* Hent adresser fra JSONBin (snapshot eller addresses) */
async function loadAddresses() {
  const cloud = await JSONBIN.getLatest();
  const arr = (cloud && cloud.snapshot && Array.isArray(cloud.snapshot.addresses))
    ? cloud.snapshot.addresses
    : (Array.isArray(cloud?.addresses) ? cloud.addresses : []);
  // bare aktive
  S.addresses = arr.filter(a => a.active !== false);
}

/* Start runde fra Hjem */
document.getElementById('a_start').addEventListener('click', async () => {
  try{
    // lagre prefs lokalt (enkelt)
    const prefs = {
      driver: document.getElementById('a_driver').value.trim() || 'driver',
      dir: document.getElementById('a_dir').value,
      eq: {
        plow: document.getElementById('a_eq_plow').checked,
        fres: document.getElementById('a_eq_fres').checked,
        sand: document.getElementById('a_eq_sand').checked
      }
    };
    localStorage.setItem('BROYT_PREFS', JSON.stringify(prefs));

    S.dir = prefs.dir;

    // krever nÃ¸kkel: dette trigges i del-A.js sin banner om nÃ¸kkel mangler
    await JSONBIN.checkConfigOrWarn();
    await loadAddresses();

    S.idx = (S.dir === 'Motsatt') ? (S.addresses.length - 1) : 0;
    uiSetWork();
    showPage('work');
  }catch(e){
    alert('Kunne ikke starte runde: ' + e.message);
  }
});

/* PWA install-knapp + iOS hint */
let deferredPrompt;
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault(); deferredPrompt=e;
  const btn=document.getElementById('installPrompt');
  if(btn){ btn.style.display='block'; btn.onclick=async()=>{ btn.style.display='none'; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; }; }
});
if(/iphone|ipad|ipod/i.test(navigator.userAgent)){
  const hint=document.getElementById('installPrompt');
  if(hint){ hint.innerHTML="ğŸ“² Trykk <strong>Del</strong> â†’ <strong>Legg til pÃ¥ Hjem-skjerm</strong>"; hint.style.display='block'; }
}

/* Admin â€“ nÃ¸kkel-felt */
(function(){
  const inp = document.getElementById('adm_key');
  const save = document.getElementById('adm_key_save');
  const clr  = document.getElementById('adm_key_clear');
  const out  = document.getElementById('adm_key_status');
  function getKey(){ try{ return localStorage.getItem('JSONBIN_KEY') || ''; }catch{ return ''; } }
  function setKey(v){ if(!v || v.trim().length < 10){ out.textContent='Ugyldig nÃ¸kkel.'; return; }
                      localStorage.setItem('JSONBIN_KEY', v.trim());
                      out.textContent='NÃ¸kkel lagret.'; window.dispatchEvent(new CustomEvent('broyt:key:updated')); }
  function clearKey(){ localStorage.removeItem('JSONBIN_KEY'); out.textContent='NÃ¸kkel fjernet.'; }
  if (inp) inp.value = getKey();
  if (save) save.onclick = ()=> setKey(inp.value);
  if (clr)  clr.onclick  = ()=> { clearKey(); inp.value=''; };
})();
</script>
</body>
</html>