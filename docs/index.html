<!doctype html><html lang="no"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><title>Br√∏yterute ‚Äì V9.2 Felt-modus</title><meta name="theme-color" content="#0f9d58"><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
:root{--bg:#111;--fg:#f4f6f8;--muted:#b8c0c7;--card:#1a1a1a;--cardBorder:#2a2a2a;--btnH:72px;--btnRadius:18px;--gap:12px;--green:#0f9d58;--red:#c21d03;--blue:#0061fe;--orange:#ff9800;--gray:#2f3337;--badge-green:#1f3b2a;--badge-blue:#1c2b4d;--badge-yellow:#3a3416;--badge-red:#3c1c1c;--disabled:#5e6166}
.light{--bg:#f5f6f7;--fg:#111;--muted:#666;--card:#fff;--cardBorder:#e6e6e6;--gray:#eee;--badge-green:#d4edda;--badge-blue:#e1f0ff;--badge-yellow:#fff3cd;--badge-red:#f8d7da;--disabled:#b9bcc1}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-text-size-adjust:100%}body{background:var(--bg);color:var(--fg)}#app{min-height:100%;display:grid;grid-template-rows:auto auto 1fr auto}
header{background:#0b0b0b;color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px}header h1{font-size:16px;margin:0}.subtitle{font-size:12px;opacity:.9}.spacer{flex:1}
.topbar{background:var(--card);border-bottom:1px solid var(--cardBorder);padding:8px 12px;display:flex;gap:10px;align-items:center}
.tab{border:none;border-radius:12px;padding:8px 12px;background:#2a2a2a;color:#fff;cursor:pointer}.light .tab{background:#2a2a2a;color:#fff}.tab.active{background:var(--green)}
.btn.s{height:44px;font-size:15px;border-radius:12px;border:1px solid var(--cardBorder);background:#222;color:#fff;cursor:pointer}.light .btn.s{background:#f2f2f2;color:#111;border-color:#ddd}.toggle{min-width:110px}
.page{display:none;padding:14px}.page.active{display:block}.card{background:var(--card);border:1px solid var(--cardBorder);border-radius:18px;padding:14px}.stack{display:flex;flex-direction:column;gap:12px}
.title-lg{font-size:30px;font-weight:800;line-height:1.25;margin:2px 0 4px}.muted{color:var(--muted)}.row{display:flex;gap:10px;flex-wrap:wrap}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:12px}.actions .btn{width:100%}.btn{height:var(--btnH);border:none;border-radius:var(--btnRadius);font-size:20px;font-weight:700;cursor:pointer}
.btn-green{background:var(--green);color:#fff}.btn-red{background:var(--red);color:#fff}.btn-blue{background:var(--blue);color:#fff}.btn-orange{background:var(--orange);color:#111}.btn-gray{background:var(--gray);color:#fff}
.b-green{background:var(--badge-green);color:#c9f5d5;padding:4px 10px;border-radius:999px;font-size:13px}
.b-blue{background:var(--badge-blue);color:#cfe1ff;padding:4px 10px;border-radius:999px;font-size:13px}
.b-yellow{background:var(--badge-yellow);color:#ffe7a0;padding:4px 10px;border-radius:999px;font-size:13px}
.b-red{background:var(--badge-red);color:#ffb1b1;padding:4px 10px;border-radius:999px;font-size:13px}
.thumbs{display:flex;gap:6px;flex-wrap:wrap}.thumbs img{width:54px;height:54px;object-fit:cover;border-radius:10px;border:1px solid var(--cardBorder)}
.list{display:flex;flex-direction:column;gap:10px}.item{background:var(--card);border:1px solid var(--cardBorder);border-radius:14px;padding:12px}.item.disabled{opacity:.55;filter:grayscale(.4)}
.item .name{font-weight:700;margin:0 0 6px}.item .rowbtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.field{display:flex;gap:8px}.field input[type=text]{flex:1;height:50px;border:1px solid var(--cardBorder);border-radius:12px;padding:0 12px;font-size:16px;background:transparent;color:var(--fg)}
.field select{height:50px;border:1px solid var(--cardBorder);border-radius:12px;padding:0 12px;font-size:16px;background:transparent;color:var(--fg)}
.light .field input[type=text],.light .field select{background:#fff;color:#111;border-color:#ddd}
#mapWrap{margin-top:6px;display:none}#map{width:100%;height:320px;border-radius:12px;border:1px solid var(--cardBorder)}
.footer{background:#0b0b0b;color:#fff;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.modalBg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10}
.modal{background:var(--card);border:1px solid var(--cardBorder);border-radius:16px;width:min(640px,92vw);padding:14px}.modal h3{margin:0 0 8px}
.row.wrap{flex-wrap:wrap}.check{display:flex;align-items:center;gap:8px;background:#171717;border:1px solid var(--cardBorder);padding:10px;border-radius:12px}.light .check{background:#f8f8f8}
textarea{width:100%;min-height:80px;border:1px solid var(--cardBorder);border-radius:12px;padding:10px;background:transparent;color:var(--fg)}.light textarea{background:#fff;color:#111;border-color:#ddd}
.hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div id="app">
<header><div><h1>Br√∏yterute</h1><div class="subtitle" id="roundInfo">Runde 1 ‚Äì Startet ‚Ä¶</div></div><div class="spacer"></div><button id="themeToggle" class="btn s toggle">üåô M√∏rk</button><div class="menu"><button id="menuSend" class="btn s">üì¶ Send rapport</button><button id="menuSvc" class="btn s">üß∞ Service</button><button id="menuCache" class="btn s">‚ôªÔ∏è Nullstill cache</button></div></header>
<div class="topbar"><button class="tab active" data-tab="work">Under arbeid</button><button class="tab" data-tab="register">Adresse-register</button><div class="spacer"></div><button id="trackToggle" class="btn s">Sporing: P√•</button></div>

<div id="page-work" class="page active">
  <div class="card stack">
    <div><span id="curStatus" class="b-yellow">Ikke utf√∏rt</span></div>
    <h2 id="curName" class="title-lg">‚Äî</h2>
    <div class="muted">Oppgave: <span id="curTask">‚Äî</span></div>
    <div class="muted">Neste: <span id="curNext">‚Äî</span></div>
    <div class="hint" id="compatHint" style="display:none">‚ö†Ô∏è Denne adressen matcher ikke valgt utstyr i dag.</div>
    <div class="row thumbs" id="curPhotos"></div>
    <div class="actions">
      <button id="btnOngoing" class="btn btn-gray">‚ñ∂Ô∏è P√•g√•r</button>
      <button id="btnDone" class="btn btn-green">‚úÖ Ferdig</button>
      <button id="btnBlocked" class="btn btn-red">‚õî Ikke mulig</button>
      <button id="btnNav" class="btn btn-blue">üß≠ Naviger</button>
      <button id="btnPhoto" class="btn btn-orange">üì∑ Foto</button>
      <button id="btnNext" class="btn btn-gray">üîÅ Neste</button>
      <button id="btnToggleMap" class="btn btn-gray" style="grid-column:1/-1">üó∫ Vis kart</button>
    </div>
    <div id="mapWrap"><div id="map" aria-label="Kart"></div></div>
  </div>
</div>

<div id="page-register" class="page stack">
  <div class="list" id="list"></div>
  <div class="card stack">
    <div class="field">
      <input id="addr" type="text" placeholder="Ny adresse / omr√•de">
      <select id="taskSel"><option>Br√∏yte</option><option>Frese</option><option>Str√∏</option><option>Br√∏yte og str√∏</option><option>Frese og str√∏</option><option>Br√∏ytestikker</option></select>
    </div>
    <div class="row">
      <button id="addBtn" class="btn btn-green" style="flex:1">+ Legg til</button>
      <button id="optBtn" class="btn btn-gray" style="flex:1">Optimaliser</button>
      <button id="fitAllBtn" class="btn btn-gray" style="flex:1">Vis alle p√• kart</button>
    </div>
  </div>
</div>

<div class="footer"><div>Live posisjon: <span id="posTxt">‚Äî</span></div><div><span class="muted">Versjon 9.2 ‚Äì Felt-modus (Okt 2025)</span></div></div>
</div>

<div id="svcBg" class="modalBg"><div class="modal"><h3>Service / Vedlikehold</h3><div class="row wrap">
<label class="check"><input id="svc_plog" type="checkbox"> Smurt <b>plog</b></label>
<label class="check"><input id="svc_fres" type="checkbox"> Smurt <b>fres</b></label>
<label class="check"><input id="svc_stro" type="checkbox"> Smurt <b>str√∏kasse</b></label>
<label class="check"><input id="svc_other" type="checkbox"> <b>Annet</b></label>
</div><div class="stack"><textarea id="svcNotes" placeholder="Anmerkninger ‚Ä¶"></textarea>
<div class="row" style="justify-content:flex-end"><button id="svcCancel" class="btn s">Avbryt</button><button id="svcSave" class="btn s" style="background:var(--green);color:#fff">Lagre</button></div></div></div></div>

<div id="doneBg" class="modalBg"><div class="modal"><h3>Runden er ferdig</h3><p>Vil du starte ny runde eller g√• til service/vedlikehold?</p>
<div class="row" style="justify-content:flex-end"><button id="doneCancel" class="btn s">Avbryt</button><button id="doneService" class="btn s" style="background:var(--blue);color:#fff">G√• til service</button><button id="doneNewRound" class="btn s" style="background:var(--green);color:#fff">Start ny runde</button></div></div></div>

<div id="equipBg" class="modalBg"><div class="modal"><h3>Hvilket utstyr bruker du i dag?</h3>
<div class="row wrap"><label class="check"><input id="eq_plog" type="checkbox"> Plog</label><label class="check"><input id="eq_fres" type="checkbox"> Fres</label><label class="check"><input id="eq_stro" type="checkbox"> Str√∏kasse</label></div>
<p class="hint">Adresser som ikke passer til valgt utstyr vises som gr√•.</p>
<div class="row" style="justify-content:flex-end"><button id="equipSave" class="btn s" style="background:var(--green);color:#fff">Start</button></div></div></div>

<input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(()=>{const LS_KEY='broyte_v9_2_local_state',DRV_KEY='broyte_driver_name',THEME_KEY='broyte_theme',EQUIP_KEY='broyte_equipment',NAV_FLAG='broyte_nav_active';
let state=loadState()||seedState(),equipment=loadEquipment()||{plog:true,fres:false,stro:false},pendingPhotoStopId=null,watchId=null,mapVisible=false,map,markers=[];
let theme=localStorage.getItem(THEME_KEY)||'dark';applyTheme(theme);
function seedState(){return{round:1,startedAt:Date.now(),driver:localStorage.getItem(DRV_KEY)||'',stops:[],service:{plog:false,fres:false,stro:false,other:false,notes:''}}}
function mkStop(name,task){return{id:uid(),name,task,status:'pending',details:'',photos:[],startedAt:null,finishedAt:null,comment:'',lat:null,lng:null,_askedCheckin:false}}
function uid(){return Math.random().toString(36).slice(2,10)}
function saveState(){try{localStorage.setItem(LS_KEY,JSON.stringify(state))}catch(e){}}
function loadState(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'')}catch(e){return null}}
function saveEquipment(){localStorage.setItem(EQUIP_KEY,JSON.stringify(equipment))}
function loadEquipment(){try{return JSON.parse(localStorage.getItem(EQUIP_KEY)||'')}catch(e){return null}}
setTimeout(()=>{if(!state.driver){let nm=prompt('Sj√•f√∏rnavn (valgfritt, brukes i rapport):')||'';state.driver=(nm||'').trim();localStorage.setItem(DRV_KEY,state.driver);saveState();renderAll()}},200);
if(localStorage.getItem(EQUIP_KEY)===null) showEquipModal();
document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));b.classList.add('active');const t=b.getAttribute('data-tab');document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+t).classList.add('active')}));
document.getElementById('themeToggle').addEventListener('click',function(){theme=(theme==='dark'?'light':'dark');applyTheme(theme);localStorage.setItem(THEME_KEY,theme);this.textContent=theme==='dark'?'üåô M√∏rk':'‚òÄÔ∏è Lys'});document.getElementById('themeToggle').textContent=theme==='dark'?'üåô M√∏rk':'‚òÄÔ∏è Lys';
function applyTheme(m){if(m==='light')document.body.classList.add('light');else document.body.classList.remove('light')}
document.getElementById('menuCache').addEventListener('click',resetCache);
document.getElementById('menuSend').addEventListener('click',sendZip);
document.getElementById('menuSvc').addEventListener('click',()=>showSvcModal());
function ensureMap(){if(map)return;map=L.map('map').setView([60.283,11.187],12);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map)}
function refreshMarkers(){if(!map)return;markers.forEach(m=>map.removeLayer(m));markers=[];state.stops.forEach((s,i)=>{if(s.lat&&s.lng){markers.push(L.marker([s.lat,s.lng]).addTo(map).bindPopup((i+1)+'. '+s.name+'<br>'+s.task))}})}
function fitAll(){if(!map)return;let ll=[];state.stops.forEach(s=>{if(s.lat&&s.lng)ll.push([s.lat,s.lng])});if(ll.length)map.fitBounds(L.latLngBounds(ll),{padding:[16,16]})}
document.getElementById('btnOngoing').addEventListener('click',()=>{const cur=getCurrent();if(!cur)return;if(!cur.startedAt)cur.startedAt=Date.now();cur.status='ongoing';saveState();renderAll()});
document.getElementById('btnDone').addEventListener('click',()=>{const cur=getCurrent();if(!cur)return;if(cur.task==='Br√∏ytestikker'){let n=prompt('Antall br√∏ytestikker?',(cur.details||'').replace(/\D/g,''));if(n===null)return;cur.details='Br√∏ytestikker: '+(parseInt(n||'0',10)||0)}if(!cur.startedAt)cur.startedAt=Date.now();cur.finishedAt=Date.now();cur.status='done';saveState();renderAll();const next=getCurrent();if(next&&next.name)openGoogleMapsTo(next.name);else maybeShowRoundDone()});
document.getElementById('btnBlocked').addEventListener('click',()=>{const cur=getCurrent();if(!cur)return;const r=prompt('Hvorfor ikke mulig √• utf√∏re? (valgfritt)')||'';cur.status='blocked';if(!cur.startedAt)cur.startedAt=Date.now();cur.finishedAt=Date.now();if(r)cur.details=(cur.details?cur.details+' ¬∑ ':'')+'√Örsak: '+r;saveState();renderAll();maybeShowRoundDone()});
document.getElementById('btnNav').addEventListener('click',()=>{const cur=getCurrent();if(!cur||!cur.name)return;try{sessionStorage.setItem(NAV_FLAG,'1')}catch(e){};window.location.href='https://www.google.com/maps/dir/?api=1&destination='+encodeURIComponent(cur.name)});
document.getElementById('btnPhoto').addEventListener('click',()=>{const cur=getCurrent();if(!cur)return;pendingPhotoStopId=cur.id;document.getElementById('fileInput').click()});
document.getElementById('btnNext').addEventListener('click',()=>{const cur=getCurrent();if(!cur)return;const next=getNextAfter(cur.id)||null;if(next){if(!next.startedAt)next.startedAt=Date.now();next.status='ongoing';saveState();renderAll();openGoogleMapsTo(next.name)}else{maybeShowRoundDone()}});
document.getElementById('btnToggleMap').addEventListener('click',function(){mapVisible=!mapVisible;document.getElementById('mapWrap').style.display=mapVisible?'block':'none';this.textContent=mapVisible?'üó∫ Skjul kart':'üó∫ Vis kart';if(mapVisible){ensureMap();refreshMarkers();fitAll()}})
document.getElementById('addBtn').addEventListener('click',()=>{const name=document.getElementById('addr').value.trim();const task=document.getElementById('taskSel').value;if(!name)return;const st=mkStop(name,task);state.stops.push(st);document.getElementById('addr').value='';saveState();ensureCoords(st);renderAll()});
document.getElementById('optBtn').addEventListener('click',()=>{state.stops.sort((a,b)=>(a.name||'').localeCompare(b.name||'','no'));saveState();renderAll();refreshMarkers();fitAll()});
document.getElementById('fitAllBtn').addEventListener('click',()=>{ensureMap();refreshMarkers();fitAll();mapVisible=true;document.getElementById('mapWrap').style.display='block';document.getElementById('btnToggleMap').textContent='üó∫ Skjul kart'});
document.getElementById('fileInput').addEventListener('change',e=>{const f=e.target.files&&e.target.files[0];if(!f||!pendingPhotoStopId)return;const r=new FileReader();r.onload=()=>{const s=state.stops.find(x=>x.id===pendingPhotoStopId);if(s){s.photos=s.photos||[];s.photos.push({dataUrl:r.result,ts:Date.now()});saveState();renderAll()}pendingPhotoStopId=null;e.target.value=''};r.readAsDataURL(f)});
document.getElementById('trackToggle').addEventListener('click',function(){if(watchId===null)startTracking();else stopTracking()});startTracking();
function startTracking(){if(!('geolocation'in navigator))return;if(watchId!==null)navigator.geolocation.clearWatch(watchId);watchId=navigator.geolocation.watchPosition(p=>{const {latitude:lat,longitude:lng,accuracy:acc}=p.coords;document.getElementById('posTxt').textContent=lat.toFixed(5)+', '+lng.toFixed(5)+' (¬±'+Math.round(acc)+' m)';const cur=getCurrent();if(cur&&cur.lat&&cur.lng){const d=haversineMeters(lat,lng,cur.lat,cur.lng);if(d<60&&!cur._askedCheckin){cur._askedCheckin=true;saveState();if(confirm('Du er ved "'+cur.name+'". Sjekk inn n√•?')){if(!cur.startedAt)cur.startedAt=Date.now();cur.details=(cur.details?cur.details+' ¬∑ ':'')+'Sjekket inn';cur.status='ongoing';saveState();renderAll()}}}},()=>{}, {enableHighAccuracy:true,maximumAge:5000,timeout:20000});this.textContent='Sporing: P√•'}
function stopTracking(){if(watchId!==null)navigator.geolocation.clearWatch(watchId);watchId=null;document.getElementById('posTxt').textContent='‚Äî';document.getElementById('trackToggle').textContent='Sporing: Av'}
function geocodeNameToCoords(name,cb){fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(name),{headers:{'Accept-Language':'no'}}).then(r=>r.json()).then(js=>{if(js&&js[0])cb({lat:parseFloat(js[0].lat),lng:parseFloat(js[0].lon)});else cb(null)}).catch(()=>cb(null))}
function ensureCoords(stop){if(stop&&(!stop.lat||!stop.lng)&&stop.name){geocodeNameToCoords(stop.name,c=>{if(c){stop.lat=c.lat;stop.lng=c.lng;saveState();refreshMarkers()}})}}
function showSvcModal(){document.getElementById('svc_plog').checked=!!state.service.plog;document.getElementById('svc_fres').checked=!!state.service.fres;document.getElementById('svc_stro').checked=!!state.service.stro;document.getElementById('svc_other').checked=!!state.service.other;document.getElementById('svcNotes').value=state.service.notes||'';document.getElementById('svcBg').style.display='flex'}
document.getElementById('svcCancel').addEventListener('click',()=>document.getElementById('svcBg').style.display='none');
document.getElementById('svcSave').addEventListener('click',async()=>{state.service={plog:document.getElementById('svc_plog').checked,fres:document.getElementById('svc_fres').checked,stro:document.getElementById('svc_stro').checked,other:document.getElementById('svc_other').checked,notes:document.getElementById('svcNotes').value.trim()};saveState();document.getElementById('svcBg').style.display='none';await sendZip();alert('Service lagret og rapport generert.')});
function maybeShowRoundDone(){const any=state.stops.some(s=>s.status!=='done'&&s.status!=='blocked');if(!any){if(document.getElementById('doneBg').style.display!=='flex')document.getElementById('doneBg').style.display='flex'}}
document.getElementById('doneCancel').addEventListener('click',()=>document.getElementById('doneBg').style.display='none');
document.getElementById('doneService').addEventListener('click',()=>{document.getElementById('doneBg').style.display='none';showSvcModal()});
document.getElementById('doneNewRound').addEventListener('click',()=>{document.getElementById('doneBg').style.display='none';startNewRound()});
function showEquipModal(){document.getElementById('eq_plog').checked=!!equipment.plog;document.getElementById('eq_fres').checked=!!equipment.fres;document.getElementById('eq_stro').checked=!!equipment.stro;document.getElementById('equipBg').style.display='flex'}
document.getElementById('equipSave').addEventListener('click',()=>{equipment={plog:document.getElementById('eq_plog').checked,fres:document.getElementById('eq_fres').checked,stro:document.getElementById('eq_stro').checked};saveEquipment();document.getElementById('equipBg').style.display='none';renderAll()});
async function sendZip(){const obj=await buildZip();await shareOrDownloadZip(obj.zipBlob,obj.fileName)}
async function buildZip(){const round=state.round,startedAt=new Date(state.startedAt),finishedAt=new Date();let lines=[['Runde','Start','Slutt','Sj√•f√∏r','Navn','Oppgave','Status','Detaljer','Kommentar','Antall bilder','Starttid','Sluttid','Svc:plog','Svc:fres','Svc:stro','Svc:annet','Svc:notat'].join(',')];state.stops.forEach(s=>{lines.push([round,startedAt.toISOString(),finishedAt.toISOString(),csvEscape(state.driver||''),csvEscape(s.name),csvEscape(s.task),s.status,csvEscape(s.details||''),csvEscape(s.comment||''),(s.photos?s.photos.length:0),s.startedAt?new Date(s.startedAt).toISOString():'',s.finishedAt?new Date(s.finishedAt).toISOString():'',state.service.plog,state.service.fres,state.service.stro,state.service.other,csvEscape(state.service.notes||'')].join(','))});const csv=lines.join('\n');const {jsPDF}=window.jspdf;const pdf=new jsPDF();pdf.setFontSize(12);pdf.text('Br√∏yterute ‚Äì Runde '+round,14,14);pdf.text('Start: '+startedAt.toLocaleString('no-NO')+'  Slutt: '+finishedAt.toLocaleString('no-NO'),14,22);if(state.driver)pdf.text('Sj√•f√∏r: '+state.driver,14,30);if(state.service&&(state.service.plog||state.service.fres||state.service.stro||state.service.other||state.service.notes)){let svc='Service: '+(state.service.plog?'plog ':'')+(state.service.fres?'fres ':'')+(state.service.stro?'str√∏kasse ':'')+(state.service.other?'annet ':'');pdf.text(svc.trim(),14,38);if(state.service.notes)pdf.text('Notat: '+state.service.notes,14,46)}let y=(state.service&&(state.service.plog||state.service.fres||state.service.stro||state.service.other||state.service.notes))?56:38;state.stops.forEach((st,i)=>{const line=(i+1)+'. '+st.name+' ‚Äî '+st.task+' ‚Äî '+(st.status==='done'?'Ferdig':st.status==='blocked'?'Stoppet':st.status==='ongoing'?'P√•g√•r':'Ikke utf√∏rt')+(st.details?(' ‚Äî '+st.details):'')+(st.comment?(' ‚Äî '+st.comment):'');const arr=pdf.splitTextToSize(line,180);if(y+arr.length*6>280){pdf.addPage();y=20}pdf.text(arr,14,y);y+=arr.length*6+2});const pdfBlob=pdf.output('blob');const zip=new JSZip();zip.file('broeyting_dokumentasjon_runde'+round+'.csv',csv);zip.file('broeyting_rapport_runde'+round+'.pdf',pdfBlob);let idx=1;state.stops.forEach(st=>{if(st.photos&&st.photos.length){st.photos.forEach((p,i)=>{const base64=(p.dataUrl.split(',')[1]||'');zip.file('bilder/'+String(idx).padStart(2,'0')+'_'+safeName(st.name)+'_'+(i+1)+'.jpg',base64,{base64:true})})}idx++});const blob=await zip.generateAsync({type:'blob'});return{zipBlob:blob,fileName:'broeyting_dokumentasjon_runde'+round+'.zip'}}
async function shareOrDownloadZip(zipBlob,fileName){const file=new File([zipBlob],fileName,{type:'application/zip'});if(navigator.canShare&&navigator.canShare({files:[file]})){try{await navigator.share({files:[file],title:'Br√∏yterapport',text:'ZIP med CSV, PDF og bilder.'});return}catch(e){}}downloadBlob(zipBlob,fileName);window.location.href='mailto:?subject='+encodeURIComponent('Br√∏yterapport '+fileName)+'&body='+encodeURIComponent('ZIP er lastet ned. Legg den ved e-posten.')}
async function resetCache(){try{if('serviceWorker'in navigator){const regs=await navigator.serviceWorker.getRegistrations();for(const r of regs)await r.unregister()}if('caches'in window){const keys=await caches.keys();await Promise.all(keys.map(k=>caches.delete(k)))}localStorage.removeItem(LS_KEY);const url=new URL(location.href);url.searchParams.set('bust',Date.now());location.replace(url.toString())}catch(e){alert('Kunne ikke nullstille cache.')}}
function csvEscape(s){return'"'+String(s).replace(/"/g,'""')+'"'}function safeName(s){return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'')}
function downloadBlob(b,f){const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=f;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1000)}
function haversineMeters(aLat,aLng,bLat,bLng){const toRad=v=>v*Math.PI/180,R=6371000,dLat=toRad(bLat-aLat),dLng=toRad(bLng-aLng);const s1=Math.sin(dLat/2)**2+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;return 2*R*Math.asin(Math.sqrt(s1))}
function isCompatible(stop){const t=stop.task||'';const needP=/Br√∏yte/.test(t),needF=/Frese/.test(t),needS=/Str√∏/.test(t);if(needP&&!equipment.plog)return false;if(needF&&!equipment.fres)return false;if(needS&&!equipment.stro)return false;return true}
function labelStatus(s){return s==='done'?'Ferdig':(s==='blocked'?'Stoppet':(s==='ongoing'?'P√•g√•r':'Ikke utf√∏rt'))}
function statusClass(s){return s==='done'?'b-green':(s==='blocked'?'b-red':(s==='ongoing'?'b-blue':'b-yellow'))}
function renderRegister(){const list=document.getElementById('list');list.innerHTML='';state.stops.forEach((s,i)=>{const disabled=!isCompatible(s);const el=document.createElement('div');el.className='item'+(disabled?' disabled':'');el.innerHTML='<div class="row" style="justify-content:space-between;align-items:center;"><div style="min-width:240px"><div class="name"><input data-f="name" type="text" value="'+escapeHtml(s.name)+'" style="width:100%;height:42px;border:1px solid var(--cardBorder);border-radius:10px;padding:0 10px;background:transparent;color:inherit"></div><div class="muted">Oppgave: <select data-f="task" style="background:transparent;color:inherit;border:1px solid var(--cardBorder);border-radius:10px;padding:6px 8px"><option'+(s.task==='Br√∏yte'?' selected':'')+'>Br√∏yte</option><option'+(s.task==='Frese'?' selected':'')+'>Frese</option><option'+(s.task==='Str√∏'?' selected':'')+'>Str√∏</option><option'+(s.task==='Br√∏yte og str√∏'?' selected':'')+'>Br√∏yte og str√∏</option><option'+(s.task==='Frese og str√∏'?' selected':'')+'>Frese og str√∏</option><option'+(s.task==='Br√∏ytestikker'?' selected':'')+'>Br√∏ytestikker</option></select></div>'+(disabled?'<div class="hint">‚ö†Ô∏è Ikke kompatibel med valgt utstyr i dag</div>':'')+'</div><div><span class="'+statusClass(s.status)+'">'+labelStatus(s.status)+'</span></div></div><div class="rowbtns"><button class="btn s" data-act="ongoing">‚ñ∂Ô∏è P√•g√•r</button><button class="btn s" style="background:var(--green);color:#fff" data-act="done">‚úÖ Ferdig</button><button class="btn s" style="background:var(--red);color:#fff" data-act="blocked">‚õî Ikke mulig</button><button class="btn s" data-act="photo">üì∑ Foto</button><button class="btn s" data-act="nav">üß≠ Naviger</button><button class="btn s" data-act="up">‚Üë</button><button class="btn s" data-act="down">‚Üì</button></div>';el.querySelector('[data-f="name"]').addEventListener('input',e=>{s.name=e.target.value;saveState()});el.querySelector('[data-f="name"]').addEventListener('blur',()=>ensureCoords(s));el.querySelector('[data-f="task"]').addEventListener('change',e=>{s.task=e.target.value;if(s.task!=='Br√∏ytestikker')s.details='';saveState();renderAll()});el.querySelector('[data-act="ongoing"]').addEventListener('click',()=>{if(!s.startedAt)s.startedAt=Date.now();s.status='ongoing';saveState();renderAll()});el.querySelector('[data-act="done"]').addEventListener('click',()=>{if(s.task==='Br√∏ytestikker'){const n=prompt('Antall br√∏ytestikker?',(s.details||'').replace(/\D/g,''));if(n===null)return;s.details='Br√∏ytestikker: '+(parseInt(n||'0',10)||0)}if(!s.startedAt)s.startedAt=Date.now();s.finishedAt=Date.now();s.status='done';saveState();renderAll()});el.querySelector('[data-act="blocked"]').addEventListener('click',()=>{const r=prompt('Hvorfor ikke mulig √• utf√∏re? (valgfritt)')||'';s.status='blocked';if(!s.startedAt)s.startedAt=Date.now();s.finishedAt=Date.now();if(r)s.details=(s.details?s.details+' ¬∑ ':'')+'√Örsak: '+r;saveState();renderAll()});el.querySelector('[data-act="photo"]').addEventListener('click',()=>{pendingPhotoStopId=s.id;document.getElementById('fileInput').click()});el.querySelector('[data-act="nav"]').addEventListener('click',()=>openGoogleMapsTo(s.name));el.querySelector('[data-act="up"]').addEventListener('click',()=>{if(i>0){const t=state.stops[i-1];state.stops[i-1]=state.stops[i];state.stops[i]=t;saveState();renderAll();refreshMarkers()}});el.querySelector('[data-act="down"]').addEventListener('click',()=>{if(i<state.stops.length-1){const t=state.stops[i+1];state.stops[i+1]=state.stops[i];state.stops[i]=t;saveState();renderAll();refreshMarkers()}});list.appendChild(el)})}
function startNewRound(){state.round+=1;state.startedAt=Date.now();state.stops.forEach(s=>{s.status='pending';s.startedAt=null;s.finishedAt=null;s.details=(s.task==='Br√∏ytestikker')?'':s.details;s.photos=[];s.comment='';s._askedCheckin=false});state.service={plog:false,fres:false,stro:false,other:false,notes:''};saveState();renderAll()}
function renderAll(){document.getElementById('roundInfo').textContent='Runde '+state.round+' ‚Äì Startet '+new Date(state.startedAt).toLocaleString('no-NO')+(state.driver?' ‚Äì Sj√•f√∏r: '+state.driver:'');const cur=getCurrent(),nxt=cur?getNextAfter(cur.id):null;document.getElementById('curName').textContent=cur?cur.name:'‚Äî';document.getElementById('curTask').textContent=cur?cur.task:'‚Äî';const stEl=document.getElementById('curStatus');stEl.textContent=cur?labelStatus(cur.status):'‚Äî';stEl.className=(cur?statusClass(cur.status):'b-yellow');document.getElementById('curNext').textContent=nxt?nxt.name:'‚Äî';document.getElementById('compatHint').style.display=(cur&&!isCompatible(cur))?'block':'none';const g=document.getElementById('curPhotos');g.innerHTML='';if(cur&&cur.photos&&cur.photos.length){cur.photos.forEach(p=>{const img=document.createElement('img');img.src=p.dataUrl;img.alt='foto';g.appendChild(img)})}renderRegister();const anyPending=state.stops.some(s=>s.status!=='done'&&s.status!=='blocked');if(!anyPending&&document.getElementById('doneBg').style.display!=='flex'){document.getElementById('doneBg').style.display='flex'}}
if(!state.stops.length){['AMFI Eidsvoll (R√•holt)','R√•holt barneskole','R√•holt ungdomsskole','Dal stasjon','H√∏ybr√•ten'].forEach(n=>state.stops.push(mkStop(n,'Br√∏yte')));saveState()}
state.stops.forEach(s=>{if(!s.lat||!s.lng)ensureCoords(s)});
try{if(sessionStorage.getItem(NAV_FLAG)==='1'){sessionStorage.removeItem(NAV_FLAG)}}catch(e){}
document.addEventListener('visibilitychange',()=>{if(!document.hidden)renderAll()});renderAll();
function getCurrent(){for(let i=0;i<state.stops.length;i++){const s=state.stops[i];if(s.status!=='done'&&s.status!=='blocked'&&isCompatible(s))return s}for(let j=0;j<state.stops.length;j++){const t=state.stops[j];if(t.status!=='done'&&t.status!=='blocked')return t}return null}
function getNextAfter(id){let seen=false,fallback=null;for(let i=0;i<state.stops.length;i++){const s=state.stops[i];if(s.id===id){seen=true;continue}if(seen&&s.status!=='done'&&s.status!=='blocked'){if(isCompatible(s))return s;if(!fallback)fallback=s}}return fallback}
function openGoogleMapsTo(address){try{sessionStorage.setItem(NAV_FLAG,'1')}catch(e){}window.location.href='https://www.google.com/maps/dir/?api=1&destination='+encodeURIComponent(address)}
function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
})();
</script>
</body>
</html>