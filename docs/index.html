<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Br√∏yterute</title>
  <style>
    :root { --appbar-h: 64px; }
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .appbar{
      position:fixed; top:0; left:0; right:0; height:var(--appbar-h);
      display:flex; align-items:center; gap:12px; padding:0 16px;
      background:#0f172a; color:#fff; z-index:1000; padding-top: env(safe-area-inset-top);
    }
    #btnMenu{background:transparent;border:0;color:#fff;font-size:22px;}
    .appbar-title{font-weight:600}
    #sync_badge{margin-left:8px;font-size:.9rem;opacity:.9}
    #sync_time{margin-left:6px;font-size:.8rem;opacity:.7}
    #wl_dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:8px;background:#ef4444}
    main{padding:16px; padding-top:calc(var(--appbar-h) + 16px + env(safe-area-inset-top));}

    /* Drawer */
    #scrim{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.2s;z-index:999}
    #scrim.show{opacity:1;pointer-events:auto}
    #drawer{
      position:fixed; top:0; bottom:0; left:0; width:290px; max-width:80vw; background:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,.25); transform:translateX(-100%); transition:.2s; z-index:1001;
      padding-top: calc(env(safe-area-inset-top) + 10px);
    }
    #drawer.open{transform:translateX(0)}
    .drawer-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;}
    .drawer-title{font-weight:700}
    .drawer-link{display:block;padding:12px 16px;text-decoration:none;color:#111}
    .drawer-link:hover{background:#f2f2f2}

    /* Tabbing tables etc. */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px}
    .row{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid #ddd;background:#fff;padding:8px 12px;border-radius:8px}
    .btn.primary{background:#0ea5e9;color:#fff;border-color:#0284c7}
    .btn.ghost{border-color:transparent}
    .badge{padding:4px 8px;border-radius:999px;background:#eee;font-size:.8rem}
    .prog{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .prog > div{height:100%}
    #b_prog_me{background:#22c55e}
    #b_prog_other{background:#a78bfa}

    /* Hide sections by default */
    main section{display:none}
    main section.show{display:block}
  </style>
</head>
<body>
  <header class="appbar">
    <button id="btnMenu" aria-label="Meny">‚ò∞</button>
    <div class="appbar-title">Br√∏yterute
      <span id="sync_badge">‚óè Synk: ukjent</span>
      <span id="sync_time"></span>
      <span id="wl_dot" title="Hold skjerm v√•ken-indikator"></span>
    </div>
  </header>

  <div id="scrim"></div>
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="drawer-title">Meny</div>
      <button id="btnCloseDrawer" class="btn ghost">Lukk</button>
    </div>
    <a class="drawer-link" data-go="home">Hjem</a>
    <a class="drawer-link" data-go="work">Under arbeid</a>
    <a class="drawer-link" data-go="service">Service</a>
    <a class="drawer-link" data-go="status">Status</a>
    <a class="drawer-link" data-go="admin">Admin</a>

    <div style="height:16px"></div>
    <div class="drawer-title" style="padding:0 16px;opacity:.65;font-size:.9rem;">Hurtig</div>
    <a class="drawer-link" id="qk_grus">Hent grus</a>
    <a class="drawer-link" id="qk_diesel">Fyll diesel</a>
    <a class="drawer-link" id="qk_base">Til base</a>
  </aside>

  <main>
    <!-- Hjem -->
    <section id="home" class="show">
      <h2>Hjem</h2>
      <div class="row">
        <label class="row"><input type="checkbox" id="a_eq_plow"> Plog</label>
        <label class="row"><input type="checkbox" id="a_eq_fres"> Fres</label>
        <label class="row"><input type="checkbox" id="a_eq_sand"> Sand/Grus</label>
      </div>
      <div class="row" style="margin-top:10px">
        <label>F√∏rer: <input id="a_driver" placeholder="Navn"></label>
        <label>Rekkef√∏lge:
          <select id="a_dir"><option>Normal</option><option>Motsatt</option></select>
        </label>
        <label class="row"><input type="checkbox" id="a_autoNav"> Auto-naviger</label>
      </div>
      <div style="margin-top:10px">
        <button id="a_start" class="btn primary">Start runde</button>
      </div>

      <div style="margin-top:14px">
        <button id="qk_wl" class="btn">Hold skjerm v√•ken</button>
        <span id="qk_wl_status" class="badge">Status: av</span>
      </div>
    </section>

    <!-- Under arbeid -->
    <section id="work">
      <h2>Under arbeid</h2>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div>Retning: <span id="b_dir" class="badge">‚Äî</span></div>
        <div>Oppgave: <span id="b_task" class="badge">‚Äî</span></div>
        <div>Status: <span id="b_status" class="badge">‚Äî</span></div>
      </div>
      <div style="margin:10px 0">
        N√•: <strong id="b_now">‚Äî</strong><br/>
        Neste: <strong id="b_next">‚Äî</strong>
      </div>
      <div class="row" style="margin:10px 0">
        <button id="act_start" class="btn">Start</button>
        <button id="act_done" class="btn primary">Ferdig</button>
        <button id="act_skip" class="btn">Hopp over</button>
        <button id="act_block" class="btn">Ikke mulig</button>
        <button id="act_acc" class="btn">Uhell</button>
        <button id="act_nav" class="btn">Naviger</button>
      </div>
      <div class="prog"><div id="b_prog_me" style="width:0"></div><div id="b_prog_other" style="width:0"></div></div>
    </section>

    <!-- Service -->
    <section id="service">
      <h2>Service</h2>
      <p>Her kan du notere/service-logg (kan utvides senere).</p>
    </section>

    <!-- Status -->
    <section id="status">
      <h2>Status <span id="st_season_badge" class="badge"></span></h2>
      <div class="row" style="flex-wrap:wrap">
        <label>Vis: 
          <select id="st_mode"><option value="snow">Sn√∏</option><option value="grit">Grus</option></select>
        </label>
        <label>Filter:
          <select id="st_filter">
            <option value="alle">Alle</option>
            <option value="ikke">Ikke p√•begynt</option>
            <option value="p√•g√•r">P√•g√•r</option>
            <option value="ferdig">Ferdig</option>
            <option value="hoppet">Hoppet over</option>
            <option value="umulig">Ikke mulig</option>
            <option value="uhell">Uhell</option>
          </select>
        </label>
        <button id="st_reload" class="btn">Oppdater</button>
        <button id="st_lock_toggle" class="btn">üîì L√•s stikker (sesong)</button>
        <button onclick="exportCsv()" class="btn">Last ned CSV</button>
      </div>
      <div id="st_summary" style="margin:10px 0"></div>
      <table>
        <thead><tr>
          <th>#</th><th>Adresse</th><th>Oppdrag</th><th>Stikker</th><th>üß≠</th>
          <th>Status</th><th>Start</th><th>Ferdig</th><th>Utf√∏rt av</th><th>Foto</th>
        </tr></thead>
        <tbody id="st_tbody"></tbody>
      </table>
    </section>

    <!-- Admin -->
    <section id="admin">
      <h2>Admin</h2>

      <h3>Skyoppsett</h3>
      <div class="row" style="flex-wrap:wrap">
        <label>GET-URL: <input id="adm_geturl" size="40" placeholder="https://..."></label>
        <label>PUT-URL: <input id="adm_puturl" size="40" placeholder="https://..."></label>
        <label>X-Master-Key: <input id="adm_key" size="32" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label>
      </div>
      <div class="row" style="margin:6px 0">
        <button id="adm_urls_save" class="btn">Lagre</button>
        <button id="adm_urls_clear" class="btn">Fjern</button>
        <button id="adm_key_save" class="btn">Lagre n√∏kkel</button>
        <button id="adm_key_clear" class="btn">Fjern n√∏kkel</button>
        <span id="adm_urls_status" class="badge">Mangler noe‚Ä¶</span>
        <span id="adm_key_status" class="badge"></span>
      </div>

      <h3>Steder (hurtig)</h3>
      <div class="row" style="flex-wrap:wrap">
        <label>Grus: <input id="adm_grus" placeholder="60.xxxxxx,11.xxxxxx"></label>
        <label>Diesel: <input id="adm_diesel" placeholder="60.xxxxxx,11.xxxxxx"></label>
        <label>Base: <input id="adm_base" placeholder="60.xxxxxx,11.xxxxxx"></label>
        <button id="adm_stakes_lock" class="btn">üîì L√•s stikker</button>
      </div>

      <h3>Adresse-register</h3>
      <div class="row" style="margin:6px 0">
        <button id="adm_addr_fetch" class="btn">Hent fra sky</button>
        <button id="adm_addr_save" class="btn primary">Lagre</button>
        <span id="adm_addr_msg" class="badge"></span>
      </div>
      <table>
        <thead><tr>
          <th>Aktiv</th><th>Adresse</th><th>Gruppe</th><th>Sn√∏</th><th>Grus</th><th>Stikker</th><th>Koordinater</th><th>Rekkef√∏lge</th>
        </tr></thead>
        <tbody id="adm_addr_tbody"></tbody>
      </table>
    </section>
  </main>

  <!-- ===== Felles logikk (STATE, JSONBIN, wake-lock, ruter, kart, seeds) ===== -->
  <script>
    // ------- Utils & state -------
    const $  = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const nowHHMM = (t=Date.now()) => new Date(t).toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'});
    const fmtTime = t => !t ? '‚Äî' : nowHHMM(t);
    const fmtDate = () => new Date().toLocaleDateString('no-NO');
    const STATE_LABEL={not_started:'Ikke p√•begynt',in_progress:'P√•g√•r',done:'Ferdig',skipped:'Hoppet over',blocked:'Ikke mulig',accident:'Uhell'};
    const S={dir:'Normal',addresses:[],idx:0,driver:'driver',autoNav:false,mode:'snow',cloud:null,lastSync:0,wake:null};

    // ------- Sync badge -------
    function ensureSyncBadge(){
      if($('#sync_badge')) return $('#sync_badge');
      const host=$('.appbar .appbar-title')||$('.appbar');
      const span=document.createElement('span'); span.id='sync_badge'; span.textContent='Synk: ukjent'; host?.appendChild(span);
      const small=document.createElement('span'); small.id='sync_time'; host?.appendChild(small);
      return span;
    }
    function setSync(status){
      const el=ensureSyncBadge(), time=$('#sync_time');
      const dots={ok:'‚óè',local:'‚óè',error:'‚óè',unknown:'‚óè'};
      const colors={ok:'#22c55e',local:'#f59e0b',error:'#ef4444',unknown:'#94a3b8'};
      const text=({ok:'OK',local:'lokal',error:'feil',unknown:'ukjent'})[status]||'ukjent';
      el.textContent=`${dots[status]} Synk: ${text}`;
      el.style.color=colors[status];
      time.textContent = S.lastSync ? ('‚Ä¢ '+nowHHMM(S.lastSync)) : '';
    }

    // ------- JSONBIN -------
    const JSONBIN={
      get _getUrl(){return localStorage.getItem('BROYT_BIN_URL')||'';},
      get _putUrl(){return localStorage.getItem('BROYT_BIN_PUT')||'';},
      get _key(){return localStorage.getItem('BROYT_XKEY')||'';},
      hasAll(){return !!(this._getUrl && this._putUrl);},
      setUrlPair(g,p){ if(g)localStorage.setItem('BROYT_BIN_URL',g); if(p)localStorage.setItem('BROYT_BIN_PUT',p); },
      setKey(k){ const v=(k||'').trim(); if(!v){localStorage.removeItem('BROYT_XKEY');return false;} localStorage.setItem('BROYT_XKEY',v); return true; },
      clearKey(){ localStorage.removeItem('BROYT_XKEY'); },
      _headers(){ const h={'Content-Type':'application/json'}; const k=this._key; if(k) h['X-Master-Key']=k; return h; },
      async getLatest(){
        const url=this._getUrl; if(!url){ setSync('local'); return this._localFallback(); }
        try{ const res=await fetch(url,{headers:this._headers()}); if(!res.ok) throw new Error(res.status);
             const j=await res.json(); setSync('ok'); S.lastSync=Date.now(); return j.record||j; }
        catch(e){ const local=this._localFallback(); if(local){setSync('local'); return local;} setSync('error'); throw e; }
      },
      async putRecord(obj){
        const url=this._putUrl;
        if(!url){ localStorage.setItem('BROYT_LOCAL_DATA',JSON.stringify(obj||{})); setSync('local'); S.lastSync=Date.now(); return {ok:false,local:true}; }
        try{ const res=await fetch(url,{method:'PUT',headers:this._headers(),body:JSON.stringify(obj||{})}); if(!res.ok) throw new Error(res.status);
             setSync('ok'); S.lastSync=Date.now(); return {ok:true}; }
        catch(e){ localStorage.setItem('BROYT_LOCAL_DATA',JSON.stringify(obj||{})); setSync('error'); return {ok:false}; }
      },
      _localFallback(){
        const local=JSON.parse(localStorage.getItem('BROYT_LOCAL_DATA')||'null');
        if(local) return local;
        return {version:'10.4.13',updated:Date.now(),by:'local',
          settings:{grusDepot:"60.2527264,11.1687230",diesel:"60.2523185,11.1899926",base:"60.2664414,11.2208819",seasonLabel:"2025‚Äì26",stakesLocked:false},
          snapshot:{addresses:[]},statusSnow:{},statusGrit:{},serviceLogs:[]};
      }
    };

    // ------- Seed / cloud helpers -------
    function seedAddressesList(){
      const base=["Hjeramoen 12-24","Hjerastubben 8, 10, 12 ,14, 16","Hjeramoen 32-34-40-42","Hjeramoen vei til 32-34-40-42",
        "Hjeramoen 47-49-51-53","Hjeramoen 48-50-52-54","Hjerakroken 2-4","Vognvegen 17","Tunlandvegen",
        "Bj√∏rnsrud Skog 38","Trondheimsvegen 26-36","Sessvollvegen 9","Sessvollvegen 11","Mette Hasler",
        "Henning Morken Hasler","Hasler Drivhus","Grendehuset","S√∏jordet","Folkeparken","Folkeparken Bakke",
        "L√¶ringsverkstedet Parkering","L√¶ringsverkstedet Ute omr√•det","Hagamoen","(Sj√∏viken) Hagamoen 12",
        "Moen Nedre vei","Fred/ Moen Nedre 17","Odd/ Moen Nedre 15","Trondheimsvegen 86","Fjellet (400m vei R√•holt)",
        "Bilextra (hele bygget)","Lundg√•rdstoppen","Normann Hjellesveg"];
      return base.map(n=>({name:n,group:"",active:true,flags:{snow:true,grit:false},stakes:'',coords:''}));
    }
    async function ensureAddressesSeeded(){
      S.cloud = await JSONBIN.getLatest();
      const arr = Array.isArray(S.cloud?.snapshot?.addresses) ? S.cloud.snapshot.addresses : [];
      if(arr.length>0) return;
      if(!S.cloud) S.cloud={}; if(!S.cloud.snapshot) S.cloud.snapshot={};
      S.cloud.snapshot.addresses=seedAddressesList();
      if(!S.cloud.statusSnow) S.cloud.statusSnow={};
      if(!S.cloud.statusGrit) S.cloud.statusGrit={};
      localStorage.setItem('BROYT_LOCAL_DATA',JSON.stringify(S.cloud));
      await JSONBIN.putRecord(S.cloud);
    }
    async function refreshCloud(){
      S.cloud = await JSONBIN.getLatest();
      if(S.cloud && !S.cloud.statusSnow && S.cloud.status) S.cloud.statusSnow=S.cloud.status;
      if(!S.cloud.statusSnow) S.cloud.statusSnow={};
      if(!S.cloud.statusGrit) S.cloud.statusGrit={};
      if(!S.cloud.settings)   S.cloud.settings={seasonLabel:"2025‚Äì26",stakesLocked:false};
    }
    async function saveCloud(){
      S.cloud.updated=Date.now(); S.cloud.by=S.driver||'driver';
      localStorage.setItem('BROYT_LOCAL_DATA',JSON.stringify(S.cloud));
      await JSONBIN.putRecord(S.cloud);
    }
    function statusStore(){return S.mode==='snow'?S.cloud.statusSnow:S.cloud.statusGrit;}
    const nextIndex=(i,d)=> d==='Motsatt' ? i-1 : i+1;

    // ------- Maps helpers -------
    function mapsUrlFromLatLon(latlon){ if(!latlon) return 'https://www.google.com/maps'; const q=String(latlon).replace(/\s+/g,''); return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(q)}`; }
    function mapsUrlFromAddr(addr){
      if(!addr) return 'https://www.google.com/maps';
      if(addr.coords && /-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?/.test(addr.coords)) return mapsUrlFromLatLon(addr.coords);
      return 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent((addr.name||'')+', Norge');
    }

    // ------- Wake lock (med gr√∏nn/r√∏d prikk) -------
    async function toggleWakeLock(){
      const status=$('#qk_wl_status'), dot=$('#wl_dot');
      try{
        if(S.wake && S.wake.active){ await S.wake.release(); S.wake=null; status&&(status.textContent='Status: av'); dot&&(dot.style.background='#ef4444'); return; }
        if('wakeLock' in navigator && navigator.wakeLock.request){
          S.wake=await navigator.wakeLock.request('screen');
          S.wake.addEventListener('release',()=>{status&&(status.textContent='Status: av'); dot&&(dot.style.background='#ef4444');});
          status&&(status.textContent='Status: p√• (native)'); dot&&(dot.style.background='#22c55e'); return;
        }
        let v=$('#wlHiddenVideo'); if(!v){ v=document.createElement('video'); v.id='wlHiddenVideo'; v.loop=true; v.muted=true; v.playsInline=true; v.style.display='none';
          v.src='data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAAAAG1wNDFtcDQyaXNvbWF2YzEAAABsbW9vdgAAAGxtdmhkAAAAANrJLTrayS06AAAC8AAAFW1sb2NhAAAAAAABAAAAAAEAAAEAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAABh0cmFrAAAAXHRraGQAAAAD2sk1OdrJNTkAAAFIAAAUbWRpYQAAACBtZGhkAAAAANrJLTrayS06AAAC8AAAACFoZGxyAAAAAAAAAABzb3VuAAAAAAAAAAAAAAAAU291bmRIYW5kbGVyAAAAAAAwAAAAAAABAQAAAAEAAABPAAAAAAAfAAAAAAALc291bmRfbmFtZQAA'; document.body.appendChild(v); }
        await v.play(); status&&(status.textContent='Status: p√• (iOS-fallback)'); dot&&(dot.style.background='#22c55e');
      }catch(e){ console.error(e); status&&(status.textContent='Status: feil'); }
    }
    window._shared={S,STATE_LABEL,nowHHMM,fmtTime,fmtDate,setSync,JSONBIN,ensureAddressesSeeded,refreshCloud,saveCloud,statusStore,nextIndex,mapsUrlFromAddr,mapsUrlFromLatLon,toggleWakeLock,$,$$};

    // ------- Drawer + routing -------
    function showPage(id){
      $$('main section').forEach(s=>s.classList.remove('show'));
      const el=$('#'+id); if(el) el.classList.add('show');
      location.hash='#'+id;

      // kall side-init
      if(id==='home'   && window.Home)   window.Home.onShow();
      if(id==='work'   && window.Work)   window.Work.onShow();
      if(id==='service'&& window.Service)window.Service.onShow();
      if(id==='status' && window.Status) window.Status.onShow();
      if(id==='admin'  && window.Admin)  window.Admin.onShow();
    }
    window.showPage=showPage;

    window.addEventListener('DOMContentLoaded', ()=>{
      // Drawer
      const drawer=$('#drawer'), scrim=$('#scrim');
      const open=()=>{drawer.classList.add('open'); scrim.classList.add('show'); drawer.setAttribute('aria-hidden','false');};
      const close=()=>{drawer.classList.remove('open'); scrim.classList.remove('show'); drawer.setAttribute('aria-hidden','true');};
      $('#btnMenu').addEventListener('click',open); $('#btnCloseDrawer').addEventListener('click',close); scrim.addEventListener('click',close);
      $$('#drawer .drawer-link[data-go]').forEach(b=>b.addEventListener('click',()=>{showPage(b.getAttribute('data-go')); close();}));

      // Quick actions i menyen
      $('#qk_grus').addEventListener('click', async ()=>{ try{ await refreshCloud(); const st=S.cloud?.settings||{}; const u=st.grusDepot?mapsUrlFromLatLon(st.grusDepot):'https://www.google.com/maps'; window.open(u,'_blank'); }catch(e){alert('Kunne ikke √•pne grus: '+e);} });
      $('#qk_diesel').addEventListener('click', async ()=>{ try{ await refreshCloud(); const st=S.cloud?.settings||{}; const u=st.diesel?mapsUrlFromLatLon(st.diesel):'https://www.google.com/maps'; window.open(u,'_blank'); }catch(e){alert('Kunne ikke √•pne diesel: '+e);} });
      $('#qk_base').addEventListener('click', async ()=>{ try{ await refreshCloud(); const st=S.cloud?.settings||{}; const u=st.base?mapsUrlFromLatLon(st.base):'https://www.google.com/maps'; window.open(u,'_blank'); }catch(e){alert('Kunne ikke √•pne base: '+e);} });

      // Wake lock knapp + indikator
      const wlNote=$('#qk_wl_status'); if(wlNote) wlNote.textContent='Status: av';
      $('#qk_wl')?.addEventListener('click', toggleWakeLock);
      $('#wl_dot').style.background='#ef4444';

      // Prefs inn fra storage
      try{
        const p=JSON.parse(localStorage.getItem('BROYT_PREFS')||'{}');
        if(p.driver)$('#a_driver').value=p.driver;
        if(p.dir)$('#a_dir').value=p.dir;
        if(p.eq){ $('#a_eq_plow').checked=!!p.eq.plow; $('#a_eq_fres').checked=!!p.eq.fres; $('#a_eq_sand').checked=!!p.eq.sand; }
        if(typeof p.autoNav==='boolean')$('#a_autoNav').checked=p.autoNav;
      }catch{}

      ensureSyncBadge();
      showPage((location.hash||'#home').replace('#','')||'home');
      window.addEventListener('hashchange',()=>{ const id=(location.hash||'#home').replace('#',''); showPage($('#'+id)?id:'home'); });

      // auto-retry sync
      setInterval(async ()=>{ const b=$('#sync_badge'); if(!b) return; const t=(b.textContent||'').toLowerCase(); if(t.includes('feil')||t.includes('ukjent')){ try{await JSONBIN.getLatest();}catch{}} }, 60000);
    });
  </script>

  <!-- Sidemoduler -->
  <script src="./home.js"></script>
  <script src="./work.js"></script>
  <script src="./service.js"></script>
  <script src="./status.js"></script>
  <script src="./admin.js"></script>
</body>
</html>