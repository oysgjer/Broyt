<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Br√∏yterute v9.12h ‚Äì Hybrid</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 8px 0; }
    .card header { display: flex; justify-content:space-between; align-items:center; font-weight: 600; }
    .muted { color: #666; font-size: 12px; }
    button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; background: #f6f6f6; }
    button:active { transform: scale(0.98); }
    select, input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 999px; background:#f1f1f1; border:1px solid #e3e3e3; }
    .stack { display: grid; gap: 6px; }
    .toolbar { display:flex; gap:8px; flex-wrap: wrap; margin: 8px 0; }
    .right { display:flex; align-items:center; gap:6px; }
    .grow { flex:1; }
    .ok { color:#0a7c2f; }
    .err { color:#b00020; }
  </style>

  <!-- Konfig -->
  <script>
    window.APP_CFG = {
      API_BASE: 'https://jsonbin-proxy.oysgjer.workers.dev/jsonbin/',
      BIN_ID:   '68e7b4d2ae596e708f0bde7d',
      APP_VER:  '9.12h'
    };
  </script>
</head>
<body>
  <h1>Br√∏yterute v9.12h</h1>

  <section class="card">
    <div class="row">
      <label for="driverName">F√∏rer-navn:</label>
      <input id="driverName" type="text" placeholder="√òystein" class="grow">
    </div>
    <div class="row" style="margin-top:8px">
      <label for="direction">Retning:</label>
      <select id="direction">
        <option>Standard</option>
        <option>Mot klokka</option>
        <option>Med klokka</option>
      </select>
      <span class="pill">Runde: <span id="roundNo">1</span></span>
      <span class="pill">Versjon: <span id="appVer">‚Äî</span></span>
    </div>
    <div class="row" style="margin-top:8px">
      <span>Utstyr:</span>
      <label><input type="checkbox" id="eq_plow"> Br√∏yteskj√¶r</label>
      <label><input type="checkbox" id="eq_fres"> Fres</label>
      <label><input type="checkbox" id="eq_sand"> Str√∏/sand</label>
    </div>

    <div class="toolbar">
      <button id="btnSync">‚ü≥ Hent (synk fra sky)</button>
      <button id="btnSave">üíæ Lagre til sky</button>
      <button id="btnStartRunde">üèÅ Start ny runde</button>
      <span id="syncStatus" class="muted"></span>
    </div>
  </section>

  <section class="stack">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <strong>Adresse-liste</strong>
      <div class="right muted">
        <span id="addrCount">0 adresser</span>
      </div>
    </div>
    <div id="addrList"></div>
  </section>

  <script>
    /************ Data Access (JSONBin via Worker) ************/
    const addressStore = (() => {
      const { API_BASE, BIN_ID } = window.APP_CFG;

      async function getLatest() {
        const r = await fetch(`${API_BASE}b/${BIN_ID}/latest`, { cache: 'no-store' });
        if (!r.ok) throw new Error(`GET ${r.status}`);
        const data = await r.json();
        // JSONBin v3 returnerer {record: ...} ‚Äì trekk ut record hvis finnes
        return data && data.record ? data.record : data;
      }

      async function put(payload) {
        const r = await fetch(`${API_BASE}b/${BIN_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(`PUT ${r.status}`);
        const data = await r.json();
        return data && data.record ? data.record : data;
      }

      return { getLatest, put };
    })();

    /************ App State ************/
    const UI = {
      list: document.getElementById('addrList'),
      status: document.getElementById('syncStatus'),
      driverName: document.getElementById('driverName'),
      direction: document.getElementById('direction'),
      eq: {
        plow: document.getElementById('eq_plow'),
        fres: document.getElementById('eq_fres'),
        sand: document.getElementById('eq_sand')
      },
      syncBtn: document.getElementById('btnSync'),
      saveBtn: document.getElementById('btnSave'),
      startBtn: document.getElementById('btnStartRunde'),
      roundNo: document.getElementById('roundNo'),
      appVer: document.getElementById('appVer'),
      addrCount: document.getElementById('addrCount')
    };

    const TASKS = [
      'Br√∏yte', 'Frese', 'Str√∏',
      'Br√∏yte og str√∏', 'Frese og str√∏',
      'Sn√∏ og grus + br√∏ytestikker'
    ];

    let appState = {
      version: window.APP_CFG.APP_VER,
      round: 1,
      updated: Date.now(),
      by: '',
      driver: {
        name: '',
        direction: 'Standard',
        equipment: { plow:false, fres:false, sand:false }
      },
      addresses: []
    };

    /************ LocalStorage helpers ************/
    const LS_KEY = 'broyt_v912h_prefs';
    function loadPrefs() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const p = JSON.parse(raw);
        if (p?.driver?.name) UI.driverName.value = p.driver.name;
        if (p?.driver?.direction) UI.direction.value = p.driver.direction;
        if (p?.driver?.equipment) {
          UI.eq.plow.checked = !!p.driver.equipment.plow;
          UI.eq.fres.checked = !!p.driver.equipment.fres;
          UI.eq.sand.checked = !!p.driver.equipment.sand;
        }
      } catch {}
    }
    function savePrefs() {
      const prefs = { driver: currentDriver() };
      localStorage.setItem(LS_KEY, JSON.stringify(prefs));
    }

    function currentDriver() {
      return {
        name: UI.driverName.value.trim(),
        direction: UI.direction.value,
        equipment: {
          plow: !!UI.eq.plow.checked,
          fres: !!UI.eq.fres.checked,
          sand: !!UI.eq.sand.checked
        }
      };
    }

    /************ Rendering ************/
    function renderMeta() {
      UI.roundNo.textContent = appState.round;
      UI.appVer.textContent = appState.version;
      UI.addrCount.textContent = `${appState.addresses.length} adresser`;
    }

    function renderList() {
      UI.list.innerHTML = '';
      appState.addresses.forEach((a, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.idx = idx;

        const options = TASKS.map(t => `<option ${a.task===t ? 'selected':''}>${t}</option>`).join('');
        const done = a.done ? 'checked' : '';

        const eqStr = Array.isArray(a.equipment) && a.equipment.length
          ? ` | Utstyr: ${a.equipment.join(', ')}`
          : '';

        card.innerHTML = `
          <header>
            <div>${a.name || 'Uten navn'}</div>
            <div class="right">
              <label class="muted"><input type="checkbox" data-k="done" ${done}> Ferdig</label>
            </div>
          </header>
          <div class="muted" style="margin-top:4px">Gruppe: ${a.group || '-'}${eqStr}</div>
          <div class="row" style="margin-top:8px">
            <select data-k="task">${options}</select>
            <button data-k="up">‚Üë</button>
            <button data-k="down">‚Üì</button>
            <button data-k="top">‚á§ Topp</button>
          </div>
        `;
        UI.list.appendChild(card);
      });
      renderMeta();
    }

    /************ Reorder helpers ************/
    function swap(i, j) {
      if (i<0 || j<0 || i>=appState.addresses.length || j>=appState.addresses.length) return;
      const tmp = appState.addresses[i];
      appState.addresses[i] = appState.addresses[j];
      appState.addresses[j] = tmp;
    }

    /************ Wire events ************/
    UI.list.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const card = e.target.closest('.card');
      const idx = Number(card.dataset.idx);

      if (btn.dataset.k === 'up') {
        swap(idx, idx-1);
        renderList();
      }
      if (btn.dataset.k === 'down') {
        swap(idx, idx+1);
        renderList();
      }
      if (btn.dataset.k === 'top') {
        const [item] = appState.addresses.splice(idx,1);
        appState.addresses.unshift(item);
        renderList();
      }
    });

    UI.list.addEventListener('change', (e) => {
      const card = e.target.closest('.card');
      if (!card) return;
      const idx = Number(card.dataset.idx);
      const k = e.target.dataset.k;

      if (k === 'done') {
        appState.addresses[idx].done = !!e.target.checked;
      }
      if (k === 'task') {
        appState.addresses[idx].task = e.target.value;
      }
    });

    UI.driverName.addEventListener('input', savePrefs);
    UI.direction.addEventListener('change', savePrefs);
    UI.eq.plow.addEventListener('change', savePrefs);
    UI.eq.fres.addEventListener('change', savePrefs);
    UI.eq.sand.addEventListener('change', savePrefs);

    UI.syncBtn.addEventListener('click', async () => {
      await syncFromCloud();
    });

    UI.saveBtn.addEventListener('click', async () => {
      await saveToCloud();
    });

    UI.startBtn.addEventListener('click', () => {
      appState.addresses = appState.addresses.map(a => ({ ...a, done:false }));
      appState.round = (appState.round || 0) + 1;
      appState.updated = Date.now();
      renderList();
      toast('Ny runde startet. Ferdig-status nullstilt.', true);
    });

    /************ Sync / Save ************/
    function toast(msg, ok=false) {
      UI.status.textContent = msg;
      UI.status.className = `muted ${ok ? 'ok':'err'}`;
      setTimeout(()=>{ UI.status.textContent=''; UI.status.className='muted'; }, 4000);
    }

    async function syncFromCloud() {
      try {
        UI.status.textContent = 'Henter...';
        const cloud = await addressStore.getLatest();

        // St√∏tt begge formater:
        // 1) { addresses: [...] }
        // 2) { snapshot: { addresses: [...] } }
        // 3) ren array [...]
        const addresses =
          Array.isArray(cloud) ? cloud :
          Array.isArray(cloud.addresses) ? cloud.addresses :
          (cloud.snapshot && Array.isArray(cloud.snapshot.addresses)) ? cloud.snapshot.addresses :
          [];

        // Filtrer kun aktive hvis feltet finnes
        const active = addresses.filter(a => (a.active === undefined ? true : !!a.active));

        appState.addresses = active.map(a => ({
          done: false,
          task: a.task || 'Br√∏yte',
          group: a.group || '',
          equipment: a.equipment || [],
          name: a.name || 'Uten navn'
        }));

        // Versjon hentes fra toppniv√• eller snapshot, eller fallback
        appState.version = cloud.version || (cloud.snapshot && cloud.snapshot.version) || window.APP_CFG.APP_VER;
        appState.updated = Date.now();

        renderList();
        toast('Synk OK', true);
      } catch (e) {
        console.error(e);
        toast(`Synk feilet: ${e.message}`);
      }
    }

    async function saveToCloud() {
      try {
        UI.status.textContent = 'Lagrer...';
        appState.by = (UI.driverName.value.trim() || 'driver1');
        appState.driver = currentDriver();
        appState.updated = Date.now();

        const payload = {
          version: appState.version,
          round: appState.round,
          updated: appState.updated,
          by: appState.by,
          driver: appState.driver,
          addresses: appState.addresses
        };
        await addressStore.put(payload);
        toast('Lagret til sky', true);
      } catch (e) {
        console.error(e);
        toast(`Lagring feilet: ${e.message}`);
      }
    }

    /************ Boot ************/
    (async function init(){
      loadPrefs();
      renderMeta();
      await syncFromCloud(); // hent ved start
    })();
  </script>
</body>
</html>