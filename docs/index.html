<!-- docs/index.html -->
<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Br√∏yterute ‚Äì Romerike Trefelling</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0a0f1c">
  <link rel="apple-touch-icon" href="./icons/icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="./del-B.css">
  <script defer src="./del-A.js"></script>
  <script defer src="./del-E.js"></script>

  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0a0f1c;color:#e6edf3}
    nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px;border-bottom:1px solid #2b3445;background:#0a0f1c;position:sticky;top:0;z-index:5}
    nav button{border-radius:10px;padding:8px 14px;font-size:16px;border:1px solid #3b465a;background:#182233;color:#f0f4f8}
    nav button.active{background:#1e3a8a;border-color:#60a5fa}
    main{max-width:900px;margin:auto;padding:12px}
    .card{background:#0b1220;border:1px solid #2b3445;border-radius:14px;padding:16px;margin:12px 0}
    @media(prefers-color-scheme:light){
      body{background:#fafafa;color:#111}
      nav{background:#fff;border-bottom-color:#e5e7eb}
      nav button{background:#e9eef6;color:#111;border-color:#cfd8e3}
      nav button.active{background:#007aff;border-color:#007aff;color:#fff}
      .card{background:#fff;border-color:#e5e7eb}
    }
    .install-hint{display:none;background:#1d4ed8;color:#fff;text-align:center;padding:10px;border-radius:10px;margin-top:12px;font-size:15px}
  </style>
</head>
<body>
  <nav>
    <button id="nav-home"  onclick="showPage('home')">Hjem</button>
    <button id="nav-work"  onclick="showPage('work')">Under arbeid</button>
    <button id="nav-service" onclick="showPage('service')">Service</button>
    <button id="nav-status" onclick="showPage('status')">Status</button>
    <button id="nav-admin"  onclick="showPage('admin')">Admin</button>
    <span style="margin-left:auto;font-size:12px;opacity:.7">v9.12j</span>
  </nav>

  <main>
    <!-- HJEM -->
    <section id="home" class="card">
      <h2 class="title">Hjem</h2>
      <p>Sett f√∏rer, retning og utstyr. Start runde n√•r du er klar.</p>

      <label>F√∏rer:<br>
        <input id="a_driver" placeholder="Navn" style="width:100%">
      </label><br><br>

      <label>Retning rute:<br>
        <select id="a_dir" style="width:100%">
          <option value="Normal">Normal</option>
          <option value="Motsatt">Motsatt</option>
        </select>
      </label><br><br>

      <fieldset class="card" style="margin:0">
        <legend>Utstyr</legend>
        <label><input type="checkbox" id="a_eq_plow"> Br√∏yteskj√¶r</label><br>
        <label><input type="checkbox" id="a_eq_fres"> Fres</label><br>
        <label><input type="checkbox" id="a_eq_sand"> Str√∏/sand</label>
      </fieldset>

      <label style="display:block;margin:10px 0 2px">
        <input type="checkbox" id="a_autoNav"> Auto-naviger til neste etter ¬´Ferdig¬ª
      </label>

      <br>
      <button id="a_start" class="btn btn-lg">üèÅ Start runde</button>
      <div id="installPrompt" class="install-hint">üì≤ Installer Br√∏yterute p√• Hjem-skjerm</div>
    </section>

    <!-- UNDER ARBEID -->
    <section id="work" class="card" style="display:none">
      <h2 class="title">Under arbeid</h2>

      <div class="progress-all" title="Gr√∏nn: deg ‚Ä¢ Lilla: andre sj√•f√∏rer">
        <div id="b_prog_me" class="bar bar-me" style="width:0%"></div>
        <div id="b_prog_other" class="bar bar-other" style="width:0%"></div>
      </div>

      <div class="now-stack">
        <div class="now now-wide">
          <div class="now-head"><span class="now-icon">üöú</span><span class="lbl">N√•</span></div>
          <div id="b_now" class="val now-val">‚Äì</div>
        </div>
        <div class="next now-wide">
          <div class="next-head"><span class="next-icon">‚û°Ô∏è</span><span class="lbl">Neste</span></div>
          <div id="b_next" class="val next-val">‚Äì</div>
        </div>
      </div>

      <div class="actions-grid">
        <button id="act_start" class="btn btn-lg" type="button">‚ñ∂Ô∏è Start</button>
        <button id="act_skip"  class="btn btn-lg" type="button">‚è≠Ô∏è Hopp over</button>
        <button id="act_block" class="btn btn-lg btn-warn" type="button">üö´ Ikke mulig</button>
        <button id="act_done"  class="btn btn-lg btn-affirm" type="button">‚úÖ Ferdig</button>
        <button id="act_acc"   class="btn btn-lg btn-ghost" type="button">‚ö†Ô∏è Uhell</button>
      </div>

      <p id="b_status" class="status muted">Ikke p√•begynt</p>

      <div id="work-controls" class="card" style="margin-top:14px">
        <div class="pills" style="margin-bottom:10px">
          <span class="pill">Runde: <strong id="b_round">‚Äì</strong></span>
          <span class="pill">Oppdrag: <strong id="b_job">‚Äì</strong></span>
          <span class="pill">Retning: <strong id="b_dir">‚Äì</strong></span>
          <span class="pill">Sesong: <strong id="b_season">‚Äì</strong></span>
          <span class="pill">Synk: <strong id="b_sync">‚Äî</strong></span>
        </div>
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <button id="b_nav_top"    class="btn btn-primary btn-lg" type="button">üß≠ NAVIGER</button>
          <button id="b_sync_btn"   class="btn btn-lg" type="button">‚Üª Synk</button>
          <button id="b_save_btn"   class="btn btn-lg" type="button">üíæ Lagre</button>
          <button id="b_finish_btn" class="btn btn-lg" type="button">üèÅ Avslutt runde</button>
        </div>
      </div>
    </section>

    <!-- SERVICE -->
    <section id="service" class="card" style="display:none">
      <h2 class="title">Service</h2>
      <p>Etter runden ‚Äì huk av for utf√∏rt vedlikehold:</p>
      <label><input type="checkbox"> Skj√¶r smurt</label><br>
      <label><input type="checkbox"> Fres smurt</label><br>
      <label><input type="checkbox"> Forstilling smurt</label><br>
      <label><input type="checkbox"> Oljeniv√• sjekket foran</label><br>
      <label><input type="checkbox"> Oljeniv√• sjekket bak</label><br>
      <label><input type="checkbox"> Etterfylt olje</label><br>
      <label><input type="checkbox"> Fylt diesel</label><br>
      <label><input type="checkbox"> Annet</label><br><br>
      <textarea rows="4" style="width:100%" placeholder="Notater‚Ä¶"></textarea><br>
      <button class="btn btn-lg">üíæ Lagre service</button>
    </section>

    <!-- STATUS -->
    <section id="status" class="card" style="display:none">
      <h2 class="title">Status</h2>

      <div class="row" style="gap:8px;flex-wrap:wrap;margin:6px 0 10px">
        <button id="st_reload" class="btn">‚ü≥ Oppdater</button>
        <select id="st_filter" class="btn" style="padding:8px 10px">
          <option value="alle">Vis: Alle</option>
          <option value="ikke">Ikke p√•begynt</option>
          <option value="p√•g√•r">P√•g√•r</option>
          <option value="ferdig">Ferdig</option>
          <option value="hoppet">Hoppet over</option>
          <option value="umulig">Ikke mulig</option>
          <option value="uhell">Uhell</option>
        </select>
        <span id="st_summary" class="small muted">‚Äî</span>
      </div>

      <div class="table-wrap">
        <table class="tbl" id="st_table">
          <thead>
            <tr>
              <th>#</th>
              <th>Adresse</th>
              <th>Status</th>
              <th>Start</th>
              <th>Ferdig</th>
              <th>Utf√∏rt av</th>
            </tr>
          </thead>
          <tbody id="st_tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ADMIN (samme som f√∏r) -->
    <section id="admin" class="card" style="display:none">
      <h2 class="title">Admin ‚Äì Adresse-liste</h2>

      <div class="card" style="margin-top:0">
        <h3 style="margin:0 0 8px 0">JSONBin-n√∏kkel</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="adm_key" type="password" placeholder="Lim inn X-Master-Key her"
                 style="flex:1;min-width:240px;padding:8px;border-radius:8px;border:1px solid #334155;background:#0a1422;color:#e6edf3">
          <button id="adm_key_save" class="btn btn-primary">Lagre n√∏kkel</button>
          <button id="adm_key_clear" class="btn btn-ghost">Fjern</button>
        </div>
        <div id="adm_key_status" class="small muted" style="margin-top:6px">‚Äî</div>
      </div>

      <div class="row" style="gap:8px;flex-wrap:wrap;margin:10px 0 8px">
        <button id="adm_reload" class="btn">‚ü≥ Hent fra sky</button>
        <button id="adm_save" class="btn btn-primary">üíæ Lagre</button>
        <span id="adm_status" class="small muted">‚Äî</span>
      </div>

      <div class="small muted" style="margin-bottom:8px">
        Bruk ‚¨ÜÔ∏è/‚¨áÔ∏è for rekkef√∏lge. Rediger <em>navn/gruppe/oppdrag</em> (Sn√∏ / Sn√∏ og grus). Kryss av <em>Aktiv</em>.
      </div>

      <ul id="adm_list" class="sort-list" aria-label="Adresse-rekkef√∏lge og redigering"></ul>
    </section>
  </main>

  <script>
    /* ===== Ruter ===== */
    function showPage(id){
      document.querySelectorAll('main section').forEach(s=>s.style.display='none');
      const el=document.getElementById(id); if(el) el.style.display='block';
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
      const b=document.getElementById('nav-'+id); if(b) b.classList.add('active');
      location.hash='#'+id;
      if(id==='status') loadStatus();
    }
    window.addEventListener('hashchange',()=>{
      const id=(location.hash||'#home').replace('#','');
      showPage(document.getElementById(id)?id:'home');
    });
    window.addEventListener('DOMContentLoaded',()=>{
      const id=(location.hash||'#home').replace('#','');
      showPage(document.getElementById(id)?id:'home');

      try{
        const p=JSON.parse(localStorage.getItem('BROYT_PREFS')||'{}');
        if(p.driver) document.getElementById('a_driver').value=p.driver;
        if(p.dir)    document.getElementById('a_dir').value=p.dir;
        if(p.eq){
          document.getElementById('a_eq_plow').checked=!!p.eq.plow;
          document.getElementById('a_eq_fres').checked=!!p.eq.fres;
          document.getElementById('a_eq_sand').checked=!!p.eq.sand;
        }
        if(typeof p.autoNav==='boolean') document.getElementById('a_autoNav').checked=p.autoNav;
      }catch{}
    });

    /* ===== App-state ===== */
    const S={dir:'Normal',addresses:[],idx:0,driver:'driver',autoNav:false,cloud:null};
    const STATE_LABEL={
      not_started:'Ikke p√•begynt', in_progress:'P√•g√•r', done:'Ferdig',
      skipped:'Hoppet over', blocked:'Ikke mulig', accident:'Uhell'
    };

    function fmt(t){ if(!t) return '‚Äî'; try{const d=new Date(t); return d.toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'});}catch{return '‚Äî'} }

    function uiSetWork(){
      const now=S.addresses[S.idx]||null;
      const nextIdx=(S.dir==='Motsatt')?S.idx-1:S.idx+1;
      const next=S.addresses[nextIdx]||null;

      const st = (S.cloud?.status && now?.name && S.cloud.status[now.name]?.state) || 'not_started';
      document.getElementById('b_status').textContent = STATE_LABEL[st] || '‚Äî';

      document.getElementById('b_now').textContent=now?(now.name||'‚Äì'):'‚Äì';
      document.getElementById('b_next').textContent=next?(next.name||'‚Äì'):'‚Äì';
      document.getElementById('b_dir').textContent=S.dir;
      document.getElementById('b_round').textContent=new Date().toLocaleDateString('no-NO');
      document.getElementById('b_job').textContent='Rute';
      document.getElementById('b_season').textContent=(new Date().getMonth()>=7)
        ? `${new Date().getFullYear()}-${(new Date().getFullYear()+1).toString().slice(-2)}`
        : `${new Date().getFullYear()-1}-${new Date().getFullYear().toString().slice(-2)}`;
      document.getElementById('b_sync').textContent='OK';

      // progresjon
      const activeTotal = S.addresses.length || 1;
      let meDone=0, otherDone=0;
      if (S.cloud?.status){
        for (const [k, v] of Object.entries(S.cloud.status)){
          if (v.state==='done'){
            if (v.driver===S.driver) meDone++; else otherDone++;
          }
        }
      }
      const mePct=Math.min(100, Math.round(100*meDone/activeTotal));
      const otherPct=Math.min(100, Math.round(100*otherDone/activeTotal));
      document.getElementById('b_prog_me').style.width = mePct+'%';
      document.getElementById('b_prog_other').style.width = otherPct+'%';
    }

    function nextIndex(idx,dir){ return dir==='Motsatt'?idx-1:idx+1; }
    function mapsUrlFor(addr){
      const q=addr?.name?addr.name:'';
      return 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(q+', Norge');
    }
    function goToNextAndMaybeNavigate(){
      const next=nextIndex(S.idx,S.dir);
      if(next<0||next>=S.addresses.length){ uiSetWork(); return; }
      S.idx=next; uiSetWork();
      if(S.autoNav){ const target=S.addresses[S.idx]; if(target) window.open(mapsUrlFor(target),'_blank'); }
    }

    async function refreshCloud(){
      S.cloud = await JSONBIN.getLatest();
      if(!S.cloud.status) S.cloud.status={};
    }
    async function saveCloud(){
      S.cloud.updated=Date.now();
      S.cloud.by=S.driver||'driver';
      await JSONBIN.putRecord(S.cloud);
    }

    function setStatusFor(addrName, patch){
      if(!S.cloud.status) S.cloud.status={};
      const cur=S.cloud.status[addrName]||{};
      S.cloud.status[addrName] = { ...cur, ...patch };
    }

    /* ===== Start runde ===== */
    document.getElementById('a_start').addEventListener('click',async()=>{
      try{
        const prefs={
          driver:document.getElementById('a_driver').value.trim()||'driver',
          dir:document.getElementById('a_dir').value,
          eq:{
            plow:document.getElementById('a_eq_plow').checked,
            fres:document.getElementById('a_eq_fres').checked,
            sand:document.getElementById('a_eq_sand').checked
          },
          autoNav:document.getElementById('a_autoNav').checked
        };
        localStorage.setItem('BROYT_PREFS',JSON.stringify(prefs));
        S.dir=prefs.dir; S.driver=prefs.driver; S.autoNav=prefs.autoNav;

        await JSONBIN.checkConfigOrWarn();
        // hent adresser
        const cloud=await JSONBIN.getLatest();
        S.cloud=cloud;
        const arr=(cloud?.snapshot?.addresses && Array.isArray(cloud.snapshot.addresses))
          ? cloud.snapshot.addresses
          : (Array.isArray(cloud?.addresses)?cloud.addresses:[]);
        S.addresses = (arr||[]).filter(a=>a.active!==false);

        if(!S.cloud.status) S.cloud.status={};

        S.idx=(S.dir==='Motsatt')?(S.addresses.length-1):0;
        uiSetWork();
        showPage('work');
      }catch(e){ alert('Kunne ikke starte runde: '+e.message); }
    });

    /* ===== Handling-knapper ===== */
    document.getElementById('act_start').addEventListener('click', async ()=>{
      try{
        await refreshCloud();
        const cur = S.addresses[S.idx]; if(!cur) return;
        setStatusFor(cur.name, { state:'in_progress', startedAt: Date.now(), driver: S.driver });
        await saveCloud();
        uiSetWork();
      }catch(e){ alert('Feil: '+e.message); }
    });

    document.getElementById('act_skip').addEventListener('click', async ()=>{
      try{
        await refreshCloud();
        const cur = S.addresses[S.idx]; if(!cur) return;
        setStatusFor(cur.name, { state:'skipped', finishedAt: Date.now(), driver: S.driver });
        await saveCloud();
        uiSetWork();
        goToNextAndMaybeNavigate();
      }catch(e){ alert('Feil: '+e.message); }
    });

    document.getElementById('act_block').addEventListener('click', async ()=>{
      try{
        const reason = prompt('Hvorfor ikke mulig? (valgfritt)', '') || '';
        await refreshCloud();
        const cur = S.addresses[S.idx]; if(!cur) return;
        setStatusFor(cur.name, { state:'blocked', finishedAt: Date.now(), driver: S.driver, note: reason });
        await saveCloud();
        uiSetWork();
        goToNextAndMaybeNavigate();
      }catch(e){ alert('Feil: '+e.message); }
    });

    document.getElementById('act_acc').addEventListener('click', async ()=>{
      try{
        const note = prompt('Beskriv uhell (valgfritt).', '') || '';
        await refreshCloud();
        const cur = S.addresses[S.idx]; if(!cur) return;
        setStatusFor(cur.name, { state:'accident', finishedAt: Date.now(), driver: S.driver, note });
        await saveCloud();
        uiSetWork();
        goToNextAndMaybeNavigate();
      }catch(e){ alert('Feil: '+e.message); }
    });

    document.getElementById('act_done').addEventListener('click', async ()=>{
      try{
        await refreshCloud();
        const cur = S.addresses[S.idx]; if(!cur) return;
        setStatusFor(cur.name, { state:'done', finishedAt: Date.now(), driver: S.driver });
        await saveCloud();
        uiSetWork();
        goToNextAndMaybeNavigate();
      }catch(e){ alert('Feil: '+e.message); }
    });

    document.getElementById('b_nav_top').addEventListener('click',()=>{
      const target=S.addresses[S.idx]; if(target) window.open(mapsUrlFor(target),'_blank');
    });
    document.getElementById('b_sync_btn').addEventListener('click', async ()=>{
      try{ await refreshCloud(); uiSetWork(); }catch(e){ alert('Synk-feil: '+e.message); }
    });
    document.getElementById('b_save_btn').addEventListener('click', async ()=>{
      try{ await saveCloud(); alert('Lagret.'); }catch(e){ alert('Feil: '+e.message); }
    });
    document.getElementById('b_finish_btn').addEventListener('click', ()=>{
      showPage('service');
    });

    /* ===== STATUS-SIDE ===== */
    function makeRow(idx, name, s){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${idx+1}</td>
        <td>${name}</td>
        <td>${STATE_LABEL[s?.state||'not_started']}</td>
        <td>${fmt(s?.startedAt)}</td>
        <td>${fmt(s?.finishedAt)}</td>
        <td>${s?.driver||'‚Äî'}</td>
      `;
      return tr;
    }

    async function loadStatus(){
      try{
        const cloud=await JSONBIN.getLatest();
        const raw=(cloud?.snapshot?.addresses && Array.isArray(cloud.snapshot.addresses))
          ? cloud.snapshot.addresses
          : (Array.isArray(cloud?.addresses)?cloud.addresses:[]);
        const addrs=(raw||[]).filter(a=>a.active!==false);
        const status=cloud?.status||{};

        const filter=document.getElementById('st_filter').value;
        const tbody=document.getElementById('st_tbody');
        tbody.innerHTML='';

        let cnt={tot:addrs.length, not:0, prog:0, done:0, skip:0, block:0, acc:0};
        addrs.forEach((a,i)=>{
          const s=status[a.name]||{state:'not_started'};
          if(s.state==='not_started') cnt.not++;
          else if(s.state==='in_progress') cnt.prog++;
          else if(s.state==='done') cnt.done++;
          else if(s.state==='skipped') cnt.skip++;
          else if(s.state==='blocked') cnt.block++;
          else if(s.state==='accident') cnt.acc++;

          let ok=true;
          if(filter==='ikke'  && s.state!=='not_started') ok=false;
          if(filter==='p√•g√•r' && s.state!=='in_progress') ok=false;
          if(filter==='ferdig'&& s.state!=='done') ok=false;
          if(filter==='hoppet'&& s.state!=='skipped') ok=false;
          if(filter==='umulig'&& s.state!=='blocked') ok=false;
          if(filter==='uhell' && s.state!=='accident') ok=false;
          if(ok) tbody.appendChild(makeRow(i, a.name, s));
        });

        document.getElementById('st_summary').textContent =
          `${cnt.tot} adresser ‚Ä¢ Ikke p√•begynt: ${cnt.not} ‚Ä¢ P√•g√•r: ${cnt.prog} ‚Ä¢ Ferdig: ${cnt.done} ‚Ä¢ Hoppet: ${cnt.skip} ‚Ä¢ Ikke mulig: ${cnt.block} ‚Ä¢ Uhell: ${cnt.acc}`;
      }catch(e){
        alert('Kunne ikke hente status: '+e.message);
      }
    }

    document.getElementById('st_reload').addEventListener('click', loadStatus);
    document.getElementById('st_filter').addEventListener('change', loadStatus);

    /* ===== PWA hint ===== */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt',(e)=>{
      e.preventDefault(); deferredPrompt=e;
      const btn=document.getElementById('installPrompt');
      if(btn){ btn.style.display='block'; btn.onclick=async()=>{ btn.style.display='none'; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; }; }
    });
    if(/iphone|ipad|ipod/i.test(navigator.userAgent)){
      const hint=document.getElementById('installPrompt');
      if(hint){ hint.innerHTML="üì≤ Trykk <strong>Del</strong> ‚Üí <strong>Legg til p√• Hjem-skjerm</strong>"; hint.style.display='block'; }
    }

    /* Admin ‚Äì n√∏kkel-felt (samme som f√∏r) */
    (function(){
      const inp=document.getElementById('adm_key');
      const save=document.getElementById('adm_key_save');
      const clr=document.getElementById('adm_key_clear');
      const out=document.getElementById('adm_key_status');
      function getKey(){try{return localStorage.getItem('JSONBIN_KEY')||''}catch{return''}}
      function setKey(v){if(!v||v.trim().length<10){out.textContent='Ugyldig n√∏kkel.';return}
        localStorage.setItem('JSONBIN_KEY',v.trim());out.textContent='N√∏kkel lagret.';window.dispatchEvent(new CustomEvent('broyt:key:updated'))}
      function clearKey(){localStorage.removeItem('JSONBIN_KEY');out.textContent='N√∏kkel fjernet.'}
      if(inp) inp.value=getKey();
      if(save) save.onclick=()=>setKey(inp.value);
      if(clr)  clr.onclick =()=>{clearKey();inp.value='';};
    })();
  </script>
</body>
</html>