<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Brøyterute – v9.10 (Romerike Trefelling)</title>
  <meta name="theme-color" content="#0f9d58">
  <link rel="manifest" href="manifest.json">

  <!-- (Leaflet og tegneverktøy lastes dynamisk i Del E – ingen faste <script> her) -->

  <style>
    :root{
      --bg:#111; --fg:#f5f7fa; --muted:#b9c2cc;
      --card:#181a1e; --cardBorder:#2a2f36;
      --green:#0f9d58; --blue:#0b66ff; --red:#c21d03; --gray:#2f3337;
      --purple:#7c3aed;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#fafafa; --fg:#0b0b0b; --muted:#5b6673;
             --card:#ffffff; --cardBorder:#e6e7ea; --gray:#e5e7eb; }
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{background:var(--bg);color:var(--fg)}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer}
    input,select,textarea{
      background:transparent;color:inherit;border:1px solid var(--cardBorder);
      border-radius:10px;padding:10px;font-size:16px
    }

    #app{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}

    header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#0b0b0b;color:#fff;border-bottom:1px solid #141414}
    header h1{margin:0;font-size:16px}
    .spacer{flex:1}

    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:none;border-radius:12px;padding:8px 12px;background:#25282e;color:#fff}
    .tab.active{background:var(--green)}

    .page{display:none;padding:14px}
    .page.active{display:block}

    .card{background:var(--card);border:1px solid var(--cardBorder);border-radius:16px;padding:14px}
    .stack{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px}

    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700}
    .btn-green{background:var(--green);color:#fff}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-red{background:var(--red);color:#fff}
    .btn-gray{background:var(--gray);color:#111}
    .btn-purple{background:var(--purple);color:#fff}

    .title-lg{font-size:26px;font-weight:800}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    .progress{width:100%;height:14px;border-radius:999px;background:#242830;border:1px solid var(--cardBorder);overflow:hidden}
    .progress>.bar{height:100%;width:0%;background:linear-gradient(90deg,#0f9d58,#22c55e);transition:width .25s ease}

    .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 12px;background:#0b0b0b;color:#fff;border-top:1px solid #141414;font-size:12px}

    .install{border:1px dashed #334;border-radius:12px;padding:10px;background:#15181d}

    /* Vær-widget: nå + 3 neste timer */
    .weather{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .weather .pill{border:1px solid var(--cardBorder);border-radius:999px;padding:6px 10px}
    .weather .now{font-weight:700}
    #weatherTimeline{display:flex;gap:8px;flex-wrap:wrap}
    #weatherTimeline .slot{border:1px solid var(--cardBorder);border-radius:12px;padding:6px 10px;min-width:90px}

    /* Hanske-modus */
    .hanske .btn{font-size:22px;padding:16px 20px;border-radius:18px}

    /* Service: bokser under hverandre */
    .service-list{display:flex;flex-direction:column;gap:6px}
    .service-item{display:flex;align-items:center;gap:8px}

    /* Leaflet-container (Del E) */
    #adminMap{width:100%;min-height:360px;border:1px solid var(--cardBorder);border-radius:12px;overflow:hidden}

    /* Badges */
    .badge{display:inline-block;border:1px solid var(--cardBorder);border-radius:999px;padding:2px 8px;font-size:12px}
    .badge.warn{border-color:#d97706;color:#f59e0b}

    .reset-row{margin-top:6px}
  </style>

</head>
<body>
  <div id="app">
    <!-- HEADER / NAV -->
    <header>
      <h1>Brøyterute</h1>
      <div class="spacer"></div>
      <div class="nav">
        <button class="tab active" data-tab="home">Hjem</button>
        <button class="tab" data-tab="work">Under arbeid</button>
        <button class="tab" data-tab="register">Adresse-register</button>
        <button class="tab" data-tab="admin">Admin</button>
        <button class="tab" data-tab="service">Service</button>
      </div>
    </header>

    <!-- (Del B fortsetter her med Hjem/Work/Register/Admin/Service markup) -->
    
        <!-- HJEM -->
    <div id="page-home" class="page active">
      <div class="card stack">
        <h2>Innstillinger</h2>

        <div class="row">
          <label>Rolle</label>
          <select id="role">
            <option value="driver1">Sjåfør 1</option>
            <option value="driver2">Sjåfør 2</option>
            <option value="driver3">Sjåfør 3</option>
            <option value="driver4">Sjåfør 4</option>
            <option value="admin">Admin (lese)</option>
          </select>

          <label>Retning</label>
          <select id="direction">
            <option value="forward">Vanlig</option>
            <option value="reverse">Baklengs</option>
          </select>

          <label style="display:flex;gap:6px;align-items:center">
            <input id="useCustomName" type="checkbox"> Bruk eget navn
          </label>
          <input id="customName" type="text" placeholder="Skriv navnet ditt" style="min-width:220px;display:none">

          <label><input id="bigBtn" type="checkbox"> Hanske-modus</label>
          <label><input id="autoCheck" type="checkbox" checked> Auto sjekk-inn</label>
        </div>

        <div class="row">
          <label>Tema</label>
          <select id="themeSel">
            <option value="auto">Auto (system)</option>
            <option value="dark">Mørk</option>
            <option value="light">Lys</option>
          </select>
        </div>

        <div class="row" id="syncRow" style="align-items:center;gap:8px">
          <label id="keyBlock">
            Synk-nøkkel
            <input id="apiKey" type="password" placeholder="Lim inn X-Master-Key (lokalt)">
          </label>
          <button id="saveKey" class="btn btn-blue">Lagre nøkkel</button>
          <span id="syncStatus" class="badge">Synk –</span>
          <a id="editKey" href="#" class="small" style="display:none">Endre nøkkel</a>
        </div>

        <div class="row">
          <button id="btnRoundByEquip" class="btn btn-blue">Start ny runde (etter utstyr)</button>
          <button id="btnResetAll" class="btn btn-red">Nullstill alle</button>
          <button id="btnStart" class="btn btn-green">Start runde →</button>
          <button id="btnSyncNow" class="btn btn-gray">Synk nå</button>
        </div>

        <div class="row reset-row">
          <button id="btnHardReset" class="btn btn-red">🧹 Tøm cache og start på nytt</button>
        </div>

        <div class="small muted" id="lastSyncText">—</div>
        <div class="muted" id="directionNote">—</div>
      </div>

      <!-- Installer som app -->
      <div id="installCard" class="card install" style="display:none">
        <h3>Installer som app</h3>
        <div class="small muted">For fullskjerm uten adressefelt.</div>
        <div class="row">
          <button id="btnInstall" class="btn btn-green">📲 Installer app</button>
          <button id="btnInstallHelp" class="btn btn-gray">Hvordan?</button>
        </div>
        <div id="installHelp" class="small" style="display:none">
          <p><b>iPhone (Safari)</b>: Del-ikon → <i>Legg til på Hjem-skjermen</i>.</p>
          <p><b>Android (Chrome)</b>: Meny ⋮ → <i>Installer app</i>.</p>
        </div>
      </div>

      <div class="card stack">
        <h3>Utstyr</h3>
        <div class="row">
          <label><input id="eq_plog" type="checkbox" checked> Plog</label>
          <label><input id="eq_fres" type="checkbox"> Fres</label>
          <label><input id="eq_stro" type="checkbox"> Strøkasse</label>
        </div>
      </div>
    </div>

    <!-- UNDER ARBEID -->
    <div id="page-work" class="page">
      <div class="card stack">
        <div class="row" style="align-items:center;gap:8px">
          <div id="driverLbl" class="muted">Rolle: —</div>
          <div id="directionLbl" class="badge">Retning: —</div>
          <div id="claimWarn" class="badge warn" style="display:none">⚠️ Delt retning</div>
        </div>

        <h2 id="curName" class="title-lg">—</h2>
        <div class="muted">Oppgave: <span id="curTask">—</span></div>
        <div class="muted">Brøytestikker: <span id="curPins">—</span></div>
        <div class="muted">Neste: <span id="curNext">—</span></div>

        <div class="progress-row" style="display:flex;align-items:center;gap:10px">
          <div class="muted" id="progTxt">0 % fullført (0/0)</div>
          <div class="progress" style="flex:1;min-width:160px">
            <div class="bar" id="progBar"></div>
          </div>
        </div>
        <div class="small muted" id="lastSyncTextWork">—</div>

        <div class="thumbs" id="thumbs"></div>

        <div class="row">
          <button id="ongo" class="btn btn-gray">▶️ Pågår</button>
          <button id="done" class="btn btn-green">✅ Utført</button>
          <button id="block" class="btn btn-red">⛔ Ikke mulig</button>
          <button id="photo" class="btn btn-gray">📷 Foto</button>
          <button id="nav" class="btn btn-blue">🧭 Naviger</button>
          <button id="next" class="btn btn-gray">🔁 Neste</button>
          <button id="editPins" class="btn btn-gray">📍 Brøytestikker</button>
          <button id="incident" class="btn btn-red">❗ Uhell</button>
        </div>

        <div class="row">
          <button id="goBase" class="btn btn-purple">🏠 Kjør til base</button>
          <button id="fillGravel" class="btn btn-blue">🪨 Fyll grus</button>
          <button id="fillFuel" class="btn btn-blue">⛽ Fyll drivstoff</button>
          <button id="cheapestFuel" class="btn btn-gray">💸 Finn billigste (søk)</button>
        </div>

        <!-- VÆR: nå + neste 3 timer (time for time) -->
        <div id="weatherCard" class="card">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div><b>Vær (nå + 3t, time for time)</b> <span class="small muted" id="weatherAt">–</span></div>
            <div class="small muted" id="weatherLoc">—</div>
          </div>
          <div class="weather" id="weatherRow">
            <span class="pill">Laster …</span>
          </div>
          <div id="weatherTimeline"></div>
        </div>
      </div>
    </div>

    <!-- ADRESSE-REGISTER -->
    <div id="page-register" class="page">
      <div class="card stack">
        <div class="row">
          <button id="btnCatalogPull" class="btn btn-blue">↘︎ Hent fra katalog</button>
          <button id="btnPropose" class="btn btn-gray">✍️ Foreslå endring/ny</button>
        </div>
        <div class="small muted">
          Katalogen er «felles liste». Lokale tillegg under påvirker kun din enhet (til neste publisering).
        </div>

        <div id="pinFilters" class="row">
          <button class="btn btn-gray" data-pf="all">Alle</button>
          <button class="btn btn-gray" data-pf="pending">Uten brøytestikker i år</button>
          <button class="btn btn-gray" data-pf="done">Med brøytestikker i år</button>
          <span id="pinFilterInfo" class="small muted">—</span>
        </div>
      </div>

      <div id="list"></div>

      <div class="card stack">
        <h3>Legg til ny adresse (lokalt)</h3>
        <div class="row">
          <input id="addr" type="text" placeholder="Adresse / område" style="flex:2">
          <!-- Fylles av JS basert på BROYTE_CFG.DEFAULT_TASKS -->
          <select id="taskSel" style="flex:1"></select>
        </div>

        <div class="row">
          <label style="display:flex;gap:6px;align-items:center">
            <input id="twoDriverRec" type="checkbox"> Anbefalt 2 sjåfører
          </label>
          <div style="flex:1"></div>
          <button id="add" class="btn btn-green">+ Legg til</button>
        </div>

        <div class="small muted">Tips: Enter i adressefeltet = legg til raskt.</div>
      </div>
    </div>

    <!-- ADMIN (uten kartkort – det injiseres dynamisk i Del E) -->
    <div id="page-admin" class="page">
      <div class="card stack">
        <h2>Admin</h2>
        <div class="row">
          <button id="adminSync" class="btn btn-gray">Hent status nå</button>
          <span id="adminSyncTxt" class="muted">—</span>
        </div>

        <div class="row" id="pinFiltersAdmin">
          <button class="btn btn-gray" data-pfa="all">Alle</button>
          <button class="btn btn-gray" data-pfa="pending">Uten brøytestikker i år</button>
          <button class="btn btn-gray" data-pfa="done">Med brøytestikker i år</button>
          <span id="pinFilterInfoAdmin" class="small muted">—</span>
        </div>

        <div id="adminStats" class="muted">Ingen data enda.</div>
        <div id="adminList"></div>
      </div>

      <div class="card stack">
        <h3>Katalog (felles) – rediger</h3>
        <div class="small muted">Endringer lagres til katalogen og backup tas automatisk.</div>
        <div class="row">
          <button id="catLoad" class="btn btn-gray">Last katalog</button>
          <button id="catAdd" class="btn btn-blue">➕ Legg til</button>
          <button id="catSave" class="btn btn-green">💾 Lagre katalog</button>
          <button id="catPublish" class="btn btn-blue">🚀 Publiser til MASTER</button>
          <button id="catExportCsv" class="btn btn-gray">⬇︎ Eksporter CSV</button>
        </div>
        <div id="catMsg" class="small muted">—</div>
        <div id="catList"></div>
        <div class="row">
          <button id="catRestore" class="btn btn-red">⏪ Gjenopprett fra backup</button>
        </div>
      </div>

      <div class="card stack">
        <h3>Forslag (INBOX)</h3>
        <div class="row">
          <button id="adminInbox" class="btn btn-gray">Hent forslag</button>
          <span id="adminInboxTxt" class="muted">—</span>
        </div>
        <div id="inboxList"></div>
      </div>
    </div>

    <!-- SERVICE -->
    <div id="page-service" class="page">
      <div class="card stack">
        <h2>Service / Vedlikehold</h2>
        <div class="service-list">
          <label class="service-item"><input id="svc_plog" type="checkbox"> Smurt plog</label>
          <label class="service-item"><input id="svc_fres" type="checkbox"> Smurt fres</label>
          <label class="service-item"><input id="svc_stro" type="checkbox"> Smurt strøkasse</label>
          <label class="service-item"><input id="svc_oil_front" type="checkbox"> Sjekk olje (foran)</label>
          <label class="service-item"><input id="svc_oil_back" type="checkbox"> Sjekk olje (bak)</label>
          <label class="service-item"><input id="svc_steering" type="checkbox"> Forstilling smurt</label>
          <label class="service-item"><input id="svc_other" type="checkbox"> Annet</label>
        </div>

        <textarea id="svcNotes" placeholder="Anmerkninger …" style="width:100%;min-height:120px"></textarea>

        <div class="row">
          <button id="svcSave" class="btn btn-green">📤 Lagre og del CSV</button>
          <button id="svcGuide" class="btn btn-gray">🧾 Last ned brukerark (TXT)</button>
          <button id="svcSaveHtml" class="btn btn-blue">🗂️ Lag HTML-rapport (dag)</button>
        </div>

        <div class="small muted">
          HTML-rapport inkluderer bilder, oppgaver, hvem som utførte og vær-notater som ble lagret underveis.
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      <div id="pos">—</div>
      <div>v<span id="verLbl">9.10</span> – Romerike Trefelling</div>
    </div>

    <!-- Foto-opplasting -->
    <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">
  </div>
  <!-- (Del C fortsetter her med basis-JS: state, helpers, events) -->
  
  <script>
/* ===== Del C: Konfig, state, helpers, lett UI-init ===== */

/* --- KONFIG --- */
  window.BROYTE_CFG = {
    VERSION: "9.10",
    HEARTBEAT_MS: 30000,
    BINS: {
      MASTER:    "68e774c9ae596e708f0b9977",
      CATALOG:   "68e782f3d0ea881f409ae08a",
      INBOX:     "68e7833843b1c97be95ff286",
      BACKUP:    "68e7b4d2ae596e708f0bde7d",
      REPORTS:   "68e89e3443b1c97be9611c48",
      POSITIONS: "68ed41ee43b1c97be9661c65",
      MAPLAYERS: "68ed425cae596e708f11d25f"
    },
    BASE_ADDR: "Hagavegen 8, 2072 Dal",
    GRAVEL_ADDR: "Dal pukkverk",

    /* ⬇️ NYTT: drivstoffvalg brukt i wireWork() */
    FUEL_CHOICES: [
      { name: "Driv Dal",       q: "Driv Dal avgiftsfri diesel" },
      { name: "Esso Energi Dal", q: "Esso Energi Dal avgiftsfri diesel" }
    ],

    /* Oppgavetyper (som du ønsker) */
    DEFAULT_TASKS: [
      "Snø + brøytestikker",
      "Snø og grus + brøytestikker"
    ],

    /* ⬇️ NYTT: default-nøkkel som fallback */
    DEFAULT_API_KEY: "$2a$10$DK3EUoEj/YsimWzgYG.DMOb4aEFFUiRPdJgmkOzfPQ3Jx2evIIWma"
  };

  /* Kan beholdes – men apiKey() vil nå først bruke DEFAULT_API_KEY */
  window.DEFAULT_JSONBIN_KEY = "$2a$10$DK3EUoEj/YsimWzgYG.DMOb4aEFFUiRPdJgmkOzfPQ3Jx2evIIWma";
  localStorage.setItem("broyte_api_key", window.DEFAULT_JSONBIN_KEY);

/* --- STATE --- */
const LS_KEY = "broyte_v910_state";
let state = loadState() || makeDefaultState();

function makeDefaultState(){
  return {
    role:"driver1",
    direction:"forward",
    equipment:{plog:true,fres:false,stro:false},
    autoCheck:true,
    hanske:false,
    useCustomName:false,
    customName:"",
    theme:"auto",

    stops:[],

    service:{
      plog:false, fres:false, stro:false,
      oilFront:false, oilBack:false, steering:false,
      other:false, notes:""
    },

    lastSyncAt:null,
    lastSyncBy:"",
    ui:{ pinFilter:"all", adminPinFilter:"all", cursor:0 },
    lastActiveAt:Date.now(),
    dayLog:{ dateKey:dateKey(new Date()), entries:[] }
  };
}

/* --- STORAGE + API HEADERS --- */
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||""); }catch{ return null; } }
function apiKey(){
  return localStorage.getItem("broyte_api_key")
      || window.BROYTE_CFG.DEFAULT_API_KEY
      || window.DEFAULT_JSONBIN_KEY
      || "";
}
function headers(){ return {"Content-Type":"application/json","X-Master-Key": apiKey()}; }

/* --- HELPERS --- */
const $ = id => document.getElementById(id);
const esc = s => String(s ?? "");
const fmtTime = ts => ts ? new Date(ts).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",second:"2-digit"}) : "—";
const fmtDT   = ts => ts ? new Date(ts).toLocaleString("no-NO") : "—";

function displayName(){
  return state.useCustomName && state.customName ? state.customName : (state.role || "Sjåfør");
}
function dateKey(d){ return d.toISOString().slice(0,10); }
function seasonKey(){
  const d=new Date(), y=d.getFullYear(), m=d.getMonth()+1;
  return m>=7 ? `${y}/${(y+1).toString().slice(-2)}` : `${y-1}/${y.toString().slice(-2)}`;
}
function touchActivity(){ state.lastActiveAt = Date.now(); save(); }
function applyTheme(mode){ document.documentElement.dataset.theme = mode; }

function idxList(){
  const rem = state.stops.map((s,i)=>({i,s})).filter(x=>!x.s.f && !x.s.b).map(x=>x.i);
  return state.direction==="forward" ? rem : rem.slice().reverse();
}
function cur(){
  const l = idxList();
  const c = (state.ui?.cursor ?? 0);
  if (!l.length) return null;
  const pos = Math.min(c, l.length - 1);
  return state.stops[l[pos]];
}
function curIndex(){
  const l = idxList();
  const c = (state.ui?.cursor ?? 0);
  if (!l.length) return -1;
  const pos = Math.min(c, l.length - 1);
  return l[pos];
}
function nxt(){
  const l = idxList();
  const c = (state.ui?.cursor ?? 0);
  if (l.length <= c + 1) return null;
  return state.stops[l[c+1]];
}
function prog(){
  const total=state.stops.length;
  const done=state.stops.filter(s=>s.f).length;
  const blocked=state.stops.filter(s=>s.b).length;
  const cleared=done+blocked;
  const pct = total? Math.round(100*cleared/total):0;
  return {total,done,blocked,cleared,pct};
}

function navTo(address){ if(!address) return; location.href = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(address); }
function mapsSearch(q){ location.href="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(q); }

/* Geo footer (lett) */
function initGeolocation(){
  const posEl = $("pos"); if(!posEl) return;
  if(!navigator.geolocation){ posEl.textContent="Posisjon ikke tilgjengelig"; return; }
  const fmt=n=>Number.isFinite(n)?n.toFixed(5):"—";
  navigator.geolocation.watchPosition(
    (p)=>{ const {latitude,longitude,accuracy}=p.coords||{}; posEl.textContent = `${fmt(latitude)}, ${fmt(longitude)} (±${Math.round(accuracy||0)} m)`; },
    ()=>{ posEl.textContent = "Posisjon utilgjengelig"; },
    { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
  );
}

/* Førstegangs default-adresser */
function bootDefaults(){
  if(!Array.isArray(state.stops)) state.stops=[];
  if(state.stops.length===0){
    const T = window.BROYTE_CFG.DEFAULT_TASKS;
    state.stops = [
      { n:"AMFI Eidsvoll (Råholt)", t:T[0], f:false, b:false, p:[], twoDriverRec:false, pinsCount:0, pinsLockedYear:null },
      { n:"Råholt barneskole",      t:T[1], f:false, b:false, p:[], twoDriverRec:true,  pinsCount:0, pinsLockedYear:null },
      { n:"Råholt ungdomsskole",    t:T[0], f:false, b:false, p:[], twoDriverRec:false, pinsCount:0, pinsLockedYear:null }
    ];
    save();
  }
}

/* --- Eksporter helpers til senere deler --- */
window.BroyteHelpers = {
  $, save, loadState, apiKey, headers, esc, fmtTime, fmtDT,
  displayName, dateKey, seasonKey, touchActivity, applyTheme,
  idxList, cur, curIndex, nxt, prog, navTo, mapsSearch,
  initGeolocation, bootDefaults
};

/* --- Lett UI-init + tabs --- */
document.addEventListener("DOMContentLoaded", ()=>{
  // Tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      const page = document.getElementById("page-"+btn.dataset.tab);
      if (page) page.classList.add("active");

      // Kall renderer hvis senere deler har satt de
      if (btn.dataset.tab==="work"     && window.BroyteWork?.renderWork)     window.BroyteWork.renderWork();
      if (btn.dataset.tab==="register" && window.BroyteWork?.renderRegister) window.BroyteWork.renderRegister();
      if (btn.dataset.tab==="admin"    && window.BroyteWork?.renderAdmin)    window.BroyteWork.renderAdmin();
    });
  });

  // Fyll inn standardverdier
  $("role").value = state.role;
  $("direction").value = state.direction;
  $("eq_plog").checked = !!state.equipment.plog;
  $("eq_fres").checked = !!state.equipment.fres;
  $("eq_stro").checked = !!state.equipment.stro;
  $("autoCheck").checked = !!state.autoCheck;
  document.body.classList.toggle("hanske", !!state.hanske);
  $("useCustomName").checked = !!state.useCustomName;
  $("customName").value = state.customName || "";
  $("customName").style.display = state.useCustomName ? "block" : "none";
  $("themeSel").value = state.theme || "auto";
  applyTheme(state.theme||"auto");

  // Oppgave-valg i "Legg til"
  const taskSel = $("taskSel");
  if (taskSel){
    taskSel.innerHTML = window.BROYTE_CFG.DEFAULT_TASKS.map(t=>`<option>${esc(t)}</option>`).join("");
  }

  // Endringshandlere (lagrer state + oppdaterer UI)
  $("role").onchange = ()=>{ state.role=$("role").value; save(); window.BroyteWork?.renderWork?.(); };
  $("direction").onchange = ()=>{
  state.direction = $("direction").value;
  state.ui = state.ui || {};
  state.ui.cursor = 0;
  save();
  window.BroyteWork?.renderWork?.();
};
  $("bigBtn").onchange = ()=>{ state.hanske=$("bigBtn").checked; document.body.classList.toggle("hanske",state.hanske); save(); };
  $("autoCheck").onchange = ()=>{ state.autoCheck=$("autoCheck").checked; save(); };
  $("useCustomName").onchange = ()=>{
    state.useCustomName=$("useCustomName").checked;
    $("customName").style.display=state.useCustomName?"block":"none"; save(); window.BroyteWork?.renderWork?.();
  };
  $("customName").addEventListener("input", ()=>{ state.customName=$("customName").value.trim(); save(); window.BroyteWork?.renderWork?.(); });
  $("themeSel").onchange = ()=>{ state.theme=$("themeSel").value; save(); applyTheme(state.theme); };
  ["eq_plog","eq_fres","eq_stro"].forEach(id=>{
    $(id).onchange = ()=>{
      state.equipment = { plog:$("eq_plog").checked, fres:$("eq_fres").checked, stro:$("eq_stro").checked };
      save();
    };
  });

  // Knapper som ikke krever senere deler
  $("btnStart").onclick = ()=> document.querySelector('.tab[data-tab="work"]')?.click();

  // Synk-knapper (virker når Del D er lastet)
  $("btnSyncNow").onclick   = ()=> window.BroyteSync?.syncPull?.().then(()=>window.BroyteSync?.syncPush?.());
  $("btnResetAll").onclick  = ()=> {
    if(!confirm("Nullstille ALLE adresser?")) return;
    state.stops.forEach(s=>{ s.f=false; s.b=false; s.started=null; s.finished=null; });
state.ui = state.ui || {};
state.ui.cursor = 0;
save(); window.BroyteWork?.renderWork?.(); window.BroyteWork?.renderRegister?.();
window.BroyteSync?.syncPush?.();
  };
  $("btnRoundByEquip").onclick = ()=> {
    if(!confirm("Nullstille status for adresser som matcher valgt utstyr?")) return;
    state.stops.forEach(s=>{
      const t=s.t||"";
      const needSnow=/Snø/.test(t), needGrus=/grus/.test(t);
      const ok = (!needSnow || state.equipment.plog || state.equipment.fres) &&
                 (!needGrus || state.equipment.stro);
      if(ok){ s.f=false; s.b=false; s.started=null; s.finished=null; }
});
state.ui = state.ui || {};
state.ui.cursor = 0;
save(); window.BroyteWork?.renderWork?.(); window.BroyteWork?.renderRegister?.();
window.BroyteSync?.syncPush?.();
  };

  // 

  // Footer geolokasjon
  initGeolocation();

  // Defaults + første render
  bootDefaults();
  window.BroyteWork?.renderRegister?.();
  window.BroyteWork?.renderWork?.();

  // Oppdatér versjon i footer
  const footerVer = document.querySelector('.footer div:last-child');
  if (footerVer) footerVer.textContent = `v${window.BROYTE_CFG.VERSION} – Romerike Trefelling`;
});

/* --- Dev-feilbanner (myk) --- */
window.addEventListener('error', (ev) => {
  try{
    const bar = document.createElement('div');
    bar.style.cssText = 'position:fixed;left:0;right:0;bottom:0;background:#b00020;color:#fff;padding:8px 12px;font:12px system-ui;z-index:99999';
    bar.textContent = 'JS-feil: ' + (ev.message || 'ukjent') + (ev.filename ? ' @ ' + ev.filename + ':' + ev.lineno : '');
    document.body.appendChild(bar);
    console.error('JS error', ev);
  }catch(_){}
});
</script>

<script>
/* ===== Del D: Synk, vær, foto, logging, live-posisjon ===== */
(() => {
  const CFG = window.BROYTE_CFG;
  const H = window.BroyteHelpers;
  const { $, save, apiKey, headers, esc, fmtTime, fmtDT,
          displayName, dateKey, seasonKey, touchActivity,
          idxList, cur, curIndex, nxt, prog, navTo, mapsSearch } = H;
/* === START DELTA A: merge-hjelpere (flersjåfør) === */
function keyOf(s){ return (s?.n||'').trim().toLowerCase(); }
function hasPinsThisSeason(s){ return s?.pinsLockedYear && String(s.pinsLockedYear)===seasonKey(); }

function mergeStops(remoteArr, localArr){
  const map = new Map();
  const clone = obj => JSON.parse(JSON.stringify(obj||{}));
  const season = seasonKey();

  const addAll = (arr) => (arr||[]).forEach(s=>{
    const k = keyOf(s);
    const cur = map.get(k);
    if(!cur){
      // første versjon inn
      map.set(k, clone(s));
    }else{
      // flett med eksisterende
      const m = cur, a = s;
      m.n = m.n || a.n;         // navn
      m.t = m.t || a.t;         // oppgave
      // status: utført/ikke mulig – OR
      m.f = !!(m.f || a.f);
      m.b = !!(m.b || a.b);
      // tider: earliest start, latest finish
      const minStart = Math.min(m.started ?? Infinity, a.started ?? Infinity);
      m.started  = Number.isFinite(minStart) ? minStart : null;
      const maxFin = Math.max(m.finished || 0, a.finished || 0);
      m.finished = maxFin || null;
      // bilder: union
      const pset = new Set([...(m.p||[]), ...(a.p||[])]);
      m.p = Array.from(pset);
      // detaljer: behold lengste tekst
      if ((a.details||"").length > (m.details||"").length) m.details = a.details;
      // 2 sjåfører: true hvis noen har det
      m.twoDriverRec = !!(m.twoDriverRec || a.twoDriverRec);
      // 📍 brøytestikker: lås bare første gang i aktuell sesong
      const mThis = String(m.pinsLockedYear) === season;
      const aThis = String(a.pinsLockedYear) === season;
      if (!mThis && aThis){
        m.pinsLockedYear = a.pinsLockedYear;
        m.pinsCount = a.pinsCount || 0;
      }
      if (m.pinsCount == null) m.pinsCount = 0;
    }
  });

  addAll(remoteArr||[]);
  addAll(localArr||[]);

  return Array.from(map.values());
}
/* === END DELTA A === */

  /* ---------- SYNC MASTER ---------- */
  async function syncPull(){
    try{
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MASTER}/latest`,{headers:headers()});
      const js = await r.json();
      if(js?.record?.stops){
        const norm = s=>({
          n:s.n, t:s.t,
          f:!!s.f, b:!!s.b,
          p:Array.isArray(s.p)?s.p:[],
          started:s.started||null, finished:s.finished||null,
          details:s.details||"",
          twoDriverRec:!!s.twoDriverRec,
          pinsCount:s.pinsCount||0,
          pinsLockedYear:s.pinsLockedYear||null
        });
        state.stops = js.record.stops.map(norm);
        state.lastSyncAt = js.record.lastSyncAt||Date.now();
        state.lastSyncBy = js.record.lastSyncBy||displayName();
        save(); renderWork(); renderRegister(); renderAdmin();
        $("syncStatus").textContent = "Synk – Pull OK";
        hideKeyRow();
      }else{
        $("syncStatus").textContent = "Synk – Tom";
      }
    }catch(e){
      $("syncStatus").textContent = "Synk – FEIL";
      showKeyRow();
    }
  }
  /* === START DELTA B: syncPush med fletting (flersjåfør) === */
async function syncPush(){
  try{
    // 1) Trekk ned siste MASTER
    const latest = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MASTER}/latest`, { headers: headers() }).then(r=>r.json()).catch(()=>null);
    const remoteStops = latest?.record?.stops || [];

    // 2) Flett remote + local
    const merged = mergeStops(remoteStops, state.stops);

    // 3) Skyv opp flettet resultat
    const payload = {
      version: CFG.VERSION,
      updated: Date.now(),
      lastSyncAt: Date.now(),
      lastSyncBy: displayName(),
      stops: merged,
      meta:{ role: state.role, direction: state.direction }
    };
    const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MASTER}`, {
      method: "PUT", headers: headers(), body: JSON.stringify(payload)
    });
    if(!r.ok) throw 0;

    // 4) Lokalt: overta flettet
    state.stops = merged;
    state.lastSyncAt = payload.lastSyncAt;
    state.lastSyncBy = payload.lastSyncBy;
    save();
    renderWork(); renderRegister(); renderAdmin();
    $("syncStatus").textContent = "Synk – Push OK";
    hideKeyRow();
  }catch(e){
    $("syncStatus").textContent = "Synk – Push FEIL";
    showKeyRow();
  }
}
/* === END DELTA B === */

  /* ---------- KATALOG ---------- */
  async function catalogPull(){
    try{
      $("pinFilterInfo").textContent="Henter katalog …";
			const r=await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.CATALOG}/latest`, { headers: headers() });
      const js=await r.json();
      const cat=js?.record?.addresses||[];
      const active=cat.filter(a=>a?.active!==false);
      const stops=active.map(a=>({
        n:a.name||"",
        t:a.task||CFG.DEFAULT_TASKS[0],
        f:false,b:false,p:[],
        twoDriverRec:!!a.twoDriverRec,
        pinsCount:0,pinsLockedYear:null
      }));
      if(!stops.length) return alert("Ingen aktive adresser i katalogen.");
      state.stops = stops;
state.ui = state.ui || {};
state.ui.cursor = 0;
save(); renderRegister(); renderWork();
      await syncPush();
      $("pinFilterInfo").textContent=`Katalog hentet (${stops.length})`;
    }catch(e){ alert("Feil ved kataloghenting."); $("pinFilterInfo").textContent="Feil ved henting."; }
  }

  /* ---------- FORSLAG ---------- */

async function loadInbox(){
  try{
    const js = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.INBOX}/latest`, { headers: headers() }).then(r=>r.json());
    const props = js?.record?.proposals || [];
    const el = $("inboxList");
    if (el){
      el.innerHTML = props.slice(-50).reverse().map(p=>`
        <div class="item">
          <b>${(p.type||'add').toUpperCase()}</b> – fra ${esc(p.from||'?')} – ${new Date(p.ts).toLocaleString('no-NO')}<br>
          <span class="muted">${esc(p.payload?.name||'')} ${esc(p.payload?.task||'')}</span>
        </div>`).join("");
    }
    const c = $("adminInboxTxt"); if (c) c.textContent = `Forslag: ${props.length}`;
  }catch(e){
    const c = $("adminInboxTxt"); if (c) c.textContent = "Feil ved henting.";
  }
}

/* ---------- Eksporter ---------- */
Object.assign(window.BroyteSync || (window.BroyteSync = {}), { loadInbox });
  async function sendProposal(obj){
    try{
      const latest=await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.INBOX}/latest`,{headers:headers()}).then(r=>r.json());
      const rec=latest?.record||{version:CFG.VERSION,updated:0,proposals:[]};
      rec.proposals=rec.proposals||[];
      rec.proposals.push({id:Math.random().toString(36).slice(2),from:displayName(),payload:obj,ts:Date.now()});
      rec.updated=Date.now();
      await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.INBOX}`,{method:"PUT",headers:headers(),body:JSON.stringify(rec)});
      alert("Forslag sendt 👍");
    }catch(e){ alert("Kunne ikke sende forslag."); }
  }

  /* ---------- VÆR (nå + 3t) ---------- */
  async function refreshWeather(){
    try{
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude:lat,longitude:lon}=pos.coords||{};
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation&hourly=temperature_2m,precipitation&forecast_days=1&timezone=auto`;
        const js=await fetch(url).then(r=>r.json());
        const nowT=js?.current?.temperature_2m??null;
        const nowP=js?.current?.precipitation??0;
        const times=js?.hourly?.time||[],temps=js?.hourly?.temperature_2m||[],precs=js?.hourly?.precipitation||[];
        const nowISO=new Date().toISOString().slice(0,13);
        const idx=Math.max(0,times.findIndex(t=>t.startsWith(nowISO)));
        const horizon=[idx+1,idx+2,idx+3].filter(i=>i<times.length);
        const pillNow=`<span class="pill now">Nå: ${Math.round(nowT)}°C · ${nowP.toFixed(1)} mm</span>`;
        const pills=horizon.map(i=>{
          const t=new Date(times[i]);
          const hh=t.toLocaleTimeString('no-NO',{hour:'2-digit'});
          const tp=temps[i],pr=precs[i]||0;
          return `<span class="pill">${hh}: ${Math.round(tp)}°C · ${pr.toFixed(1)} mm${pr>0?" (snø)":""}</span>`;
        }).join("");
        $("weatherRow").innerHTML=pillNow+pills;
        $("weatherAt").textContent=new Date().toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'});
        $("weatherLoc").textContent=`${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      });
    }catch(_){}
  }

  /* ---------- RENDER ---------- */
  function hasPinsThisSeason(s){ return s.pinsLockedYear && String(s.pinsLockedYear)===seasonKey(); }
  function renderWork(){
    const c=cur(),n=nxt(),p=prog();
    $("driverLbl").textContent="Rolle: "+displayName();
    $("directionLbl").textContent="Retning: "+(state.direction==="forward"?"Vanlig":"Baklengs");
    $("curName").textContent=c?esc(c.n):"—";
    $("curTask").textContent=c?esc(c.t):"—";
    const nextEl = $("curNext");
if (nextEl) nextEl.textContent = n ? esc(n.n) : "—";
    $("curPins").textContent = c ? (c.pinsLockedYear ? (c.pinsCount ?? 0) : "—") : "—";
    $("thumbs").innerHTML=c?.p?.length?c.p.map(src=>`<img src="${src}" style="width:80px">`).join(""):"";
    $("progBar").style.width=p.pct+"%";
    $("progTxt").textContent=`${p.pct}% fullført (${p.cleared}/${p.total})`;
    $("lastSyncTextWork").textContent=`Sist synk: ${fmtTime(state.lastSyncAt)} (${state.lastSyncBy||"—"})`;
    refreshWeather();
  }
  
function renderRegister(){
  const pf = state.ui?.pinFilter || "all";

  // Sett aktiv knapp ut fra lagret filter
  document.querySelectorAll("#pinFilters .btn").forEach(b=>{
    const on = (b.dataset.pf === pf);
    b.classList.toggle("btn-green", on);
  });

  // Filtrer rader
  let rows = state.stops.slice();
  if (pf === "pending") rows = rows.filter(s=>!hasPinsThisSeason(s));
  if (pf === "done")    rows = rows.filter(hasPinsThisSeason);

  // Info-tekst
  const all  = state.stops.length;
  const pend = state.stops.filter(s=>!hasPinsThisSeason(s)).length;
  const done = all - pend;
  const info = document.getElementById("pinFilterInfo");
  if (info) info.textContent =
    pf==="all"     ? `Alle: ${all}`
  : pf==="pending" ? `Uten brøytestikker i år: ${pend}`
                   : `Med brøytestikker i år: ${done}`;

  // Render liste
  document.getElementById("list").innerHTML = rows.map(s=>`
    <div class="item">
      <b>${esc(s.n)}</b> ${s.twoDriverRec?`<span class="badge">👥 2 sjåfører</span>`:""}
      ${s.pinsLockedYear?`<span class="badge">📍${s.pinsCount??0}</span>`:""}
      <br><span class="muted">${esc(s.t)}</span> ${s.f?"✅":""}${s.b?"⛔":""}
    </div>`).join("");
}

function renderAdmin(){
  const af = state.ui?.adminPinFilter || "all";

  // Sett aktiv knapp ut fra lagret filter
  document.querySelectorAll("#pinFiltersAdmin .btn").forEach(b=>{
    const on = (b.dataset.pfa === af);
    b.classList.toggle("btn-green", on);
  });

  // Filtrer rader
  let rows = state.stops.slice();
  if (af === "pending") rows = rows.filter(s=>!hasPinsThisSeason(s));
  if (af === "done")    rows = rows.filter(hasPinsThisSeason);

  // Stats + info
  const total   = state.stops.length;
  const cleared = state.stops.filter(s=>s.f || s.b).length;
  const pct     = total ? Math.round(100 * cleared / total) : 0;
  const pend    = state.stops.filter(s=>!hasPinsThisSeason(s)).length;
  const done    = total - pend;

  const adminStats = $("adminStats");
  if (adminStats) adminStats.innerHTML = `Totalt ${total} – ${pct}% fullført`;

  const infoA = $("pinFilterInfoAdmin");
  if (infoA) infoA.textContent =
    af==="all"     ? `Alle: ${total}`
  : af==="pending" ? `Uten brøytestikker i år: ${pend}`
                   : `Med brøytestikker i år: ${done}`;

  // Render liste
  const adminList = $("adminList");
  if (adminList) adminList.innerHTML = rows.map(s=>`
    <div class="item">
      <b>${esc(s.n)}</b>${s.twoDriverRec?`<span class="badge">👥</span>`:""}
      ${s.pinsLockedYear?`<span class="badge">📍${s.pinsCount??0}</span>`:""}
      <br><span class="muted">${esc(s.t)}</span>
    </div>`).join("");
}
  /* ---------- FOTO / LOGG ---------- */
  function onPhotoChosen(e){
    const f=e.target.files?.[0]; if(!f)return;
    const r=new FileReader();
    r.onload=()=>{ const c=cur(); if(!c)return; (c.p||(c.p=[])).push(r.result); save(); renderWork(); syncPush(); };
    r.readAsDataURL(f); e.target.value="";
  }

  /* === START DELTA C: doneHandler med sesonglås for brøytestikker === */
function doneHandler(){
  touchActivity();
  const c = cur(); if(!c) return;

  // Kun spørre om pinner hvis oppgaven inneholder "brøytestikker"
  // OG vi ikke allerede har låst for inneværende sesong
  if (/brøytestikker/i.test(c.t)) {
    const alreadyThisSeason = c.pinsLockedYear && String(c.pinsLockedYear) === seasonKey();
    if (!alreadyThisSeason) {
      const v = prompt("Antall brøytestikker brukt (låses for sesongen):", "");
      if (v === null) return; // avbrutt
      const n = parseInt((v||"").trim() || "0", 10) || 0;
      c.pinsCount = n;
      c.pinsLockedYear = seasonKey(); // LÅS for sesongen
    }
  }

  c.f = true;
  c.finished = Date.now();
  save();
  renderWork();
  syncPush();
  const n = nxt(); if (n) navTo(n.n);
}
/* === END DELTA C === */
  function blockHandler(){
    const c=cur(); if(!c)return;
    const note=prompt("Hvorfor ikke mulig?","")||""; c.details=note; c.b=true; save(); renderWork(); syncPush();
  }
  function nextHandler(){
  const l = idxList();
  const c = (state.ui?.cursor ?? 0);
  if (l.length === 0) return;
  if (c < l.length - 1) {
    state.ui = state.ui || {};
    state.ui.cursor = c + 1;   // hopp videre, ikke rør status
    save();
    renderWork();
    const now = cur();
    if (now) navTo(now.n);
  } else {
    alert("Ingen flere adresser å hoppe til.");
  }
}
  function incidentHandler(){ const c=cur(); prompt("Uhell registrert ved "+(c?.n||"ukjent")+". Kort beskrivelse:",""); alert("Uhell logget."); }

  /* ---------- LIVE POSISJON ---------- */
  function startLivePosition(){
    if(!navigator.geolocation)return;
    navigator.geolocation.watchPosition(async p=>{
      try{
        const recKey="positions";
        const latest=await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.POSITIONS}/latest`,{headers:headers()}).then(r=>r.json()).catch(()=>({record:{positions:[]}}));
        const rec=latest?.record||{positions:[]};
        const key=displayName()+'|'+(state.role||'driver');
        const entry={key,actor:displayName(),role:state.role,pos:{lat:p.coords.latitude,lon:p.coords.longitude,acc:p.coords.accuracy||null},ts:Date.now()};
        const idx=rec.positions.findIndex(x=>x.key===key);
        if(idx>=0)rec.positions[idx]=entry;else rec.positions.push(entry);
        await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.POSITIONS}`,{method:"PUT",headers:headers(),body:JSON.stringify(rec)});
      }catch(_){}
    },()=>{}, {enableHighAccuracy:true,timeout:10000});
  }

  /* ---------- Eksporter ---------- */
  Object.assign(window.BroyteSync || (window.BroyteSync = {}), { syncPull, syncPush, catalogPull, sendProposal });
  window.BroyteWeather= {refreshWeather};
  window.BroyteWork   = {renderWork,renderRegister,renderAdmin,onPhotoChosen,doneHandler,blockHandler,nextHandler,incidentHandler};
  window.BroyteLive   = {startLivePosition};

})();
</script>

<script>
/* ===== Del E: Admin-kart (Leaflet), tegning, lagring til JSONBin, live-pos ===== */
(() => {
  const CFG = window.BROYTE_CFG;
  const H   = window.BroyteHelpers;
  const { $, headers, displayName } = H;

  /* ---------- Last Leaflet dynamisk om nødvendig ---------- */
  function ensureLeaflet(){
    return new Promise((resolve,reject)=>{
      if (window.L && L.map) return resolve();
      const css = document.createElement('link');
      css.rel = 'stylesheet';
      css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      const js  = document.createElement('script');
      js.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      js.onload = resolve; js.onerror = reject;
      document.head.appendChild(css); document.head.appendChild(js);
    });
  }

  /* ---------- Hjelpere ---------- */
  function asLatLngArr(coords){ return (coords||[]).map(x=>[x.lat, x.lon]); }
  function toCoords(latlngs){
    return latlngs.map(p=>{
      const a = Array.isArray(p) ? {lat:p[0], lng:p[1]} : p;
      return {lat:a.lat, lon:a.lng};
    });
  }

  /* ---------- JSONBin: kartlag + posisjoner ---------- */
  async function loadLayers(){
    try{
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MAPLAYERS}/latest`, { headers: headers() });
      const js = await r.json();
      return js?.record || {layers:[], updated:0};
    }catch(_){ return {layers:[], updated:0}; }
  }
  async function saveLayers(record){
    const rec = { version: CFG.VERSION, updated: Date.now(), by: displayName(), layers: record.layers||[] };
    await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MAPLAYERS}`, { method:'PUT', headers: headers(), body: JSON.stringify(rec) });
    return rec;
  }
  async function fetchPositions(){
    try{
      const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.POSITIONS}/latest`, { headers: headers() });
      const js = await r.json();
      return js?.record?.positions || [];
    }catch(_){ return []; }
  }

  /* ---------- Tegne-UI (lettvekts) ---------- */
  function setMode(ctx, mode){
    ctx.mode = mode; // 'point' | 'line' | 'poly' | null
    $('#mapStatus') && ($('#mapStatus').textContent = mode ? `Tegnemodus: ${mode}` : '—');
    if (ctx._preview){ ctx.layerUser.removeLayer(ctx._preview); ctx._preview=null; }
    ctx._seed=null;
  }
  function finishCurrent(ctx){
    if (!ctx._seed || !ctx._seed.length) { setMode(ctx,null); return; }
    if (ctx.mode === 'line'){
      const pl = L.polyline(ctx._seed,{weight:4}).addTo(ctx.layerUser);
      pl.on('click', ()=> selectShape(ctx, pl));
      ctx.shapes.push({type:'polyline', ref:pl});
    }else if (ctx.mode === 'poly'){
      const pg = L.polygon(ctx._seed,{weight:4, fillOpacity:.2}).addTo(ctx.layerUser);
      pg.on('click', ()=> selectShape(ctx, pg));
      ctx.shapes.push({type:'polygon', ref:pg});
    }
    if (ctx._preview){ ctx.layerUser.removeLayer(ctx._preview); ctx._preview=null; }
    ctx._seed=null; setMode(ctx,null);
  }
  function selectShape(ctx, layer){
    try{ ctx.selected?.setStyle?.({weight:4}); }catch{}
    ctx.selected = layer;
    try{ layer.setStyle?.({weight:7}); setTimeout(()=>layer.setStyle?.({weight:4}), 180); }catch{}
  }
  function deleteSelected(ctx){
    if (!ctx.selected) return;
    const i = ctx.shapes.findIndex(s=>s.ref===ctx.selected);
    if (i>=0) ctx.shapes.splice(i,1);
    ctx.layerUser.removeLayer(ctx.selected);
    ctx.selected = null;
  }

  function attachDrawHandlers(ctx){
    const { map } = ctx;
    map.on('click', (e)=>{
      if (ctx.mode === 'point'){
        const m = L.marker(e.latlng, {draggable:true}).addTo(ctx.layerUser);
        m.on('click', ()=> selectShape(ctx, m));
        ctx.shapes.push({type:'marker', ref:m});
      }
      if (ctx.mode === 'line'){
        ctx._seed = ctx._seed || [];
        ctx._seed.push(e.latlng);
        if (!ctx._preview){
          ctx._preview = L.polyline(ctx._seed,{dashArray:'4 6'}).addTo(ctx.layerUser);
          ctx._preview.on('click', ()=> selectShape(ctx, ctx._preview));
        }else{
          ctx._preview.setLatLngs(ctx._seed);
        }
      }
      if (ctx.mode === 'poly'){
        ctx._seed = ctx._seed || [];
        ctx._seed.push(e.latlng);
        if (!ctx._preview){
          ctx._preview = L.polygon(ctx._seed,{dashArray:'4 6', fillOpacity:.1}).addTo(ctx.layerUser);
          ctx._preview.on('click', ()=> selectShape(ctx, ctx._preview));
        }else{
          ctx._preview.setLatLngs(ctx._seed);
        }
      }
    });
    map.on('dblclick', ()=> finishCurrent(ctx));
  }

  /* ---------- Import/Export til/fra kart ---------- */
  function loadLayersToMap(ctx, record){
    ctx.layerDB.clearLayers();
    (record.layers||[]).forEach(l=>{
      if (l.type==='marker'){
        const m = L.marker([l.coords[0]?.lat, l.coords[0]?.lon]).addTo(ctx.layerDB);
        if (l.name) m.bindTooltip(l.name);
      }else if (l.type==='polyline'){
        const pl = L.polyline(asLatLngArr(l.coords), {weight:4}).addTo(ctx.layerDB);
        if (l.name) pl.bindTooltip(l.name);
      }else if (l.type==='polygon'){
        const pg = L.polygon(asLatLngArr(l.coords), {weight:4, fillOpacity:.2}).addTo(ctx.layerDB);
        if (l.name) pg.bindTooltip(l.name);
      }
    });
  }
  function collectAllShapes(ctx){
    const out = [];
    // behold eksisterende lag (DB)
    ctx.layerDB.eachLayer(layer=>{
      if (layer instanceof L.Marker){
        const ll = layer.getLatLng();
        out.push({type:'marker', coords:[{lat:ll.lat, lon:ll.lng}]});
      }else if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)){
        out.push({type:'polyline', coords: toCoords(layer.getLatLngs())});
      }else if (layer instanceof L.Polygon){
        const ring = layer.getLatLngs()[0] || [];
        out.push({type:'polygon', coords: toCoords(ring)});
      }
    });
    // nye (User)
    ctx.shapes.forEach(s=>{
      if (s.type==='marker'){
        const ll = s.ref.getLatLng();
        out.push({type:'marker', coords:[{lat:ll.lat, lon:ll.lng}]});
      }else if (s.type==='polyline'){
        out.push({type:'polyline', coords: toCoords(s.ref.getLatLngs())});
      }else if (s.type==='polygon'){
        out.push({type:'polygon', coords: toCoords(s.ref.getLatLngs()[0]||[])});
      }
    });
    return out;
  }

  /* ---------- Live-posisjoner ---------- */
  function paintPositions(ctx, arr){
    ctx.layerPos.clearLayers();
    arr.forEach(p=>{
      if(!p?.pos) return;
      const m = L.circleMarker([p.pos.lat, p.pos.lon], {radius:6, weight:2});
      m.addTo(ctx.layerPos);
      const who = p.actor || p.key || 'Sjåfør';
      const acc = p.pos.acc ? ` (±${Math.round(p.pos.acc)} m)` : '';
      m.bindTooltip(`${who}${acc}`);
    });
  }

  /* ---------- Init Admin-kart når fanen åpnes ---------- */
  async function initAdminMap(){
    await ensureLeaflet();

    // Hvis indeksen allerede har et #adminMap: bruk denne. Hvis ikke, bygg kort.
    let mapHost = $('#adminMap');
    if (!mapHost){
      const adminPage = $('#page-admin');
      if (!adminPage) return;
      const card = document.createElement('div');
      card.className = 'card stack';
      card.innerHTML = `
        <h3>Kart (Admin)</h3>
        <div class="small muted">Se live-posisjon og tegn ruter/soner. Lagres i «Maplayers».</div>
        <div class="row" style="gap:8px;align-items:center">
          <button id="mapBtnReload" class="btn btn-gray">⟳ Last lag</button>
          <button id="mapBtnDrawPt" class="btn btn-blue">✏️ Punkt</button>
          <button id="mapBtnDrawLine" class="btn btn-blue">〰️ Linje</button>
          <button id="mapBtnDrawPoly" class="btn btn-blue">⬛ Område</button>
          <button id="mapBtnFinish" class="btn btn-gray">✔︎ Fullfør</button>
          <button id="mapBtnCancel" class="btn btn-gray">↩︎ Avbryt</button>
          <button id="mapBtnDeleteSel" class="btn btn-red">🗑 Slett valgt</button>
          <button id="mapBtnSave" class="btn btn-green">💾 Lagre lag</button>
          <span id="mapStatus" class="small muted">—</span>
        </div>
        <div id="adminMap" style="width:100%;height:480px;border:1px solid var(--cardBorder);border-radius:12px;overflow:hidden"></div>
      `;
      adminPage.insertBefore(card, adminPage.firstChild);
      mapHost = $('#adminMap');
    }

    const map = L.map(mapHost, { doubleClickZoom:false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'&copy; OpenStreetMap'}).addTo(map);
    map.setView([60.268, 11.198], 12); // Dal / Romerike

    const layerDB  = L.layerGroup().addTo(map);
    const layerUser= L.layerGroup().addTo(map);
    const layerPos = L.layerGroup().addTo(map);
    const ctx = { map, layerDB, layerUser, layerPos, shapes:[], selected:null, mode:null, _seed:null, _preview:null };

    attachDrawHandlers(ctx);

    // Knapper
    $('#mapBtnReload') && ($('#mapBtnReload').onclick = async ()=>{
      $('#mapStatus').textContent = 'Laster lag …';
      const rec = await loadLayers();
      loadLayersToMap(ctx, rec);
      $('#mapStatus').textContent = `Lastet ${rec.layers?.length||0} elementer.`;
    });
    $('#mapBtnDrawPt')   && ($('#mapBtnDrawPt').onclick   = ()=> setMode(ctx,'point'));
    $('#mapBtnDrawLine') && ($('#mapBtnDrawLine').onclick = ()=> setMode(ctx,'line'));
    $('#mapBtnDrawPoly') && ($('#mapBtnDrawPoly').onclick = ()=> setMode(ctx,'poly'));
    $('#mapBtnFinish')   && ($('#mapBtnFinish').onclick   = ()=> finishCurrent(ctx));
    $('#mapBtnCancel')   && ($('#mapBtnCancel').onclick   = ()=> setMode(ctx,null));
    $('#mapBtnDeleteSel')&& ($('#mapBtnDeleteSel').onclick= ()=> deleteSelected(ctx));
    $('#mapBtnSave')     && ($('#mapBtnSave').onclick     = async ()=>{
      try{
        $('#mapStatus').textContent = 'Lagrer …';
        const layers = collectAllShapes(ctx);
        const rec = await saveLayers({layers});
        // «kommitter» user-lag til DB-lag
        layerUser.clearLayers(); ctx.shapes = [];
        loadLayersToMap(ctx, rec);
        $('#mapStatus').textContent = `Lagret ${rec.layers.length} elementer ✔︎`;
      }catch(_){
        $('#mapStatus').textContent = 'Feil ved lagring (sjekk nøkkel).';
      }
    });

    // Første last
    $('#mapBtnReload') && $('#mapBtnReload').click();

    // Live-pos oppdatering
    async function refreshPos(){
      const arr = await fetchPositions();
      paintPositions(ctx, arr);
    }
    refreshPos();
    setInterval(refreshPos, 15000);

    // Zoom til egen pos (om tillatt)
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>{
        map.setView([p.coords.latitude, p.coords.longitude], 13);
      }, ()=>{}, {enableHighAccuracy:true, timeout:8000, maximumAge:60000});
    }

    // Eksponér for senere bruk / debugging
    window.__BroyteAdminMap = ctx;
  }

  /* ---------- Auto-init når Admin-tab klikkes ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    const adminTab = document.querySelector('.tab[data-tab="admin"]');
    if (!adminTab) return;
    adminTab.addEventListener('click', ()=>{
      // init én gang pr last
      if (!window.__BroyteAdminMap) initAdminMap();
    });
  });

  // Eksporter
  window.BroyteMapUI = { initAdminMap };

})();
</script>

<script>
/* ===== Del F: Oppstart, PWA, fanenavigasjon, knappebindinger, heartbeat ===== */
(() => {
  const CFG = window.BROYTE_CFG;
  const H   = window.BroyteHelpers;
  const SY  = window.BroyteSync;
  const WV  = window.BroyteWeather;
  const WK  = window.BroyteWork;
  const LV  = window.BroyteLive;

  const {
    $, save, bootDefaults, applyTheme, initGeolocation,
    displayName, fmtTime
  } = H;

  /* ---------- PWA-registrering ---------- */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    });
  }

  /* ---------- Hard reset (cache + localStorage) ---------- */
  async function hardReset(){
    if(!confirm('Tømme all lokal data og laste siden på nytt?')) return;
    const keepKey = localStorage.getItem('broyte_api_key') || '';
    try{
      localStorage.clear();
      if (keepKey) localStorage.setItem('broyte_api_key', keepKey);
      if ('caches' in window) {
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }
      if (navigator.serviceWorker?.getRegistrations) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
    }catch(_){}
    location.reload(true);
  }

  /* ---------- Heartbeat (push synk + live posisjon) ---------- */
  function startHeartbeat(){
    setInterval(async ()=>{ try{ await SY.syncPush(); }catch(_){/* ignorer */} }, CFG.HEARTBEAT_MS);
    LV.startLivePosition();
  }

  /* ---------- Enkle helpers ---------- */
  function populateTaskSelect(){
    const sel = $('taskSel');
    if (!sel) return;
    sel.innerHTML = CFG.DEFAULT_TASKS.map(t => `<option>${t}</option>`).join('');
  }
  function updateSyncLabels(){
    const t1 = $('lastSyncText');
    const t2 = $('lastSyncTextWork');
    if (t1) t1.textContent = `Sist synk: ${fmtTime(state.lastSyncAt)} (${state.lastSyncBy||'—'})`;
    if (t2) t2.textContent = `Sist synk: ${fmtTime(state.lastSyncAt)} (${state.lastSyncBy||'—'})`;
  }

  /* ---------- Faner ---------- */
  function setupTabs(){
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        const page = document.getElementById('page-' + btn.dataset.tab);
        if (page) page.classList.add('active');

        if (btn.dataset.tab === 'work')      { WK.renderWork(); }
        if (btn.dataset.tab === 'register')  { WK.renderRegister(); }
        if (btn.dataset.tab === 'admin')     { WK.renderAdmin(); /* kart init skjer i Del E */ }
      });
    });
  }

  /* ---------- Installer-banner (lett) ---------- */
  function setupInstallBanner(){
    const card = $('installCard');
    if (!card) return;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isStandalone) return;

    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; card.style.display = 'block';
    });

    $('btnInstall') && ($('btnInstall').onclick = async ()=>{
      if (deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; card.style.display='none'; deferredPrompt=null; }
      else { const h=$('installHelp'); if(h) h.style.display='block'; }
    });
    $('btnInstallHelp') && ($('btnInstallHelp').onclick = ()=>{
      const h = $('installHelp'); if(!h) return;
      h.style.display = h.style.display==='none' ? 'block' : 'none';
    });
  }

  /* ---------- Knapper / Inputs ---------- */
  function wireHome(){
    // init verdier
    $('role')         && ($('role').value = state.role);
    $('direction')    && ($('direction').value = state.direction);
    $('eq_plog')      && ($('eq_plog').checked = !!state.equipment.plog);
    $('eq_fres')      && ($('eq_fres').checked = !!state.equipment.fres);
    $('eq_stro')      && ($('eq_stro').checked = !!state.equipment.stro);
    $('autoCheck')    && ($('autoCheck').checked = !!state.autoCheck);
    $('bigBtn')       && (document.body.classList.toggle('hanske', !!state.hanske), $('bigBtn').checked = !!state.hanske);
    $('useCustomName')&& ($('useCustomName').checked = !!state.useCustomName);
    $('customName')   && (($('customName').value = state.customName||''), $('customName').style.display = state.useCustomName?'block':'none');
    $('themeSel')     && ($('themeSel').value = state.theme || 'auto');

    // endringer
    $('role')      && ($('role').onchange      = ()=>{ state.role=$('role').value; save(); WK.renderWork(); });
    $('direction') && ($('direction').onchange = ()=>{ state.direction=$('direction').value; save(); WK.renderWork(); });
    $('eq_plog')   && ($('eq_plog').onchange   = ()=>{ state.equipment.plog=$('eq_plog').checked; save(); });
    $('eq_fres')   && ($('eq_fres').onchange   = ()=>{ state.equipment.fres=$('eq_fres').checked; save(); });
    $('eq_stro')   && ($('eq_stro').onchange   = ()=>{ state.equipment.stro=$('eq_stro').checked; save(); });
    $('autoCheck') && ($('autoCheck').onchange = ()=>{ state.autoCheck=$('autoCheck').checked; save(); });
    $('bigBtn')    && ($('bigBtn').onchange    = ()=>{ state.hanske=$('bigBtn').checked; document.body.classList.toggle('hanske', state.hanske); save(); });
    $('useCustomName') && ($('useCustomName').onchange = ()=>{
      state.useCustomName = $('useCustomName').checked;
      const cn = $('customName'); if (cn) cn.style.display = state.useCustomName?'block':'none';
      save(); WK.renderWork();
    });
    $('customName') && ($('customName').addEventListener('input', ()=>{
      state.customName = $('customName').value.trim(); save(); WK.renderWork();
    }));
    $('themeSel')  && ($('themeSel').onchange = ()=>{ state.theme=$('themeSel').value; applyTheme(state.theme); save(); });

    // synk-nøkkel
    $('saveKey') && ($('saveKey').onclick = ()=>{
      const key = ($('apiKey')?.value || '').trim();
      if (!key) return alert('Lim inn nøkkel først');
      localStorage.setItem('broyte_api_key', key);
      if ($('apiKey')) $('apiKey').value='';
      if ($('syncStatus')) $('syncStatus').textContent = 'Synk – nøkkel lagret ✅';
      const kb=$('keyBlock'), sk=$('saveKey'), ek=$('editKey'); if(kb) kb.style.display='none'; if(sk) sk.style.display='none'; if(ek) ek.style.display='inline';
    });
    $('editKey') && ($('editKey').onclick = (e)=>{ e.preventDefault(); const kb=$('keyBlock'), sk=$('saveKey'), ek=$('editKey'); if(kb) kb.style.display='inline-block'; if(sk) sk.style.display='inline-block'; if(ek) ek.style.display='none'; });

    // hovedknapper
    $('btnStart')    && ($('btnStart').onclick    = ()=> document.querySelector('.tab[data-tab="work"]')?.click());
    $('btnSyncNow')  && ($('btnSyncNow').onclick  = ()=> SY.syncPull().then(()=>SY.syncPush()));
    $('btnResetAll') && ($('btnResetAll').onclick = ()=>{
      if(!confirm('Nullstille ALLE adresser?')) return;
      (state.stops||[]).forEach(s=>{ s.f=false; s.b=false; s.started=null; s.finished=null; });
state.ui = state.ui || {};
state.ui.cursor = 0;
save(); WK.renderWork(); WK.renderRegister(); SY.syncPush();
    });
    $('btnRoundByEquip') && ($('btnRoundByEquip').onclick = ()=>{
      if(!confirm('Nullstille status for adresser som matcher valgt utstyr?')) return;
      (state.stops||[]).forEach(s=>{
        const t=s.t||'';
        const needSnow=/Snø/i.test(t), needGrus=/grus/i.test(t);
        const ok = (!needSnow || state.equipment.plog || state.equipment.fres) && (!needGrus || state.equipment.stro);
        if (ok){ s.f=false; s.b=false; s.started=null; s.finished=null; }
      });
      save(); WK.renderWork(); WK.renderRegister(); SY.syncPush();
    });

    // hard reset
    $('btnHardReset') && ($('btnHardReset').onclick = hardReset);

    // install banner
    setupInstallBanner();

    // initial sync-tekst
    updateSyncLabels();
  }

  function wireWork(){
    $('ongo')   && ($('ongo').onclick   = ()=>{ const c = window.BroyteHelpers.cur(); if(!c) return; c.started = c.started || Date.now(); save(); WK.renderWork(); SY.syncPush(); /* 2 sjåfører prompt håndteres i D */ });
    $('done')   && ($('done').onclick   = WK.doneHandler);
    $('block')  && ($('block').onclick  = WK.blockHandler);
    $('next')   && ($('next').onclick   = WK.nextHandler);
      // Manuell endring av brøytestikker
  /* === START DELTA C: editPins låst én gang per sesong === */
$('editPins') && ($('editPins').onclick = ()=>{
  const c = window.BroyteHelpers.cur(); if (!c) return;

  const locked = c.pinsLockedYear && String(c.pinsLockedYear) === window.BroyteHelpers.seasonKey();
  if (locked) {
    alert("Brøytestikker er allerede registrert for inneværende sesong og er låst.");
    return;
  }

  const curVal = Number.isFinite(c.pinsCount) ? c.pinsCount : 0;
  const v = prompt("Antall brøytestikker brukt (låses for sesongen):", String(curVal));
  if (v === null) return; // avbrutt
  const n = parseInt((v||"").trim() || "0", 10) || 0;
  c.pinsCount = n;
  c.pinsLockedYear = window.BroyteHelpers.seasonKey(); // LÅS for sesongen
  save();
  window.BroyteWork.renderWork();
  window.BroyteSync?.syncPush?.();
});
/* === END DELTA C === */
    $('nav')    && ($('nav').onclick    = ()=>{ const c=window.BroyteHelpers.cur(); if(c) window.BroyteHelpers.navTo(c.n); });
    $('photo')  && ($('photo').onclick  = ()=> $('fileInput')?.click());
    $('fileInput') && ($('fileInput').onchange = WK.onPhotoChosen);
    $('incident') && ($('incident').onclick = WK.incidentHandler);

    // hurtigvalg
    $('goBase')      && ($('goBase').onclick      = ()=> window.BroyteHelpers.navTo(CFG.BASE_ADDR));
    $('fillGravel')  && ($('fillGravel').onclick  = ()=> window.BroyteHelpers.navTo(CFG.GRAVEL_ADDR));
    $('fillFuel')    && ($('fillFuel').onclick    = ()=>{
      const choice = prompt("Velg stasjon: 1) Driv Dal  2) Esso Energi Dal  3) Avbryt","1");
      if(choice==="1") window.BroyteHelpers.mapsSearch(CFG.FUEL_CHOICES[0].q);
      else if(choice==="2") window.BroyteHelpers.mapsSearch(CFG.FUEL_CHOICES[1].q);
    });
    $('cheapestFuel')&& ($('cheapestFuel').onclick= ()=> window.BroyteHelpers.mapsSearch('avgiftsfri diesel Dal'));
  }

  function wireRegister(){
    $('btnCatalogPull') && ($('btnCatalogPull').onclick = SY.catalogPull);
    $('btnPropose')     && ($('btnPropose').onclick     = ()=>{
      const name = prompt("Navn (adresse/område):"); if(!name) return;
      const task = (prompt("Oppgave:", CFG.DEFAULT_TASKS[0]) || CFG.DEFAULT_TASKS[0]);
      SY.sendProposal({type:"add", name, task, group:""});
    });

    $('add') && ($('add').onclick = ()=>{
      const addr = $('addr')?.value.trim(); if(!addr) return;
      const task = $('taskSel')?.value || CFG.DEFAULT_TASKS[0];
      const twoDriver = $('twoDriverRec')?.checked || false;
      (state.stops ||= []).push({ n:addr, t:task, f:false, b:false, p:[], started:null, finished:null, details:"", twoDriverRec:twoDriver, pinsCount:0, pinsLockedYear:null });
      $('addr').value = ''; if ($('twoDriverRec')) $('twoDriverRec').checked = false;
      save(); WK.renderRegister(); SY.syncPush();
    });
    $('addr') && ($('addr').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('add').click(); } }));
  }
// Filter-knapper (Register)
document.querySelectorAll('#pinFilters .btn').forEach(btn=>{
  btn.onclick = ()=>{
    state.ui.pinFilter = btn.dataset.pf || 'all';
    save();
    WK.renderRegister();
  };
});
  function wireAdmin(){
    $('adminSync')    && ($('adminSync').onclick    = ()=> WK.renderAdmin());
    $('catLoad')      && ($('catLoad').onclick      = window.loadCatalog && window.loadCatalog);
    $('catAdd')       && ($('catAdd').onclick       = window.editCatalogRow ? ()=> window.editCatalogRow(null) : null);
    $('catSave')      && ($('catSave').onclick      = window.saveCatalogWithBackup || null);
    $('catPublish')   && ($('catPublish').onclick   = window.publishCatalogToMaster || null);
    $('catExportCsv') && ($('catExportCsv').onclick = window.exportCatalogCsv || null);
    $('catRestore')   && ($('catRestore').onclick   = window.restoreCatalogFromBackup || null);
    $('adminInbox')   && ($('adminInbox').onclick   = SY.loadInbox);
  }
// Filter-knapper (Admin)
document.querySelectorAll('#pinFiltersAdmin .btn').forEach(btn=>{
  btn.onclick = ()=>{
    state.ui.adminPinFilter = btn.dataset.pfa || 'all';
    save();
    WK.renderAdmin();
  };
});

  function wireService(){
    $('svcSave')     && ($('svcSave').onclick     = window.saveServiceReportCsv || null);
    $('svcGuide')    && ($('svcGuide').onclick    = window.downloadGuideTxt || null);
    $('svcSaveHtml') && ($('svcSaveHtml').onclick = window.saveDayHtmlReport || null);
  }

  /* ---------- Oppstart ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      // defaults + UI
      bootDefaults();
      applyTheme(state.theme || 'auto');
      populateTaskSelect();
      setupTabs();
      setupInstallBanner();

      // wire alle deler
      wireHome();
      wireWork();
      wireRegister();
      wireAdmin();
      wireService();

      // footer posisjon
      initGeolocation();

      // første render
      WK.renderWork();
      WK.renderRegister();
      WK.renderAdmin();

      // start vær + heartbeat
      WV.refreshWeather();
      startHeartbeat();

      // versjon i footer
      const footerVer = document.querySelector('.footer div:last-child');
      if (footerVer) footerVer.textContent = `v${CFG.VERSION} – Romerike Trefelling`;

      console.log('%cBrøyterute v' + CFG.VERSION + ' klar', 'color:lime');
    }catch(err){
      console.error('Init-feil:', err);
      alert('Feil under oppstart: ' + err.message);
    }
  });
})();
</script>

<script>
/* ===== Del G: Katalog-editor (Admin) ===== */
(() => {
  const CFG = window.BROYTE_CFG;
  const H   = window.BroyteHelpers;
  const { $, headers, esc, displayName } = H;

  let CAT = { addresses: [], updated: 0, version: CFG.VERSION };

function renderCatList(){
  const host = $('catList');
  if (!host) return;
  if (!CAT.addresses.length){
    host.innerHTML = '<div class="small muted">– tom katalog –</div>';
    return;
  }

  const taskSelect = (val, idx) =>
    `<select data-k="task" data-i="${idx}" style="flex:1">
      ${CFG.DEFAULT_TASKS.map(t => `<option value="${esc(t)}" ${val===t?'selected':''}>${esc(t)}</option>`).join('')}
    </select>`;

host.innerHTML = CAT.addresses.map((a,idx)=>`
  <div class="item" style="padding:8px 0;border-bottom:1px solid var(--cardBorder)">
    <div class="row" style="align-items:center">
      <input data-k="name"  data-i="${idx}" value="${esc(a.name||'')}" placeholder="Navn/adresse" style="flex:2">
      ${taskSelect(a.task || CFG.DEFAULT_TASKS[0], idx)}
      <label class="small"><input data-k="twoDriverRec" data-i="${idx}" type="checkbox" ${a.twoDriverRec?'checked':''}> 2 sjåfører</label>
      <label class="small"><input data-k="active" data-i="${idx}" type="checkbox" ${a.active===false?'':'checked'}> Aktiv</label>

      <label class="small">
        📍 <input data-k="pinsCount" data-i="${idx}" type="number" value="${(a.pinsCount ?? 0)}" min="0" style="width:70px"> stk
      </label>

      <button data-up="${idx}"   class="btn btn-gray small">⬆️</button>
      <button data-down="${idx}" class="btn btn-gray small">⬇️</button>
      <button data-del="${idx}"  class="btn btn-red small">Slett</button>
    </div>
  </div>
`).join('');

  // Inputs/checkboxer
	host.querySelectorAll('input[data-k]').forEach(el=>{
  el.oninput = ()=>{
    const i = +el.dataset.i, k = el.dataset.k;
    if (k === 'twoDriverRec' || k === 'active'){
      CAT.addresses[i][k] = (k==='active') ? el.checked : !!el.checked;
      if (k==='active' && el.checked) CAT.addresses[i].active = true;
    } else if (k === 'pinsCount'){
      CAT.addresses[i][k] = parseInt(el.value || "0", 10);
    } else {
      CAT.addresses[i][k] = el.value;
    }
  };
  if (el.type==='checkbox') el.onchange = el.oninput;
});

  // Select (oppgave)
  host.querySelectorAll('select[data-k="task"]').forEach(sel=>{
    sel.onchange = ()=> {
      const i = +sel.dataset.i;
      CAT.addresses[i].task = sel.value;
    };
  });

  // Slett-knapper
  host.querySelectorAll('button[data-del]').forEach(btn=>{
  btn.onclick = ()=>{
    const i = +btn.dataset.del;
    CAT.addresses.splice(i,1);
    renderCatList();
  };
});

// Flytt opp
host.querySelectorAll('button[data-up]').forEach(btn=>{
  btn.onclick = ()=>{
    const i = +btn.dataset.up;
    if (i <= 0) return;
    const tmp = CAT.addresses[i];
    CAT.addresses[i] = CAT.addresses[i-1];
    CAT.addresses[i-1] = tmp;
    renderCatList();
  };
});

// Flytt ned
host.querySelectorAll('button[data-down]').forEach(btn=>{
  btn.onclick = ()=>{
    const i = +btn.dataset.down;
    if (i >= CAT.addresses.length-1) return;
    const tmp = CAT.addresses[i];
    CAT.addresses[i] = CAT.addresses[i+1];
    CAT.addresses[i+1] = tmp;
    renderCatList();
  };
});

  const msg = $('catMsg');
  if (msg) msg.textContent = `Rader: ${CAT.addresses.length}`;
}
      
      
  function editCatalogRow(){
    CAT.addresses.push({ name:'', task: CFG.DEFAULT_TASKS[0], active:true, twoDriverRec:false });
    renderCatList();
  }

  async function saveCatalogWithBackup(){
    try{
      $('catMsg').textContent = 'Lagrer (med backup) …';
      // 1) Ta enkel backup (overskriv hele BACKUP med snapshot)
      const backup = { version: CFG.VERSION, updated: Date.now(), by: displayName(), snapshot: CAT };
      await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.BACKUP}`, {
        method:'PUT', headers: headers(), body: JSON.stringify(backup)
      });

      // 2) Lagre katalog
      const rec = { version: CFG.VERSION, updated: Date.now(), by: displayName(), addresses: CAT.addresses };
      await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.CATALOG}`, {
        method:'PUT', headers: headers(), body: JSON.stringify(rec)
      });
      $('catMsg').textContent = 'Katalog lagret ✔︎';
    }catch(e){
      $('catMsg').textContent = 'Feil ved lagring (sjekk nøkkel).';
    }
  }

  async function publishCatalogToMaster(){
    try{
      $('catMsg').textContent = 'Publiserer til MASTER …';
      const active = CAT.addresses.filter(a=>a?.active!==false);
      const nowSeason = window.BroyteHelpers.seasonKey();
const stops = active.map(a=>({
  n: a.name || '',
  t: a.task || CFG.DEFAULT_TASKS[0],
  f: false, b: false, p: [],
  twoDriverRec: !!a.twoDriverRec,
  pinsCount: Number.isFinite(a.pinsCount) ? a.pinsCount : 0,
  pinsLockedYear: (Number.isFinite(a.pinsCount) && a.pinsCount > 0) ? nowSeason : null
}));
      const payload = {
        version: CFG.VERSION,
        updated: Date.now(),
        lastSyncAt: Date.now(),
        lastSyncBy: displayName(),
        stops,
        meta: { from: 'catalog' }
      };
      await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.MASTER}`, {
        method:'PUT', headers: headers(), body: JSON.stringify(payload)
      });
      $('catMsg').textContent = `Publisert ${stops.length} adresser til MASTER ✔︎`;
    }catch(e){
      $('catMsg').textContent = 'Feil ved publisering (sjekk nøkkel).';
    }
  }

  function exportCatalogCsv(){
    const rows = [['name','task','active','twoDriverRec']].concat(
      (CAT.addresses||[]).map(a=>[
        (a.name||'').replaceAll('"','""'),
        (a.task||'').replaceAll('"','""'),
        (a.active===false?0:1),
        (a.twoDriverRec?1:0)
      ])
    );
    const csv = rows.map(r=>r.map(x=>`"${x}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'katalog.csv';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  // Eksponer til knappene som allerede er wired i Del F
async function loadCatalog(){
  try{
    $('catMsg').textContent = 'Laster katalog …';
    const r = await fetch(`https://api.jsonbin.io/v3/b/${CFG.BINS.CATALOG}/latest`, { headers: headers() });
    const js = await r.json();
    CAT = js?.record || { addresses: [], version: CFG.VERSION, updated: 0 };
    CAT.addresses = Array.isArray(CAT.addresses) ? CAT.addresses : [];
    $('catMsg').textContent = `Lastet ${CAT.addresses.length} adresser`;
    renderCatList();
  }catch(e){
    $('catMsg').textContent = 'Feil ved lasting (sjekk nøkkel).';
  }
}
  window.loadCatalog = loadCatalog;
  window.editCatalogRow = editCatalogRow;
  window.saveCatalogWithBackup = saveCatalogWithBackup;
  window.publishCatalogToMaster = publishCatalogToMaster;
  window.exportCatalogCsv = exportCatalogCsv;
  // (restore kan komme senere)
})();
</script>