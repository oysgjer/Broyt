<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"> <title>Br√∏yterute ‚Äì V8.1 Lokal</title> <meta name="theme-color" content="#0f9d58"> <link rel="manifest" href="manifest.json"> <link rel="apple-touch-icon" href="icons/icon-192.png"> <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""> <style>  :root{ --btnH:48px; --pad:10px; }  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f7f7f9; color:#111; }  #app { min-height:100%; display:grid; grid-template-rows:auto auto 1fr auto; }  header { background:#111; color:#fff; padding:10px 12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }  header h1 { font-size:16px; margin:0; }  .subtitle { font-size:12px; opacity:.8; }  .tabs { display:flex; gap:6px; margin-left:auto; }  .tab { background:#2a2a2a; color:#fff; border:none; border-radius:10px; height:34px; padding:0 10px; }  .tab.active { background:#0f9d58; }  .topbar { background:#fff; padding:8px 12px; display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center; border-bottom:1px solid #e6e6e6; }  .topbar input[type="text"], .topbar select { height:42px; border-radius:10px; border:1px solid #ccc; padding:0 10px; font-size:16px; }  .btn { height:42px; border:none; border-radius:10px; padding:0 10px; font-size:15px; }  .btn.primary { background:#0f9d58; color:#fff; }  .btn.blue { background:#0061fe; color:#fff; }  .btn.red { background:#c21d03; color:#fff; }  .btn.gray { background:#eee; color:#111; border:1px solid #ccc; }  .btn.small { height:34px; font-size:13px; }  .bar { background:#fff; padding:8px 12px; display:flex; gap:8px; align-items:center; border-bottom:1px solid #e6e6e6; flex-wrap:wrap; }  .bar .spacer { flex:1 }
 /* Layout: p√• mobil er det EN kolonne, kart under lista */  .content { display:grid; grid-template-columns:1fr; }  #listWrap { padding:8px 12px; }  #mapWrap { border-top:1px solid #eee; }  #map { width:100%; height:320px; }
 /* Tabell: smal mobilvisning */
 table { width:100%; border-collapse:collapse; background:#fff; table-layout: fixed; }  th, td { border-bottom:1px solid #eee; padding:8px 6px; vertical-align:middle; }  th.seq, td.seq { width: 40px; text-align:center; font-weight:700; }  th.name, td.name { width:auto; word-break:break-word; }  th.task, td.task { width:140px; }  th.det, td.det { width:160px; }  th.sta, td.sta { width:74px; }  th.act, td.act { width:260px; }  .rowbtns { display:flex; gap:6px; flex-wrap:wrap; }  .footer { background:#111; color:#fff; padding:8px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }  .badge { padding:3px 8px; border-radius:999px; font-size:12px; display:inline-block; }  .b-green { background:#d4edda; color:#155724; }  .b-yellow{ background:#fff3cd; color:#856404; }  .b-red{ background:#f8d7da; color:#721c24; }  .b-blue{ background:#e1f0ff; color:#084298; }  .modalBg { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:10; }  .modal { background:#fff; border-radius:12px; width:min(640px,92vw); padding:14px; }  .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }  .row label { display:flex; align-items:center; gap:8px; background:#f7f7f7; border:1px solid #eee; border-radius:10px; padding:8px 10px; }  textarea, input[type="text"] { width:100%; min-height:44px; border:1px solid #ccc; border-radius:10px; padding:8px 10px; }  .small { font-size: 12px; color:#666; }  .chips { display:flex; gap:6px; flex-wrap:wrap; margin:8px 12px; }  .chip { background:#f1f1f1; border:1px solid #ddd; border-radius:16px; padding:4px 8px; font-size:12px; }  .thumbs { display:flex; gap:4px; flex-wrap:wrap; margin-top:4px; }  .thumbs img { width:36px; height:36px; object-fit:cover; border-radius:6px; border:1px solid #ddd; }  .muted { color:#888; }  @media (min-width: 920px){
   .content { grid-template-columns: 1fr 420px; }
   #map { height: calc(100vh - 280px); }
   #mapWrap { border-left:1px solid #eee; border-top:none; }  } </style> </head> <body> <div id="app">  <header>
   <div>
     <h1>Br√∏yterute</h1>
     <div class="subtitle" id="roundInfo">Runde 1 ‚Äì Startet ‚Ä¶</div>
   </div>
   <div class="tabs">
     <button class="tab active" data-tab="route">Rute</button>
     <button class="tab" data-tab="reports" disabled>Rapporter</button>
   </div>
 </header>

 <div class="topbar">
   <input id="addr" type="text" placeholder="Adresse/omr√•de (f.eks. Dal stasjon)">
   <select id="taskSel">
     <option>Br√∏yte</option>
     <option>Frese</option>
     <option>Str√∏</option>
     <option>Br√∏yte og str√∏</option>
     <option>Frese og str√∏</option>
     <option>Br√∏ytestikker</option>
   </select>
   <button id="addBtn" class="btn primary">Legg til</button>  </div>

 <div class="bar">
   <button id="optBtn" class="btn gray">Optimaliser</button>
   <button id="fitAllBtn" class="btn gray">Vis alle p√• kart</button>
   <div class="spacer"></div>
   <button id="exportBtn" class="btn gray">Eksporter rute</button>
   <button id="importBtn" class="btn gray">Importer rute</button>
   <button id="doneBtn" class="btn primary">Ferdig (runde)</button>  </div>

 <div class="content">
   <div id="listWrap">
     <table id="tbl">
       <thead>
         <tr>
           <th class="seq">#</th><th class="name">Navn</th><th class="task">Oppgave</th>
           <th class="det">Detaljer</th><th class="sta">Status</th><th class="act">Handling</th>
         </tr>
       </thead>
       <tbody></tbody>
     </table>
     <div class="chips">
       <span class="chip">Tips: Bruk ‚Äúüì∑ Foto‚Äù p√• raden for √• dokumentere.</span>
       <span class="chip">Status ‚ÄúP√•g√•r‚Äù registrerer starttid.</span>
     </div>
   </div>
   <div id="mapWrap">
     <div id="map" aria-label="Kart"></div>
   </div>
 </div>

 <div class="footer">
   <div>Live posisjon: <span id="posTxt">‚Äî</span></div>
   <div>Neste: <span id="nextTxt">‚Äî</span> <span class="muted">| Versjon 8.1 ‚Äì Lokal (Oktober 2025) ‚Äì Oppdatert 07.10.2025</span></div>  </div> </div>

<!-- Service modal -->
<div id="svcBg" class="modalBg">
 <div class="modal">
   <h3>Service / Vedlikehold</h3>
   <div class="row">
     <label><input id="plog" type="checkbox"> Smurt <b>plog</b></label>
     <label><input id="fres" type="checkbox"> Smurt <b>fres</b></label>
     <label><input id="stro" type="checkbox"> Smurt <b>str√∏kasse</b></label>
     <label><input id="other" type="checkbox"> <b>Annet</b></label>
   </div>
   <div class="row" style="flex-direction:column;">
     <textarea id="svcNotes" placeholder="Anmerkninger‚Ä¶"></textarea>
   </div>
   <div class="row" style="justify-content:flex-end;">
     <button id="svcCancel" class="btn gray">Avbryt</button>
     <button id="svcSave" class="btn primary">Lagre</button>
   </div>
 </div>
</div>

<!-- Choice modal -->
<div id="choiceBg" class="modalBg">
 <div class="modal">
   <h3>Avslutte runde</h3>
   <p>Hva vil du gj√∏re n√•?</p>
   <div class="row">
     <button id="chService" class="btn primary">Service f√∏r avslutning</button>
     <button id="chNewRound" class="btn blue">Start ny runde</button>
     <button id="chJustFinish" class="btn gray">Avslutt uten service</button>
     <button id="chCancel" class="btn red">Avbryt</button>
   </div>
 </div>
</div>

<input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none"> <input id="importFile" type="file" accept="application/json" style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script> <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(function(){
 // ---- State & Storage ----
 const LS_KEY = 'broyte_v8_1_local_state';  const DRV_KEY = 'broyte_driver_name';  const state = loadState() || seedState();  let map, markers = [];  let pendingPhotoStopId = null;

 function seedState(){
   return {
     round: 1,
     startedAt: Date.now(),
     driver: localStorage.getItem(DRV_KEY) || '',
     stops: [
       mkStop('AMFI Eidsvoll (R√•holt)','Br√∏yte'),
       mkStop('R√•holt barneskole','Br√∏yte og str√∏'),
       mkStop('R√•holt ungdomsskole','Frese'),
       mkStop('Dal stasjon','Str√∏'),
       mkStop('H√∏ybr√•ten','Br√∏ytestikker')
     ],
     service: {plog:false,fres:false,stro:false,other:false,notes:''}
   };
 }
 function mkStop(name, task){
   return {id: uid(), name, task, status:'pending', details:'', photos:[], startedAt:null, finishedAt:null, comment:'', lat:null, lng:null};  }  function uid(){ return Math.random().toString(36).slice(2,10); }  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }  function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||''); }catch(e){ return null; } }

 // ---- Driver prompt once
 if (!state.driver){
   const nm = prompt('Sj√•f√∏rnavn (valgfritt, brukes i rapport):') || '';
   state.driver = nm.trim();
   localStorage.setItem(DRV_KEY, state.driver);
   saveState();
 }

 // ---- Map ----
 map = L.map('map').setView([60.283, 11.187], 12);  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);

 function refreshMarkers(){
   markers.forEach(m=> map.removeLayer(m));
   markers = [];
   state.stops.forEach((s,i)=>{
     if (s.lat && s.lng){
       const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(`${i+1}. ${s.name}<br>${s.task}`);
       markers.push(m);
     }
   });
 }
 function fitAll(){
   const ll = state.stops.filter(s=>s.lat&&s.lng).map(s=>[s.lat, s.lng]);
   if (ll.length){
     const b = L.latLngBounds(ll);
     map.fitBounds(b, {padding:[20,20]});
   }
 }
 document.getElementById('fitAllBtn').addEventListener('click', fitAll);

 // ---- Render table ----
 function render(){
   document.getElementById('roundInfo').textContent =
     `Runde ${state.round} ‚Äì Startet ${new Date(state.startedAt).toLocaleString('no-NO')}` +
     (state.driver? ` ‚Äì Sj√•f√∏r: ${state.driver}` : '');

   const tb = document.querySelector('#tbl tbody');
   tb.innerHTML = '';
   state.stops.forEach((s, i)=>{
     const tr = document.createElement('tr');
     tr.innerHTML = `
       <td class="seq">${i+1}</td>
       <td class="name">
         <div contenteditable="true" data-f="name">${s.name}</div>
         <input data-f="comment" type="text" placeholder="Kommentar‚Ä¶" value="${s.comment?escapeHtml(s.comment):''}">
         <div class="thumbs">${(s.photos||[]).map(p=>`<img src="${p.dataUrl}" alt="foto">`).join('')}</div>
         <div class="small muted">${s.startedAt?('Start: '+new Date(s.startedAt).toLocaleTimeString('no-NO')):''} ${s.finishedAt?(' ¬∑ Ferdig: '+new Date(s.finishedAt).toLocaleTimeString('no-NO')):''}</div>
       </td>
       <td class="task">
         <select data-f="task">
           ${['Br√∏yte','Frese','Str√∏','Br√∏yte og str√∏','Frese og str√∏','Br√∏ytestikker'].map(t=>`<option ${s.task===t?'selected':''}>${t}</option>`).join('')}
         </select>
       </td>
       <td class="det small">${s.details||''}${s.photos?.length?` ¬∑ ${s.photos.length} foto`:''}</td>
       <td class="sta"><span class="badge ${s.status==='done'?'b-green':(s.status==='blocked'?'b-red':(s.status==='ongoing'?'b-blue':'b-yellow'))}">${labelStatus(s.status)}</span></td>
       <td class="act">
         <div class="rowbtns">
           <button class="btn small gray" data-act="ongoing">‚ñ∂Ô∏è P√•g√•r</button>
           <button class="btn small primary" data-act="done">‚úÖ Ferdig</button>
           <button class="btn small red" data-act="blocked">‚õî Ikke mulig</button>
           <button class="btn small gray" data-act="photo">üì∑ Foto</button>
           <button class="btn small gray" data-act="nav">üß≠ Naviger</button>
           <button class="btn small gray" data-act="up">‚Üë</button>
           <button class="btn small gray" data-act="down">‚Üì</button>
         </div>
       </td>
     `;
     tr.querySelector('[data-f="name"]').addEventListener('input', e=>{ s.name = e.target.innerText.trim(); saveState(); });
     tr.querySelector('[data-f="name"]').addEventListener('blur', ()=> ensureCoords(s));
     tr.querySelector('[data-f="task"]').addEventListener('change', e=>{ s.task = e.target.value; if (s.task!=='Br√∏ytestikker') s.details=''; saveState(); render(); });
     tr.querySelector('[data-f="comment"]').addEventListener('input', e=>{ s.comment = e.target.value; saveState(); });

     tr.querySelector('[data-act="ongoing"]').addEventListener('click', ()=>{
       if (!s.startedAt) s.startedAt = Date.now();
       s.status='ongoing'; saveState(); render();
     });
     tr.querySelector('[data-act="done"]').addEventListener('click', ()=>{
       if (s.task==='Br√∏ytestikker') {
         const n = prompt('Antall br√∏ytestikker? ', (s.details||'').replace(/\D/g,''));
         if (n===null) return;
         const num = parseInt(n||'0',10)||0;
         s.details = `Br√∏ytestikker: ${num}`;
       }
       if (!s.startedAt) s.startedAt = Date.now();
       s.finishedAt = Date.now();
       s.status='done'; saveState(); render();
       // Auto-naviger til neste
       const next = state.stops.find(x=>x.status!=='done' && x.status!=='blocked');
       if (next && next.name) openGoogleMapsTo(next.name);
     });
     tr.querySelector('[data-act="blocked"]').addEventListener('click', ()=>{
       const reason = prompt('Hvorfor ikke mulig √• utf√∏re? (valgfritt)') || '';
       s.status='blocked';
       if (!s.startedAt) s.startedAt = Date.now();
       s.finishedAt = Date.now();
       if (reason) s.details = (s.details? s.details+' ¬∑ ' : '') + '√Örsak: ' + reason;
       saveState(); render();
     });
     tr.querySelector('[data-act="photo"]').addEventListener('click', ()=>{
       pendingPhotoStopId = s.id;
       document.getElementById('fileInput').click();
     });
     tr.querySelector('[data-act="nav"]').addEventListener('click', ()=> openGoogleMapsTo(s.name) );
     tr.querySelector('[data-act="up"]').addEventListener('click', ()=>{ if (i>0){ const tmp=state.stops[i-1]; state.stops[i-1]=state.stops[i]; state.stops[i]=tmp; saveState(); render(); refreshMarkers(); }});
     tr.querySelector('[data-act="down"]').addEventListener('click', ()=>{ if (i<state.stops.length-1){ const tmp=state.stops[i+1]; state.stops[i+1]=state.stops[i]; state.stops[i]=tmp; saveState(); render(); refreshMarkers(); }});
     tb.appendChild(tr);
   });
   document.getElementById('nextTxt').textContent = state.stops.find(s=>s.status!=='done' && s.status!=='blocked')?.name || '‚Äî';
   refreshMarkers();
 }
 function labelStatus(s){ return s==='done'?'Ferdig':(s==='blocked'?'Stoppet':(s==='ongoing'?'P√•g√•r':'Venter')); }

 // ---- Add, optimize ----
 document.getElementById('addBtn').addEventListener('click', async ()=>{
   const name = document.getElementById('addr').value.trim();
   const task = document.getElementById('taskSel').value;
   if (!name) return;
   const st = mkStop(name, task);
   state.stops.push(st);
   document.getElementById('addr').value='';
   saveState(); render();
   ensureCoords(st);
 });
 document.getElementById('optBtn').addEventListener('click', ()=>{
   state.stops.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'no'));
   saveState(); render(); refreshMarkers(); fitAll();  });

 // ---- Export / Import routes ----
 document.getElementById('exportBtn').addEventListener('click', ()=>{
   const data = JSON.stringify({round:state.round, startedAt:state.startedAt, stops:state.stops}, null, 2);
   downloadBlob(new Blob([data], {type:'application/json'}), `broyterute_rute_round${state.round}.json`);
 });
 document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
 document.getElementById('importFile').addEventListener('change', async (e)=>{
   const f = e.target.files?.[0]; if (!f) return;
   const txt = await f.text();
   try{
     const js = JSON.parse(txt);
     if (Array.isArray(js.stops)){
       state.stops = js.stops.map(s=>({ ...mkStop(s.name||'', s.task||'Br√∏yte'), ...s }));
       saveState(); render(); refreshMarkers(); fitAll();
       alert('Rute importert.');
     } else alert('Filen mangler stops[].');
   }catch(err){ alert('Kunne ikke lese JSON.'); }
   e.target.value='';
 });

 // ---- Finish choice ----
 const choiceBg = mkElById('choiceBg');
 mkElById('doneBtn').addEventListener('click', ()=> choiceBg.style.display='flex');  mkElById('chCancel').addEventListener('click', ()=> choiceBg.style.display='none');  mkElById('chService').addEventListener('click', ()=>{ choiceBg.style.display='none'; mkElById('svcBg').style.display='flex'; });  mkElById('chNewRound').addEventListener('click', ()=>{
   choiceBg.style.display='none'; startNewRound();  });  mkElById('chJustFinish').addEventListener('click', async ()=>{
   choiceBg.style.display='none';
   await exportReport(); // nedlasting
   alert('Rapport lastet ned (ZIP+CSV+PDF). Du kan sende den videre p√• e-post fra telefonen.');  });

 // ---- Service ----
 mkElById('svcCancel').addEventListener('click', ()=>{ mkElById('svcBg').style.display='none'; });  mkElById('svcSave').addEventListener('click', async ()=>{
   mkElById('svcBg').style.display='none';
   state.service = {
     plog: mkElById('plog').checked,
     fres: mkElById('fres').checked,
     stro: mkElById('stro').checked,
     other: mkElById('other').checked,
     notes: mkElById('svcNotes').value.trim()
   };
   saveState();
   await exportReport();
   alert('Service lagret og rapport lastet ned. Klar for ny runde.');  });

 // ---- Photos ----
 document.getElementById('fileInput').addEventListener('change', (e)=>{
   const file = e.target.files && e.target.files[0];
   if (!file || !pendingPhotoStopId) return;
   const reader = new FileReader();
   reader.onload = ()=>{
     const stop = state.stops.find(s=>s.id===pendingPhotoStopId);
     if (stop) {
       stop.photos = stop.photos || [];
       stop.photos.push({ dataUrl: reader.result, ts: Date.now() });
       saveState(); render();
     }
     pendingPhotoStopId = null;
     e.target.value = '';
   };
   reader.readAsDataURL(file);
 });

 // ---- Geocoding + auto check-in ----
 async function geocodeNameToCoords(name){
   try{
     const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(name), { headers: { 'Accept-Language':'no' } });
     const js = await r.json();
     if (js && js[0]) return { lat: parseFloat(js[0].lat), lng: parseFloat(js[0].lon) };
   }catch(e){}
   return null;
 }
 async function ensureCoords(stop){
   if (stop && (!stop.lat || !stop.lng) && stop.name){
     const c = await geocodeNameToCoords(stop.name);
     if (c){ stop.lat=c.lat; stop.lng=c.lng; saveState(); refreshMarkers(); }
   }
 }
 function haversineMeters(aLat, aLng, bLat, bLng){
   const toRad = d => d * Math.PI / 180;
   const R = 6371000;
   const dLat = toRad(bLat - aLat);
   const dLng = toRad(bLng - aLng);
   const s1 = Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
   return 2 * R * Math.asin(Math.sqrt(s1));  }  if ('geolocation' in navigator) {
   navigator.geolocation.watchPosition((pos)=>{
     const {latitude, longitude, accuracy} = pos.coords;
     mkElById('posTxt').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)} (¬±${Math.round(accuracy)} m)`;
     const next = state.stops.find(x=>x.status!=='done' && x.status!=='blocked');
     if (next && next.lat && next.lng){
       const dist = haversineMeters(latitude, longitude, next.lat, next.lng);
       if (dist < 60 && !next._askedCheckin){
         next._askedCheckin = true;
         saveState();
         const ok = confirm(`Du er ved "${next.name}". Sjekk inn n√•?`);
         if (ok){
           if (!next.startedAt) next.startedAt = Date.now();
           next.details = (next.details? next.details+' ¬∑ ' : '') + 'Sjekket inn';
           next.status = 'ongoing';
           saveState(); render();
         }
       }
     }
   }, ()=>{}, {enableHighAccuracy:true, maximumAge:5000, timeout:20000});  }

 // ---- Open Google Maps ----
 function openGoogleMapsTo(address){
   const url = 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(address);
   window.open(url, '_blank');
 }

 // ---- Export (CSV + ZIP + PDF + clipboard) ----  async function exportReport(){
   const round = state.round;
   const startedAt = new Date(state.startedAt);
   const finishedAt = new Date();
   const csvLines = [
     ['Runde','Start','Slutt','Sj√•f√∏r','Navn','Oppgave','Status','Detaljer','Kommentar','Antall bilder','Starttid','Sluttid','Service:plog','Service:fres','Service:stro','Service:annet','Service:notes'].join(','),
     ...state.stops.map(s=>[
       round,
       startedAt.toISOString(),
       finishedAt.toISOString(),
       csvEscape(state.driver||''),
       csvEscape(s.name),
       csvEscape(s.task),
       s.status,
       csvEscape(s.details||''),
       csvEscape(s.comment||''),
       (s.photos||[]).length,
       s.startedAt? new Date(s.startedAt).toISOString(): '',
       s.finishedAt? new Date(s.finishedAt).toISOString(): '',
       state.service.plog,
       state.service.fres,
       state.service.stro,
       state.service.other,
       csvEscape(state.service.notes||'')
     ].join(','))
   ];
   const csv = csvLines.join('\n');

   // Copy CSV to clipboard (best effort)
   try{ await navigator.clipboard.writeText(csv); }catch(_){}

   // Build PDF (simple summary)
   const { jsPDF } = window.jspdf;
   const pdf = new jsPDF();
   pdf.setFontSize(12);
   pdf.text(`Br√∏yterute ‚Äì Runde ${round}`, 14, 14);
   pdf.text(`Start: ${startedAt.toLocaleString('no-NO')}  Slutt: ${finishedAt.toLocaleString('no-NO')}`,14,22);
   if (state.driver) pdf.text(`Sj√•f√∏r: ${state.driver}`,14,30);
   let y = 38;
   state.stops.forEach((s,i)=>{
     const line = `${i+1}. ${s.name} ‚Äî ${s.task} ‚Äî ${labelStatus(s.status)}${s.details?(' ‚Äî '+s.details):''}${s.comment?(' ‚Äî '+s.comment):''}`;
     const lines = pdf.splitTextToSize(line, 180);
     if (y + lines.length*6 > 280){ pdf.addPage(); y=20; }
     pdf.text(lines, 14, y); y += lines.length*6 + 2;
   });
   const pdfBlob = pdf.output('blob');

   // Build ZIP
   const zip = new JSZip();
   zip.file(`broeyting_dokumentasjon_runde${round}.csv`, csv);
   zip.file(`broeyting_rapport_runde${round}.pdf`, pdfBlob);
   let idx = 1;
   for (const s of state.stops){
     if (s.photos && s.photos.length){
       let i=1;
       for (const p of s.photos){
         const base64 = (p.dataUrl.split(',')[1]||'');
         zip.file(`bilder/${String(idx).padStart(2,'0')}_${safeName(s.name)}_${i}.jpg`, base64, {base64:true});
         i++;
       }
     }
     idx++;
   }
   const blob = await zip.generateAsync({type:"blob"});
   downloadBlob(blob, `broeyting_dokumentasjon_runde${round}.zip`);
 }

 function csvEscape(s){ return '"' + String(s).replace(/"/g,'""') + '"'; }  function safeName(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,''); }  function downloadBlob(blob, filename){
   const a = document.createElement('a');
   a.href = URL.createObjectURL(blob);
   a.download = filename;
   a.click();
   setTimeout(()=>URL.revokeObjectURL(a.href), 1000);  }

 function startNewRound(){
   state.round += 1;
   state.startedAt = Date.now();
   state.stops.forEach(s=>{ s.status='pending'; s.startedAt=null; s.finishedAt=null; if (s.task==='Br√∏ytestikker') s.details=''; s.photos=[]; s.comment=''; s._askedCheckin=false; });
   state.service = {plog:false,fres:false,stro:false,other:false,notes:''};
   saveState();
   render();
 }

 // ---- Utils ----
 function mkElById(id){ return document.getElementById(id); }  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch])); }

 // ---- Init ----
 render();
 // Pr√∏v √• geokode manglende koordinater  state.stops.forEach(s => { if (!s.lat||!s.lng) ensureCoords(s); });

})();</script>
</body>
</html>
