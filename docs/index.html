<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Br√∏yterute ‚Äì V8 Lokal</title>
<meta name="theme-color" content="#0f9d58">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
  :root{ --btnH:48px; --pad:10px; }
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f7f7f9; }
  #app { height:100%; display:grid; grid-template-rows:auto 1fr auto; }
  header { background:#111; color:#fff; padding:10px 12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  header h1 { font-size:16px; margin:0; }
  .tabs { display:flex; gap:6px; margin-left:auto; }
  .tab { background:#2a2a2a; color:#fff; border:none; border-radius:10px; height:38px; padding:0 12px; }
  .tab.active { background:#0f9d58; }
  .topbar { background:#fff; padding:8px 12px; display:flex; gap:8px; align-items:center; border-bottom:1px solid #e6e6e6; }
  .topbar input[type="text"] { flex:1; height:44px; border-radius:10px; border:1px solid #ccc; padding:0 12px; font-size:16px; }
  .topbar select { height:44px; border-radius:10px; border:1px solid #ccc; padding:0 10px; font-size:16px; }
  .btn { height:44px; border:none; border-radius:10px; padding:0 12px; font-size:15px; }
  .btn.primary { background:#0f9d58; color:#fff; }
  .btn.blue { background:#0061fe; color:#fff; }
  .btn.red { background:#c21d03; color:#fff; }
  .btn.gray { background:#eee; color:#111; border:1px solid #ccc; }
  .btn.small { height:36px; font-size:14px; }
  .grid { display:grid; grid-template-columns: 1fr auto; gap:10px; }
  #map { width:100%; height:100%; }
  table { width:100%; border-collapse:collapse; background:#fff; }
  th, td { border-bottom:1px solid #eee; padding:10px 8px; vertical-align:middle; }
  th.seq, td.seq { width: 46px; text-align:center; font-weight:700; }
  .rowbtns { display:flex; gap:6px; flex-wrap:wrap; }
  .footer { background:#111; color:#fff; padding:8px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .badge { padding:3px 8px; border-radius:999px; font-size:12px; }
  .b-green { background:#d4edda; color:#155724; }
  .b-yellow{ background:#fff3cd; color:#856404; }
  .b-red{ background:#f8d7da; color:#721c24; }
  .modalBg { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:10; }
  .modal { background:#fff; border-radius:12px; width:min(640px,92vw); padding:14px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .row label { display:flex; align-items:center; gap:8px; background:#f7f7f7; border:1px solid #eee; border-radius:10px; padding:8px 10px; }
  textarea { width:100%; min-height:90px; border:1px solid #ccc; border-radius:10px; padding:10px; }
  .small { font-size: 12px; color:#bbb; }
  .chips { display:flex; gap:6px; flex-wrap:wrap; margin:8px 12px; }
  .chip { background:#f1f1f1; border:1px solid #ddd; border-radius:16px; padding:4px 8px; font-size:12px; }
  .footer-left, .footer-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .version { color:#bbb; font-size:12px; }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>Br√∏yterute</h1>
    <div class="tabs">
      <button class="tab active" data-tab="route">Rute</button>
      <button class="tab" data-tab="reports" disabled>Rapporter</button>
    </div>
  </header>

  <div class="topbar">
    <input id="addr" type="text" placeholder="Adresse/omr√•de (f.eks. Dal stasjon)">
    <select id="taskSel">
      <option>Br√∏yte</option>
      <option>Frese</option>
      <option>Str√∏</option>
      <option>Br√∏yte og str√∏</option>
      <option>Frese og str√∏</option>
      <option>Br√∏ytestikker</option>
    </select>
    <button id="addBtn" class="btn primary">Legg til</button>
    <button id="optBtn" class="btn gray">Optimaliser</button>
    <button id="doneBtn" class="btn primary">Ferdig (runde)</button>
  </div>

  <div class="grid">
    <div style="padding:8px 12px; overflow:auto;">
      <table id="tbl">
        <thead><tr><th class="seq">#</th><th>Navn</th><th>Oppgave</th><th>Detaljer</th><th>Status</th><th>Handling</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="chips">
        <span class="chip">Tips: Bruk ‚Äúüì∑ Foto‚Äù p√• raden for √• dokumentere.</span>
      </div>
    </div>
    <div style="border-left:1px solid #eee;">
      <div id="map" aria-label="Kart" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-left">
      <div>Live posisjon: <span id="posTxt">‚Äî</span></div>
    </div>
    <div class="footer-right">
      <div>Neste: <span id="nextTxt">‚Äî</span></div>
      <div class="version">| Versjon 8 ‚Äì Lokal (Oktober 2025) ‚Äì Oppdatert 06.10.2025</div>
    </div>
  </div>
</div>

<!-- Service modal -->
<div id="svcBg" class="modalBg">
  <div class="modal">
    <h3>Service / Vedlikehold</h3>
    <div class="row">
      <label><input id="plog" type="checkbox"> Smurt <b>plog</b></label>
      <label><input id="fres" type="checkbox"> Smurt <b>fres</b></label>
      <label><input id="stro" type="checkbox"> Smurt <b>str√∏kasse</b></label>
      <label><input id="other" type="checkbox"> <b>Annet</b></label>
    </div>
    <div class="row" style="flex-direction:column;">
      <textarea id="svcNotes" placeholder="Anmerkninger‚Ä¶"></textarea>
    </div>
    <div class="row" style="justify-content:flex-end;">
      <button id="svcCancel" class="btn gray">Avbryt</button>
      <button id="svcSave" class="btn primary">Lagre</button>
    </div>
  </div>
</div>

<!-- Choice modal -->
<div id="choiceBg" class="modalBg">
  <div class="modal">
    <h3>Avslutte runde</h3>
    <p>Hva vil du gj√∏re n√•?</p>
    <div class="row">
      <button id="chService" class="btn primary">Service f√∏r avslutning</button>
      <button id="chNewRound" class="btn blue">Start ny runde</button>
      <button id="chJustFinish" class="btn gray">Avslutt uten service</button>
      <button id="chCancel" class="btn red">Avbryt</button>
    </div>
  </div>
</div>

<input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
(function(){
  // ---- State & Storage ----
  const LS_KEY = 'broyte_v8_local_state';
  const state = loadState() || {
    round: 1,
    startedAt: Date.now(),
    stops: [
      {id: uid(), name:'AMFI Eidsvoll (R√•holt)', task:'Br√∏yte', status:'pending', details:'', photos:[]},
      {id: uid(), name:'R√•holt barneskole', task:'Br√∏yte og str√∏', status:'pending', details:'', photos:[]},
      {id: uid(), name:'R√•holt ungdomsskole', task:'Frese', status:'pending', details:'', photos:[]},
      {id: uid(), name:'Dal stasjon', task:'Str√∏', status:'pending', details:'', photos:[]},
      {id: uid(), name:'H√∏ybr√•ten', task:'Br√∏ytestikker', status:'pending', details:'', photos:[]}
    ],
    service: {plog:false,fres:false,stro:false,other:false,notes:''}
  };

  function uid(){ return Math.random().toString(36).slice(2,10); }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||''); }catch(e){ return null; } }

  // ---- Map ----
  const map = L.map('map').setView([60.283, 11.187], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);

  // ---- Render table ----
  function render(){
    const tb = document.querySelector('#tbl tbody');
    tb.innerHTML = '';
    state.stops.forEach((s, i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="seq">${i+1}</td>
        <td contenteditable="true" data-f="name">${s.name}</td>
        <td>
          <select data-f="task">
            ${['Br√∏yte','Frese','Str√∏','Br√∏yte og str√∏','Frese og str√∏','Br√∏ytestikker'].map(t=>`<option ${s.task===t?'selected':''}>${t}</option>`).join('')}
          </select>
        </td>
        <td class="small">${s.details||''}${s.photos?.length?` ¬∑ ${s.photos.length} foto`:''}</td>
        <td><span class="badge ${s.status==='done'?'b-green':(s.status==='blocked'?'b-red':'b-yellow')}">${s.status}</span></td>
        <td class="rowbtns">
          <button class="btn small primary" data-act="done">‚úÖ Ferdig</button>
          <button class="btn small red" data-act="blocked">‚õî Ikke mulig</button>
          <button class="btn small gray" data-act="photo">üì∑ Foto</button>
          <button class="btn small gray" data-act="up">‚Üë</button>
          <button class="btn small gray" data-act="down">‚Üì</button>
        </td>
      `;
      tr.querySelector('[data-f="name"]').addEventListener('input', e=>{ s.name = e.target.innerText.trim(); saveState(); });
      tr.querySelector('[data-f="task"]').addEventListener('change', e=>{ s.task = e.target.value; if (s.task!=='Br√∏ytestikker') s.details=''; saveState(); render(); });
      tr.querySelector('[data-act="done"]').addEventListener('click', ()=>{
        if (s.task==='Br√∏ytestikker') {
          const n = prompt('Antall br√∏ytestikker? ', (s.details||'').replace(/\D/g,''));
          if (n===null) return;
          const num = parseInt(n||'0',10)||0;
          s.details = `Br√∏ytestikker: ${num}`;
        }
        s.status='done'; saveState(); render();
      });
      tr.querySelector('[data-act="blocked"]').addEventListener('click', ()=>{
        const reason = prompt('Hvorfor ikke mulig √• utf√∏re? (valgfritt)') || '';
        s.status='blocked';
        if (reason) s.details = (s.details? s.details+' ¬∑ ' : '') + '√Örsak: ' + reason;
        saveState(); render();
      });
      tr.querySelector('[data-act="photo"]').addEventListener('click', ()=>{
        pendingPhotoStopId = s.id;
        document.getElementById('fileInput').click();
      });
      tr.querySelector('[data-act="up"]').addEventListener('click', ()=>{ if (i>0){ const tmp=state.stops[i-1]; state.stops[i-1]=state.stops[i]; state.stops[i]=tmp; saveState(); render(); }});
      tr.querySelector('[data-act="down"]').addEventListener('click', ()=>{ if (i<state.stops.length-1){ const tmp=state.stops[i+1]; state.stops[i+1]=state.stops[i]; state.stops[i]=tmp; saveState(); render(); }});
      tb.appendChild(tr);
    });
    document.getElementById('nextTxt').textContent = state.stops.find(s=>s.status!=='done' && s.status!=='blocked')?.name || '‚Äî';
  }

  // ---- Add, optimize ----
  document.getElementById('addBtn').addEventListener('click', ()=>{
    const name = document.getElementById('addr').value.trim();
    const task = document.getElementById('taskSel').value;
    if (!name) return;
    state.stops.push({id:uid(), name, task, status:'pending', details:'', photos:[]});
    document.getElementById('addr').value='';
    saveState(); render();
  });
  document.getElementById('optBtn').addEventListener('click', ()=>{
    state.stops.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'no'));
    saveState(); render();
  });

  // ---- Finish choice ----
  const choiceBg = document.getElementById('choiceBg');
  document.getElementById('doneBtn').addEventListener('click', ()=> choiceBg.style.display='flex');
  document.getElementById('chCancel').addEventListener('click', ()=> choiceBg.style.display='none');
  document.getElementById('chService').addEventListener('click', ()=>{ choiceBg.style.display='none'; document.getElementById('svcBg').style.display='flex'; });
  document.getElementById('chNewRound').addEventListener('click', ()=>{
    choiceBg.style.display='none';
    startNewRound();
  });
  document.getElementById('chJustFinish').addEventListener('click', async ()=>{
    choiceBg.style.display='none';
    await exportReport(); // nedlasting
    alert('Rapport lastet ned. Du kan sende den videre p√• e-post fra telefonen.');
  });

  // ---- Service ----
  document.getElementById('svcCancel').addEventListener('click', ()=>{ document.getElementById('svcBg').style.display='none'; });
  document.getElementById('svcSave').addEventListener('click', async ()=>{
    document.getElementById('svcBg').style.display='none';
    state.service = {
      plog: document.getElementById('plog').checked,
      fres: document.getElementById('fres').checked,
      stro: document.getElementById('stro').checked,
      other: document.getElementById('other').checked,
      notes: document.getElementById('svcNotes').value.trim()
    };
    saveState();
    await exportReport();
    alert('Service lagret og rapport lastet ned. Klar for ny runde.');
  });

  // ---- Photos ----
  let pendingPhotoStopId = null;
  document.getElementById('fileInput').addEventListener('change', (e)=>{
    const file = e.target.files && e.target.files[0];
    if (!file || !pendingPhotoStopId) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const stop = state.stops.find(s=>s.id===pendingPhotoStopId);
      if (stop) {
        stop.photos = stop.photos || [];
        stop.photos.push({ dataUrl: reader.result, ts: Date.now() });
        saveState(); render();
      }
      pendingPhotoStopId = null;
      e.target.value = '';
    };
    reader.readAsDataURL(file);
  });

  // ---- Export (CSV + ZIP) ----
  async function exportReport(){
    const round = state.round;
    const startedAt = new Date(state.startedAt);
    const finishedAt = new Date();
    const csvLines = [
      ['Runde','Start','Slutt','Navn','Oppgave','Status','Detaljer','Antall bilder','Service:plog','Service:fres','Service:stro','Service:annet','Service:notes'].join(','),
      ...state.stops.map(s=>[
        round,
        startedAt.toISOString(),
        finishedAt.toISOString(),
        csvEscape(s.name),
        csvEscape(s.task),
        s.status,
        csvEscape(s.details||''),
        (s.photos||[]).length,
        state.service.plog,
        state.service.fres,
        state.service.stro,
        state.service.other,
        csvEscape(state.service.notes||'')
      ].join(','))
    ];
    const csv = csvLines.join('\n');

    const zip = new JSZip();
    zip.file(`broeyting_dokumentasjon_runde${round}.csv`, csv);
    let idx = 1;
    for (const s of state.stops){
      if (s.photos && s.photos.length){
        let i=1;
        for (const p of s.photos){
          const base64 = (p.dataUrl.split(',')[1]||'');
          zip.file(`bilder/${String(idx).padStart(2,'0')}_${safeName(s.name)}_${i}.jpg`, base64, {base64:true});
          i++;
        }
      }
      idx++;
    }
    const blob = await zip.generateAsync({type:"blob"});
    downloadBlob(blob, `broeyting_dokumentasjon_runde${round}.zip`);
  }
  function csvEscape(s){ return '"' + String(s).replace(/"/g,'""') + '"'; }
  function safeName(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,''); }
  function downloadBlob(blob, filename){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  function startNewRound(){
    state.round += 1;
    state.startedAt = Date.now();
    state.stops.forEach(s=>{ s.status='pending'; if (s.task==='Br√∏ytestikker') s.details=''; s.photos=[]; });
    state.service = {plog:false,fres:false,stro:false,other:false,notes:''};
    saveState();
    render();
  }

  // ---- Geolocation (local display)
  if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition((pos)=>{
      const {latitude, longitude, accuracy} = pos.coords;
      document.getElementById('posTxt').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)} (¬±${Math.round(accuracy)} m)`;
    }, ()=>{}, {enableHighAccuracy:true, maximumAge:5000, timeout:20000});
  }

  // ---- Init ----
  render();
})();
</script>
</body>
</html>
