<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Brøyterute – v9.7 (Romerike Trefelling)</title>
<meta name="theme-color" content="#0f9d58">
<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#111; --fg:#f5f7fa; --muted:#b9c2cc;
  --card:#181a1e; --cardBorder:#2a2f36;
  --green:#0f9d58; --blue:#0b66ff; --red:#c21d03; --gray:#2f3337;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
body{background:var(--bg);color:var(--fg)}
a{color:inherit}
button{cursor:pointer}
input,select,textarea{background:transparent;color:inherit;border:1px solid var(--cardBorder);border-radius:10px;padding:10px;font-size:16px}

#app{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}

header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#0b0b0b;color:#fff;border-bottom:1px solid #141414}
header h1{margin:0;font-size:16px}
.spacer{flex:1}

.nav{display:flex;gap:8px;flex-wrap:wrap}
.tab{border:none;border-radius:12px;padding:8px 12px;background:#25282e;color:#fff}
.tab.active{background:var(--green)}

.page{display:none;padding:14px}
.page.active{display:block}

.card{background:var(--card);border:1px solid var(--cardBorder);border-radius:16px;padding:14px}
.stack{display:flex;flex-direction:column;gap:12px}
.row{display:flex;flex-wrap:wrap;gap:10px}

.btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700}
.btn-green{background:var(--green);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-gray{background:var(--gray);color:#fff}

.title-lg{font-size:26px;font-weight:800}
.muted{color:var(--muted)}
.small{font-size:12px}

.progress{width:100%;height:14px;border-radius:999px;background:#242830;border:1px solid var(--cardBorder);overflow:hidden}
.progress>.bar{height:100%;width:0%;background:linear-gradient(90deg,#0f9d58,#22c55e);transition:width .25s ease}

.thumbs img{width:52px;height:52px;object-fit:cover;border-radius:8px;border:1px solid #3a3f46;margin-right:6px}

.footer{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 12px;background:#0b0b0b;color:#fff;border-top:1px solid #141414;font-size:12px}

.item{background:var(--card);border:1px solid var(--cardBorder);border-radius:12px;padding:10px;margin-bottom:8px}

.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;background:#22262c;border:1px solid #2b3139}
.badge.warn{background:#3a2f00;color:#ffd27a;border-color:#5a4a00}

.hanske .btn{font-size:22px;padding:16px 20px;border-radius:18px}

/* installer-banner */
.install {border:1px dashed #334; border-radius:12px; padding:10px; background:#15181d}
</style>
</head>
<body>
<div id="app">
<header>
  <h1>Brøyterute</h1>
  <div class="spacer"></div>
  <div class="nav">
    <button class="tab active" data-tab="home">Hjem</button>
    <button class="tab" data-tab="work">Under arbeid</button>
    <button class="tab" data-tab="register">Adresse-register</button>
    <button class="tab" data-tab="admin">Admin</button>
    <button class="tab" data-tab="service">Service</button>
  </div>
</header>

<!-- HJEM -->
<div id="page-home" class="page active">
  <div class="card stack">
    <h2>Innstillinger</h2>
    <div class="row">
      <label>Rolle</label>
      <select id="role">
        <option value="driver1">Sjåfør 1</option>
        <option value="driver2">Sjåfør 2</option>
        <option value="driver3">Sjåfør 3</option>
        <option value="driver4">Sjåfør 4</option>
        <option value="admin">Admin (lese)</option>
      </select>

      <label>Retning</label>
      <select id="direction">
        <option value="forward">Vanlig</option>
        <option value="reverse">Baklengs</option>
      </select>

      <label style="display:flex;gap:6px;align-items:center">
        <input id="useCustomName" type="checkbox"> Bruk eget navn
      </label>
      <input id="customName" type="text" placeholder="Skriv navnet ditt" style="min-width:220px;display:none">

      <label><input id="bigBtn" type="checkbox"> Hanske-modus</label>
      <label><input id="autoCheck" type="checkbox" checked> Auto sjekk-inn</label>
    </div>
        <div class="row">
      <div id="syncRow" class="row" style="align-items:center;gap:8px">
        <label id="keyBlock">
          Synk-nøkkel
          <input id="apiKey" type="password" placeholder="Lim inn X-Master-Key (lokalt)">
        </label>
        <button id="saveKey" class="btn btn-blue">Lagre nøkkel</button>
        <span id="syncStatus" class="badge">Synk –</span>
        <a id="editKey" href="#" class="small" style="display:none">Endre nøkkel</a>
      </div>
    </div>

    <div class="row">
      <button id="btnRoundByEquip" class="btn btn-blue">Start ny runde (etter utstyr)</button>
      <button id="btnResetAll" class="btn btn-red">Nullstill alle</button>
      <button id="btnStart" class="btn btn-green">Start runde →</button>
      <button id="btnSyncNow" class="btn btn-gray">Synk nå</button>
    </div>

    <div class="small muted" id="lastSyncText">—</div>
    <div class="muted" id="directionNote">—</div>
  </div>

  <!-- Installer som app -->
  <div id="installCard" class="card install" style="display:none">
    <h3>Installer som app</h3>
    <div class="small muted">For fullskjerm uten adressefelt.</div>
    <div class="row">
      <button id="btnInstall" class="btn btn-green">📲 Installer app</button>
      <button id="btnInstallHelp" class="btn btn-gray">Hvordan?</button>
    </div>
    <div id="installHelp" class="small" style="display:none">
      <p><b>iPhone (Safari)</b>: Trykk del-ikonet (firkant med pil) → <i>Legg til på Hjem-skjermen</i>.</p>
      <p><b>Android (Chrome)</b>: Trykk meny ⋮ → <i>Installer app</i>.</p>
    </div>
  </div>

  <div class="card stack">
    <h3>Utstyr</h3>
    <div class="row">
      <label><input id="eq_plog" type="checkbox" checked> Plog</label>
      <label><input id="eq_fres" type="checkbox"> Fres</label>
      <label><input id="eq_stro" type="checkbox"> Strøkasse</label>
    </div>
  </div>
</div>
<!-- UNDER ARBEID -->
<div id="page-work" class="page">
  <div class="card stack">
    <div class="row" style="align-items:center;gap:8px">
      <div id="driverLbl" class="muted">Rolle: —</div>
      <div id="directionLbl" class="badge">Retning: —</div>
      <div id="claimWarn" class="badge warn" style="display:none">⚠️ Delt retning</div>
    </div>

    <h2 id="curName" class="title-lg">—</h2>
    <div class="muted">Oppgave: <span id="curTask">—</span></div>
    <div class="muted">Neste: <span id="curNext">—</span></div>

    <div class="progress-row" style="display:flex;align-items:center;gap:10px">
      <div class="muted" id="progTxt">0 % fullført (0/0)</div>
      <div class="progress" style="flex:1;min-width:160px">
        <div class="bar" id="progBar"></div>
      </div>
    </div>
    <div class="small muted" id="lastSyncTextWork">—</div>

    <div class="thumbs" id="thumbs"></div>

    <div class="row">
      <button id="ongo" class="btn btn-gray">▶️ Pågår</button>
      <button id="done" class="btn btn-green">✅ Ferdig</button>
      <button id="block" class="btn btn-red">⛔ Ikke mulig</button>
      <button id="photo" class="btn btn-gray">📷 Foto</button>
      <button id="nav" class="btn btn-blue">🧭 Naviger</button>
      <button id="next" class="btn btn-gray">🔁 Neste</button>
    </div>
  </div>
</div>
<!-- ADRESSE-REGISTER -->
<div id="page-register" class="page">
  <div class="card stack">
    <div class="row">
      <button id="btnCatalogPull" class="btn btn-blue">↘︎ Hent fra katalog</button>
      <button id="btnPropose" class="btn btn-gray">✍️ Foreslå endring/ny</button>
    </div>
    <div class="small muted">
      Katalogen er «felles liste». Lokale tillegg under påvirker kun din enhet (til neste publisering).
    </div>
  </div>

  <!-- Dynamisk liste over alle adresser -->
  <div id="list"></div>

  <div class="card stack">
    <h3>Legg til ny adresse (lokalt)</h3>
    <div class="row">
      <input id="addr" type="text" placeholder="Adresse / område" style="flex:2">
      <select id="taskSel" style="flex:1">
        <option>Brøyte</option>
        <option>Frese</option>
        <option>Strø</option>
        <option>Brøyte og strø</option>
        <option>Frese og strø</option>
        <option>Brøytestikker</option>
      </select>
      <button id="add" class="btn btn-green">+ Legg til</button>
    </div>
    <div class="small muted">Tips: Trykk Enter i adressefeltet for å legge til raskt.</div>
  </div>
</div>

<!-- ADMIN -->
<div id="page-admin" class="page">
  <div class="card stack">
    <h2>Admin</h2>
    <div class="row">
      <button id="adminSync" class="btn btn-gray">Hent status nå</button>
      <span id="adminSyncTxt" class="muted">—</span>
    </div>
    <div id="adminStats" class="muted">Ingen data enda.</div>
    <div id="adminList"></div>
  </div>

  <div class="card stack">
    <h3>Katalog (felles) – rediger</h3>
    <div class="small muted">🔒 Krever X-Master-Key. Endringer lagres til katalogen og backup tas automatisk.</div>
    <div class="row">
      <button id="catLoad" class="btn btn-gray">Last katalog</button>
      <button id="catAdd" class="btn btn-blue">➕ Legg til</button>
      <button id="catSave" class="btn btn-green">💾 Lagre katalog</button>
      <button id="catPublish" class="btn btn-blue">🚀 Publiser til MASTER</button>
      <button id="catExportCsv" class="btn btn-gray">⬇︎ Eksporter CSV</button>
    </div>
    <div id="catMsg" class="small muted">—</div>
    <div id="catList"></div>
    <div class="row">
      <button id="catRestore" class="btn btn-red">⏪ Gjenopprett fra backup</button>
    </div>
  </div>

  <div class="card stack">
    <h3>Forslag (INBOX)</h3>
    <div class="row">
      <button id="adminInbox" class="btn btn-gray">Hent forslag</button>
      <span id="adminInboxTxt" class="muted">—</span>
    </div>
    <div id="inboxList"></div>
  </div>
</div>
<!-- SERVICE -->
<div id="page-service" class="page">
  <div class="card stack">
    <h2>Service / Vedlikehold</h2>
    <div class="row">
      <label><input id="svc_plog" type="checkbox"> Smurt plog</label>
      <label><input id="svc_fres" type="checkbox"> Smurt fres</label>
      <label><input id="svc_stro" type="checkbox"> Smurt strøkasse</label>
      <label><input id="svc_other" type="checkbox"> Annet</label>
    </div>
    <textarea id="svcNotes" placeholder="Anmerkninger …" style="width:100%;min-height:100px"></textarea>
    <div class="row">
      <button id="svcSave" class="btn btn-green">📤 Lagre og send rapport</button>
      <button id="svcGuide" class="btn btn-gray">🧾 Last ned brukerark (PDF)</button>
    </div>
    <div class="small muted">
      Rapporten deles som CSV (delingsdialog på mobil / nedlasting i nettleser).
    </div>
  </div>
</div>

<!-- FOOTER -->
<div class="footer">
  <div id="pos">—</div>
  <div>v9.7 – Romerike Trefelling</div>
</div>

<!-- Foto-opplasting -->
<input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">
<script>
/* ===== KONFIG ===== */
const JSONBIN_API_KEY        = "$2a$10$DK3EUoEj/YsimWzgYG.DMOb4aEFFUiRPdJgmkOzfPQ3Jx2evIIWma";
const JSONBIN_MASTER_BIN_ID  = "68e774c9ae596e708f0b9977";   // MASTER: rute/status
const JSONBIN_CATALOG_BIN_ID = "68e782f3d0ea881f409ae08a";   // PUBLIC: katalog (skriv via key)
const JSONBIN_INBOX_BIN_ID   = "68e7833843b1c97be95ff286";   // INBOX: forslag (skriv via key)
const JSONBIN_BACKUP_BIN_ID  = "68e7b4d2ae596e708f0bde7d";   // Privat backup-bin
const HEARTBEAT_MS = 30000;

/* ===== STATE ===== */
const LS = "broyte_v97_state";
let state = load() || {
  role:"driver1",
  direction:"forward",
  equipment:{plog:true,fres:false,stro:false},
  autoCheck:true,
  hanske:false,
  useCustomName:false,
  customName:"",
  stops:[],
  service:{plog:false,fres:false,stro:false,other:false,notes:""},
  lastSyncAt:null,
  lastSyncBy:""
};
function save(){ localStorage.setItem(LS, JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem(LS)||""); }catch(_){ return null; } }
function apiKey(){ return localStorage.getItem("broyte_api_key") || JSONBIN_API_KEY; }
function headers(){ return {"Content-Type":"application/json","X-Master-Key": apiKey()}; }
const $ = id => document.getElementById(id);
const esc = s => String(s||"");
const fmtTime = ts => ts ? new Date(ts).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",second:"2-digit"}) : "—";
function displayName(){ return state.useCustomName && state.customName ? state.customName : (state.role || "Sjåfør"); }

/* ===== PWA REGISTER ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", ()=> navigator.serviceWorker.register("sw.js").catch(()=>{}));
}

/* ===== DOMContentLoaded ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  // Tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      $("page-"+btn.dataset.tab).classList.add("active");
      if(btn.dataset.tab==="work") renderWork();
      if(btn.dataset.tab==="register") renderRegister();
    });
  });

  // Hjem init verdier
  $("role").value = state.role;
  $("direction").value = state.direction;
  $("eq_plog").checked = !!state.equipment.plog;
  $("eq_fres").checked = !!state.equipment.fres;
  $("eq_stro").checked = !!state.equipment.stro;
  $("autoCheck").checked = !!state.autoCheck;
  document.body.classList.toggle("hanske", !!state.hanske);
  $("useCustomName").checked = !!state.useCustomName;
  $("customName").value = state.customName || "";
  $("customName").style.display = state.useCustomName ? "block" : "none";

  // Synk-nøkkelfelt: vises til første OK synk
  const hadKey = !!localStorage.getItem("broyte_api_key");
  if (hadKey && state.lastSyncAt) hideKeyRow(); // tidligere vellykket synk

  // Hjem handlers
  $("saveKey").onclick = ()=>{
    const key=$("apiKey").value.trim();
    if(!key) return alert("Lim inn nøkkel først");
    localStorage.setItem("broyte_api_key", key);
    $("apiKey").value="";
    $("syncStatus").textContent="Synk – nøkkel lagret ✅";
  };
  $("editKey").onclick = (e)=>{ e.preventDefault(); showKeyRow(); };

  $("role").onchange = ()=>{ state.role=$("role").value; save(); renderWork(); };
  $("direction").onchange = ()=>{ state.direction=$("direction").value; save(); renderWork(); };
  $("bigBtn").onchange = ()=>{ state.hanske=$("bigBtn").checked; document.body.classList.toggle("hanske",state.hanske); save(); };
  $("autoCheck").onchange = ()=>{ state.autoCheck=$("autoCheck").checked; save(); };
  $("useCustomName").onchange = ()=>{ state.useCustomName=$("useCustomName").checked; $("customName").style.display=state.useCustomName?"block":"none"; save(); renderWork(); };
  $("customName").addEventListener("input", ()=>{ state.customName=$("customName").value.trim(); save(); renderWork(); });

  $("btnStart").onclick = ()=>document.querySelector('.tab[data-tab="work"]').click();
  $("btnSyncNow").onclick = ()=> syncPull().then(()=>syncPush());
  $("btnResetAll").onclick = ()=>{
    if(!confirm("Nullstille ALLE adresser?")) return;
    state.stops.forEach(s=>{ s.f=false; s.b=false; s.started=null; s.finished=null; });
    save(); renderWork(); renderRegister(); syncPush();
  };
  $("btnRoundByEquip").onclick = ()=>{
    if(!confirm("Nullstille status for adresser som matcher valgt utstyr?")) return;
    state.stops.forEach(s=>{
      const t=s.t||"";
      const needP=/Brøyte/.test(t), needF=/Frese/.test(t), needS=/Strø/.test(t);
      const ok = (!needP || state.equipment.plog) && (!needF || state.equipment.fres) && (!needS || state.equipment.stro);
      if(ok){ s.f=false; s.b=false; s.started=null; s.finished=null; }
    });
    save(); renderWork(); renderRegister(); syncPush();
  };

  // Installer app – banner
  setupInstallBanner();

  // Utstyr
  ["eq_plog","eq_fres","eq_stro"].forEach(id=>{
    $(id).onchange = ()=>{
      state.equipment = { plog:$("eq_plog").checked, fres:$("eq_fres").checked, stro:$("eq_stro").checked };
      save();
    };
  });

  // Register
  $("btnCatalogPull").onclick = catalogPull;
  $("btnPropose").onclick = ()=>{
    const name = prompt("Navn (adresse/område):"); if(!name) return;
    const task = prompt("Oppgave (Brøyte/Frese/Strø/Brøyte og strø/Frese og strø/Brøytestikker):","Brøyte")||"Brøyte";
    const group= prompt("Borettslag/gruppe (valgfritt):","")||"";
    sendProposal({type:"add",name,task,group});
  };
  $("add").onclick = ()=>{
    const addr = $("addr").value.trim(); if(!addr) return;
    const task = $("taskSel").value;
    state.stops.push({ n:addr, t:task, f:false, b:false, p:[], started:null, finished:null, details:"" });
    $("addr").value="";
    save(); renderRegister(); syncPush();
  };
  $("addr").addEventListener("keydown",e=>{
    if(e.key==="Enter"){ e.preventDefault(); $("add").click(); }
  });

  // Under arbeid
  $("ongo").onclick = ()=>{
    const c = cur(); if(!c) return;
    c.started = c.started || Date.now();
    save(); renderWork(); syncPush();
  };
  $("done").onclick = ()=>{
    const c = cur(); if(!c) return;
    if(c.t==="Brøytestikker"){
      const v = prompt("Antall brøytestikker?",""); if(v===null) return;
      c.details = `Brøytestikker: ${parseInt(v||"0",10)||0}`;
    }
    c.f = true; c.finished = Date.now();
    save(); renderWork(); syncPush();
    const n = nxt(); if(n) navTo(n.n); else afterRound();
  };
  $("block").onclick = ()=>{
    const c = cur(); if(!c) return;
    const r = prompt("Hvorfor ikke mulig å utføre? (valgfritt)","")||"";
    if(r) c.details = (c.details?c.details+" · ":"") + "Årsak: " + r;
    c.b = true; c.finished = Date.now();
    save(); renderWork(); syncPush();
  };
  $("next").onclick = ()=>{
    const c = cur(); if(!c) return;
    if(confirm("Markere ferdig før neste?")){ c.f=true; c.finished=Date.now(); save(); syncPush(); }
    renderWork(); const n=nxt(); if(n) navTo(n.n);
  };
  $("nav").onclick = ()=>{ const c=cur(); if(c) navTo(c.n); };
  $("photo").onclick = ()=> $("fileInput").click();
  $("fileInput").onchange = e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{ const c=cur(); if(!c) return; (c.p||(c.p=[])).push(r.result); save(); renderWork(); syncPush(); };
    r.readAsDataURL(f); e.target.value="";
  };

  // Admin: status
  $("adminSync").onclick = ()=>{
    const c = prog();
    $("adminSyncTxt").textContent = "Viser lokal status (bruk Synk nå for MASTER).";
    $("adminStats").innerHTML = `Totalt: ${c.total} – Ferdig: ${c.done} – Ikke mulig: ${c.blocked} – Avklart: ${c.cleared} – ${c.pct}%`;
    $("adminList").innerHTML = state.stops.map((s,i)=>`<div class="item"><b>${i+1}. ${esc(s.n)}</b><br><span class="muted">${esc(s.t)}</span> ${s.f?'✅':''} ${s.b?'⛔':''}</div>`).join("");
  };

  // Admin: katalog
  $("catLoad").onclick = loadCatalog;
  $("catAdd").onclick = ()=> editCatalogRow(null);
  $("catSave").onclick = saveCatalogWithBackup;
  $("catPublish").onclick = publishCatalogToMaster;
  $("catExportCsv").onclick = exportCatalogCsv;
  $("catRestore").onclick = restoreCatalogFromBackup;

  // Admin: INBOX
  $("adminInbox").onclick = loadInbox;

  // Service
  $("svcSave").onclick = saveServiceReport;
  $("svcGuide").onclick = downloadGuidePdf;

  // Geoposisjon i footer
  initGeolocation();

  // Defaults
  bootDefaults();
  renderRegister();
  renderWork();

  // Heartbeat
  setInterval(()=>{ try{ syncPush(); }catch(_){ } }, HEARTBEAT_MS);

  // Refresh når du kommer tilbake fra Maps
  window.addEventListener("pageshow", ()=>{ try{ renderWork(); renderRegister(); }catch(_){} });
});

/* ===== Utils ===== */
function idxList(){
  const rem = state.stops.map((s,i)=>({i,s})).filter(x=>!x.s.f && !x.s.b).map(x=>x.i);
  return state.direction==="forward" ? rem : rem.slice().reverse();
}
function cur(){ const l=idxList(); return l.length? state.stops[l[0]] : null; }
function nxt(){ const l=idxList(); return l.length>1? state.stops[l[1]] : null; }
function prog(){
  const total=state.stops.length;
  const done=state.stops.filter(s=>s.f).length;
  const blocked=state.stops.filter(s=>s.b).length;
  const cleared=done+blocked;
  const pct = total? Math.round(100*cleared/total):0;
  return {total,done,blocked,cleared,pct};
}
function navTo(address){
  if(!address) return;
  location.href = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(address);
}
function afterRound(){
  const c = confirm("Runde ferdig ✅\nVil du starte ny runde (etter utstyr)?\nTrykk Avbryt for å gå til Service.");
  if(c){
    state.stops.forEach(s=>{
      const t=s.t||"";
      const needP=/Brøyte/.test(t), needF=/Frese/.test(t), needS=/Strø/.test(t);
      const ok = (!needP || state.equipment.plog) && (!needF || state.equipment.fres) && (!needS || state.equipment.stro);
      if(ok){ s.f=false; s.b=false; s.started=null; s.finished=null; }
    });
    save(); renderWork(); renderRegister(); syncPush();
    document.querySelector('.tab[data-tab="work"]')?.click();
  }else{
    document.querySelector('.tab[data-tab="service"]')?.click();
  }
}
function hideKeyRow(){ $("keyBlock").style.display="none"; $("saveKey").style.display="none"; $("editKey").style.display="inline"; }
function showKeyRow(){ $("keyBlock").style.display="inline-block"; $("saveKey").style.display="inline-block"; $("editKey").style.display="none"; }

/* ===== Render ===== */
function renderWork(){
  const c=cur(), n=nxt();
  if($("driverLbl")) $("driverLbl").textContent = "Rolle: " + displayName();
  if($("directionLbl")) $("directionLbl").textContent = "Retning: " + (state.direction==="forward"?"Vanlig":"Baklengs");
  if($("curName")) $("curName").textContent = c? esc(c.n) : "—";
  if($("curTask")) $("curTask").textContent = c? esc(c.t) : "—";
  if($("curNext")) $("curNext").textContent = n? esc(n.n) : "—";
  if($("thumbs")) $("thumbs").innerHTML = c?.p?.length ? c.p.map(src=>`<img src="${src}" alt="foto">`).join("") : "";
  const {pct,cleared,total} = prog();
  if($("progBar")) $("progBar").style.width = pct+"%";
  if($("progTxt")) $("progTxt").textContent = `${pct} % fullført (${cleared}/${total})`;
  if($("directionNote")) $("directionNote").textContent = `Du kjører i ${(state.direction==="forward"?'vanlig':'baklengs')} rekkefølge. (${displayName()})`;
  $("lastSyncText").textContent = `Sist synk: ${fmtTime(state.lastSyncAt)} (${state.lastSyncBy||'—'})`;
  $("lastSyncTextWork").textContent = `Sist synk: ${fmtTime(state.lastSyncAt)} (${state.lastSyncBy||'—'})`;
}
function renderRegister(){
  if(!$("list")) return;
  $("list").innerHTML = state.stops.length
    ? state.stops.map((s,i)=>`
        <div class="item">
          <b>${i+1}. ${esc(s.n)}</b><br>
          <span class="muted">${esc(s.t)}</span> ${s.f?'✅':''} ${s.b?'⛔':''}
        </div>`).join("")
    : `<div class="item muted">Ingen adresser enda. Hent fra katalog eller legg til lokalt.</div>`;
}

/* ===== Sync ===== */
async function syncPull(){
  try{
    const r = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_MASTER_BIN_ID}/latest`, { headers: headers() });
    const js = await r.json();
    if(js?.record?.stops){
      state.stops = js.record.stops.map(s=>({ n:s.n, t:s.t, f:!!s.f, b:!!s.b, p:s.p||[], started:s.started||null, finished:s.finished||null, details:s.details||"" }));
      state.lastSyncAt = js.record.lastSyncAt || Date.now();
      state.lastSyncBy = js.record.lastSyncBy || displayName();
      save(); renderWork(); renderRegister();
      $("syncStatus").textContent = "Synk – Pull OK";
      hideKeyRow();
    }else{
      $("syncStatus").textContent = "Synk – Pull tom";
    }
  }catch(e){
    $("syncStatus").textContent = "Synk – Pull FEIL";
    showKeyRow();
  }
}
async function syncPush(){
  try{
    const payload={ version:"9.7", updated: Date.now(), lastSyncAt: Date.now(), lastSyncBy: displayName(), stops: state.stops, meta:{role:state.role, direction:state.direction} };
    const r = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_MASTER_BIN_ID}`, { method:"PUT", headers: headers(), body: JSON.stringify(payload) });
    if(!r.ok) throw 0;
    state.lastSyncAt = payload.lastSyncAt; state.lastSyncBy = payload.lastSyncBy; save(); renderWork();
    $("syncStatus").textContent = "Synk – Push OK";
    hideKeyRow();
  }catch(e){
    $("syncStatus").textContent = "Synk – Push FEIL";
    showKeyRow();
  }
}

/* ===== Katalog (Admin) + Backup ===== */
async function loadCatalog(){
  try{
    $("catMsg").textContent="Laster katalog …";
    const r = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CATALOG_BIN_ID}/latest`);
    const js = await r.json();
    const cat = js?.record?.addresses || [];
    renderCatalogEditor(cat);
    $("catMsg").textContent=`Katalog lastet (${cat.length} adresser).`;
  }catch(e){
    $("catMsg").textContent="Feil ved lasting av katalog.";
  }
}
function renderCatalogEditor(items){
  $("catList").innerHTML = items.map((a,idx)=>`
    <div class="item" data-i="${idx}">
      <div class="row">
        <input class="cat-name" value="${esc(a.name||'')}" placeholder="Navn/adresse" style="flex:2">
        <select class="cat-task" style="flex:1">
          ${["Brøyte","Frese","Strø","Brøyte og strø","Frese og strø","Brøytestikker"].map(t=>`<option ${a.task===t?'selected':''}>${t}</option>`).join("")}
        </select>
        <input class="cat-group" value="${esc(a.group||'')}" placeholder="Gruppe/borettslag" style="flex:1">
      </div>
      <div class="row">
        <label><input class="cat-eq" type="checkbox" data-k="plog" ${a.equipment?.includes("plog")?'checked':''}> plog</label>
        <label><input class="cat-eq" type="checkbox" data-k="fres" ${a.equipment?.includes("fres")?'checked':''}> fres</label>
        <label><input class="cat-eq" type="checkbox" data-k="stro" ${a.equipment?.includes("stro")?'checked':''}> strø</label>
        <label><input class="cat-active" type="checkbox" ${a.active!==false?'checked':''}> aktiv</label>
        <button class="btn btn-gray cat-edit" data-act="dup">Dupliser</button>
        <button class="btn btn-red cat-edit" data-act="del">Slett</button>
      </div>
    </div>`).join("");

  // Wire up buttons
  $("catList").querySelectorAll(".cat-edit").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const wrap = btn.closest(".item"); const i = +wrap.dataset.i;
      let arr = readCatalogFromDom();
      if(btn.dataset.act==="del") arr.splice(i,1);
      if(btn.dataset.act==="dup") arr.splice(i+1,0, {...arr[i]});
      renderCatalogEditor(arr);
    });
  });

  // Keep a copy in element dataset (simple)
  $("catList").dataset.json = JSON.stringify(items);
}
function readCatalogFromDom(){
  const nodes = [...$("catList").querySelectorAll(".item")];
  return nodes.map(wrap=>{
    const name = wrap.querySelector(".cat-name").value.trim();
    const task = wrap.querySelector(".cat-task").value;
    const group= wrap.querySelector(".cat-group").value.trim();
    const eqs = [...wrap.querySelectorAll(".cat-eq")].filter(x=>x.checked).map(x=>x.dataset.k);
    const active = wrap.querySelector(".cat-active").checked;
    return {name,task,group,equipment:eqs,active};
  });
}
async function saveCatalogWithBackup(){
  try{
    const items = readCatalogFromDom();
    $("catMsg").textContent = "Lagrer (tar backup først)…";
    // 1) Hent eksisterende katalog
    const latest = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CATALOG_BIN_ID}/latest`).then(r=>r.json());
    const current = latest?.record || {version:"9.7",updated:0,addresses:[]};
    // 2) Skriv backup
    const backupLatest = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BACKUP_BIN_ID}/latest`, { headers: headers() }).then(r=>r.json()).catch(()=>({record:{version:"backup_v1",backups:[]}}));
    const backups = backupLatest?.record?.backups || [];
    backups.push({ ts: Date.now(), data: current });
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BACKUP_BIN_ID}`, { method:"PUT", headers: headers(), body: JSON.stringify({ version:"backup_v1", backups }) });

    // 3) Lagre ny katalog
    const rec = { version:"9.7", updated: Date.now(), addresses: items };
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CATALOG_BIN_ID}`, { method:"PUT", headers: headers(), body: JSON.stringify(rec) });
    $("catMsg").textContent = "Katalog lagret ✔︎";
  }catch(e){
    $("catMsg").textContent = "Feil ved lagring (sjekk nøkkel).";
  }
}
async function restoreCatalogFromBackup(){
  try{
    $("catMsg").textContent = "Henter backup…";
    const js = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BACKUP_BIN_ID}/latest`, { headers: headers() }).then(r=>r.json());
    const backups = js?.record?.backups||[];
    if(!backups.length) return $("catMsg").textContent="Ingen backup funnet.";
    const last = backups[backups.length-1];
    const rec = last.data || {addresses:[]};
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CATALOG_BIN_ID}`, { method:"PUT", headers: headers(), body: JSON.stringify(rec) });
    $("catMsg").textContent = "Gjenopprettet fra backup ✔︎";
    renderCatalogEditor(rec.addresses||[]);
  }catch(e){
    $("catMsg").textContent = "Feil ved gjenoppretting.";
  }
}
async function publishCatalogToMaster(){
  try{
    $("catMsg").textContent="Publiserer til MASTER…";
    const items = readCatalogFromDom().filter(a=>a.active!==false);
    // Filtrer på utstyr valgt lokalt (valgfritt)
    const need = {plog:!!state.equipment.plog, fres:!!state.equipment.fres, stro:!!state.equipment.stro};
    const filtered = items.filter(a=>{
      const eq=a.equipment||[]; if(!eq.length) return true; return eq.some(k=>need[k]);
    });
    const stops = filtered.map(a=>({ n:a.name, t:a.task, f:false, b:false, p:[], started:null, finished:null, details:"" }));
    const payload={ version:"9.7", updated: Date.now(), lastSyncAt: Date.now(), lastSyncBy: displayName(), stops, meta:{role:state.role, direction:state.direction} };
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_MASTER_BIN_ID}`, { method:"PUT", headers: headers(), body: JSON.stringify(payload) });
    $("catMsg").textContent="Publisert ✔︎ – be sjåfører trykke «Synk nå».";
  }catch(e){
    $("catMsg").textContent="Feil ved publisering (sjekk nøkkel).";
  }
}
function exportCatalogCsv(){
  try{
    const items = readCatalogFromDom();
    const rows = ['Navn,Oppgave,Gruppe,Utstyr, Aktiv'];
    items.forEach(a=> rows.push(`"${(a.name||'').replace(/"/g,'""')}","${(a.task||'').replace(/"/g,'""')}","${(a.group||'').replace(/"/g,'""')}","${(a.equipment||[]).join('+')}","${a.active!==false?'Ja':'Nei'}"`));
    const csv = rows.join("\n");
    const file = new File([csv],'katalog.csv',{type:'text/csv'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      navigator.share({title:'Katalog',text:'CSV-katalog',files:[file]}).catch(()=>{});
    }else{
      const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.download='katalog.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    }
  }catch(_){}
}

/* ===== INBOX ===== */
async function sendProposal(obj){
  try{
    const latest = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_INBOX_BIN_ID}/latest`, { headers: headers() }).then(r=>r.json());
    const rec = latest?.record || {version:"9.7", updated:0, proposals:[]};
    rec.proposals = rec.proposals || [];
    rec.proposals.push({ id: Math.random().toString(36).slice(2), type: obj.type||"add", from: displayName(), payload: obj, ts: Date.now(), status:"pending", note:"" });
    rec.updated = Date.now();
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_INBOX_BIN_ID}`, { method:"PUT", headers: headers(), body: JSON.stringify(rec) });
    alert("Forslag sendt 👍");
  }catch(e){ alert("Kunne ikke sende forslag. Sjekk nøkkel."); }
}
async function loadInbox(){
  try{
    const js = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_INBOX_BIN_ID}/latest`, { headers: headers() }).then(r=>r.json());
    const props = js?.record?.proposals||[];
    $("adminInboxTxt").textContent = "Forslag: " + props.length;
    $("inboxList").innerHTML = props.slice(-50).reverse().map(p=>`
      <div class="item">
        <b>${(p.type||'').toUpperCase()}</b> – fra ${p.from||'?'} – ${new Date(p.ts).toLocaleString('no-NO')}<br>
        <span class="muted">${(p.payload?.name||'')} ${(p.payload?.task||'')}</span><br>
        <span class="badge">${p.status||'pending'}</span>
      </div>`).join("");
  }catch(e){ $("adminInboxTxt").textContent = "Feil ved henting."; }
}

/* ===== GEO ===== */
function initGeolocation(){
  const posEl = $("pos"); if(!posEl) return;
  if(!navigator.geolocation){ posEl.textContent="Posisjon ikke tilgjengelig"; return; }
  const fmt=n=>Number.isFinite(n)?n.toFixed(5):"—";
  navigator.geolocation.watchPosition(
    (p)=>{ const {latitude,longitude,accuracy}=p.coords||{}; posEl.textContent = `${fmt(latitude)}, ${fmt(longitude)} (±${Math.round(accuracy||0)} m)`; },
    ()=>{ posEl.textContent = "Posisjon utilgjengelig"; },
    { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
  );
}

/* ===== PWA Install Banner ===== */
function setupInstallBanner(){
  const card = $("installCard");
  if (!card) return;
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  if (isStandalone) return; // allerede installert
  card.style.display = "block";
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    card.style.display = "block";
  });
  $("btnInstall").onclick = async ()=>{
    if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; card.style.display="none"; }
    else { $("installHelp").style.display="block"; }
  };
  $("btnInstallHelp").onclick = ()=>{ $("installHelp").style.display = $("installHelp").style.display==="none"?"block":"none"; };
}

/* ===== Service-rapport + PDF-guide ===== */
function saveServiceReport(){
  state.service = {
    plog:$("svc_plog").checked, fres:$("svc_fres").checked, stro:$("svc_stro").checked,
    other:$("svc_other").checked, notes: $("svcNotes").value.trim()
  };
  save();
  const rows = ['Navn,Oppgave,Ferdig,Blokkert,Start,Slutt'];
  state.stops.forEach(s=>{
    rows.push(`"${(s.n||'').replace(/"/g,'""')}","${(s.t||'').replace(/"/g,'""')}",${s.f?'Ja':'Nei'},${s.b?'Ja':'Nei'},${s.started?new Date(s.started).toISOString():""},${s.finished?new Date(s.finished).toISOString():""}`);
  });
  const csv = rows.join("\n");
  const file = new File([csv],'broeyting_rapport.csv',{type:'text/csv'});
  if(navigator.canShare && navigator.canShare({files:[file]})){
    navigator.share({title:'Brøyterapport',text:'CSV-rapport',files:[file]}).catch(()=>{});
  }else{
    const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.download='broeyting_rapport.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    alert("Rapport lastet ned (CSV).");
  }
}
function downloadGuidePdf(){
  // Minimal inline PDF (uten ekstern lib)
  const content = `
Brøyterute – v9.7 (Romerike Trefelling)

Oppsett
1) Åpne lenken og legg på Hjem-skjermen (iPhone: Safari del → Legg til på Hjem-skjermen).
2) Hjem → lim inn X-Master-Key → Lagre nøkkel → Synk nå.
3) Velg rolle/navn, retning og utstyr.

Kjøring
- Under arbeid viser Nåværende og Neste.
- Bruk Pågår/Ferdig/Ikke mulig/Foto/Naviger.
- Start ny runde (etter utstyr) for nytt pass.

Admin
- Admin-fanen lar deg redigere katalog og publisere ny rute.
- Backup tas automatisk og kan gjenopprettes.

Kontakt:
Ved feil eller spørsmål, kontakt: Øystein Diesen Gjeraldstveit
  `.trim();
  const blob = new Blob([content],{type:"text/plain"}); // enkel .txt (printervennlig) – bytt til ekte PDF senere
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='brukerark.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
}

/* ===== Defaults ===== */
function bootDefaults(){
  if(!Array.isArray(state.stops)) state.stops=[];
  if(state.stops.length===0){
    state.stops = [
      { n:"AMFI Eidsvoll (Råholt)", t:"Brøyte", f:false, b:false, p:[] },
      { n:"Råholt barneskole", t:"Brøyte og strø", f:false, b:false, p:[] },
      { n:"Råholt ungdomsskole", t:"Frese", f:false, b:false, p:[] }
    ];
    save();
  }
}
</script>

</div> <!-- /#app -->
</body>
</html>
