<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brøyterute – Dal/Råholt (v4 med Google Maps navigasjon)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    header, footer {
      padding: 8px 12px; background: #111; color: #fff;
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    header h1 { font-size: 16px; margin: 0 8px 0 0; }
    #map { width: 100%; height: 100%; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .toolbar input[type="text"] { padding: 6px 8px; width: 240px; }
    .toolbar input[type="number"] { padding: 6px 8px; width: 90px; }
    .toolbar button { padding: 6px 10px; cursor: pointer; }
    #panel { padding: 8px 12px; background: #f7f7f7; display: grid; gap: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #ddd; font-size: 14px; vertical-align: top; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    .done { background: #d4edda; color: #155724; }
    .pending { background: #ffeeba; color: #856404; }
    .blocked { background: #f8d7da; color: #721c24; }
    .small { font-size: 12px; color: #555; }
    .hint { color: #e0e0e0; font-size: 12px; margin-left: auto; }
    .thumbs { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
    .thumbs img { width: 56px; height: 56px; object-fit: cover; border-radius: 4px; border:1px solid #ccc; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; }
    .overlay img { max-width: 95vw; max-height: 95vh; }
    .seq { font-weight:700; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Brøyterute – Dal/Råholt</h1>
    <div class="toolbar">
      <input id="addr" type="text" placeholder="Adresse/område (f.eks. AMFI Eidsvoll)" />
      <button id="btnGeocode">Legg til</button>
      <button id="btnAddClick">Klikk i kart</button>
      <label>Radius (m): <input id="radius" type="number" min="10" step="5" value="40" /></label>
      <button id="btnOptimize">Optimaliser rekkefølge</button>
      <button id="btnDraw">Tegn rute (på kart)</button>
      <button id="btnNavNext" style="background:#2b7cff;color:#fff;border:1px solid #2b7cff;"><strong>Naviger (Google Maps)</strong></button>
      <button id="btnNavAll">Naviger alle (Google Maps)</button>
      <button id="btnStartTracking">Start sporing</button>
      <button id="btnStopTracking">Stopp sporing</button>
      <button id="btnExportCsv">Eksporter CSV</button>
      <button id="btnExportZip">Eksporter ZIP</button>
      <button id="btnLoadDemo">Last inn demo-adresser</button>
      <button id="btnReset">Nullstill alt</button>
    </div>
  </header>

  <div id="map"></div>

  <div id="panel">
    <strong>Steder og status</strong>
    <div class="small">Rekkefølge = radnummer. Trykk på rad for å zoome. “Naviger” sender deg til neste uferdige/ikke-blokkerte stopp i rekkefølgen.</div>
    <table id="stopsTbl">
      <thead>
        <tr>
          <th class="seq">#</th><th>Navn</th><th>Oppgave</th><th>Geofence</th><th>Status</th><th>Begrunnelse / Foto</th><th>Handling</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>
    <div>Live posisjon: <span id="posTxt">—</span></div>
    <div style="margin-left:12px;">Neste mål: <span id="nextTxt">—</span></div>
    <div class="hint" style="margin-left:auto;">Åpnes best i Google Maps-appen på iPhone.</div>
  </footer>
</div>

<div id="overlay" class="overlay" onclick="this.style.display='none'"><img id="overlayImg" alt="Bilde"/></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const DEMO_STOPS = [
  { name: 'AMFI Eidsvoll (Råholt)', task: 'Brøyting – P-plasser', lat: 60.2847, lng: 11.1759, radius: 45 },
  { name: 'Råholt barneskole', task: 'Brøyting – adkomst og snuplass', lat: 60.2816, lng: 11.1931, radius: 45 },
  { name: 'Råholt ungdomsskole', task: 'Brøyting – hovedinngang og rampe', lat: 60.2776, lng: 11.1867, radius: 45 },
  { name: 'Råholt kirke', task: 'Brøyting – gangvei og HC', lat: 60.2810, lng: 11.1838, radius: 40 },
  { name: 'Dal stasjon', task: 'Brøyting – kiss & ride og rampe', lat: 60.2697, lng: 11.2079, radius: 45 },
  { name: 'Eidsvoll Verk stasjon', task: 'Brøyting – P-plass sør', lat: 60.2569, lng: 11.1802, radius: 45 }
];

let map, stops = [], markers = [], routeLine = null, watchId = null, clickAddMode = false;
let logs = JSON.parse(localStorage.getItem('snow_logs') || '[]');

function saveState(){ localStorage.setItem('snow_stops', JSON.stringify(stops)); localStorage.setItem('snow_logs', JSON.stringify(logs)); }
function loadState(){
  try { const s = JSON.parse(localStorage.getItem('snow_stops') || '[]'); stops = s.length ? s : DEMO_STOPS.map(d=>({...d,done:false,blocked:false,blockedReason:'',enteredAt:null,photos:[]})); }
  catch(e){ stops = DEMO_STOPS.map(d=>({...d,done:false,blocked:false,blockedReason:'',enteredAt:null,photos:[]})); }
  saveState();
}

function haversine(a,b){const R=6371000,toRad=d=>d*Math.PI/180,dLat=toRad(b.lat-a.lat),dLon=toRad(b.lng-a.lng),lat1=toRad(a.lat),lat2=toRad(b.lat);const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));}
function csvEscape(s){const t=(s||'').replace(/"/g,'""');return `"${t}"`;}

function initMap(){
  map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
  map.setView([60.283,11.187],13);
  map.on('click', (e)=>{
    if(!clickAddMode) return;
    const name = prompt('Navn på sted:', 'Nytt sted');
    const task = prompt('Hva skal gjøres her?', 'Brøyting');
    const radius = Number(document.getElementById('radius').value)||40;
    addStop({name, task, lat:e.latlng.lat, lng:e.latlng.lng, radius, done:false, blocked:false, blockedReason:'', enteredAt:null, photos:[]});
    clickAddMode=false; document.getElementById('btnAddClick').classList.remove('active');
  });
}
function addStop(s){ stops.push(s); saveState(); renderStops(); redrawMarkers(); }
function removeStop(i){ stops.splice(i,1); saveState(); renderStops(); redrawMarkers(); }
function redrawMarkers(){
  markers.forEach(m=>map.removeLayer(m.marker));
  markers=[];
  stops.forEach((s,i)=>{
    const color = s.blocked ? '#dc3545' : (s.done ? '#28a745' : '#f0ad4e');
    const circle = L.circle([s.lat,s.lng],{radius:s.radius||40,color});
    const marker = L.marker([s.lat,s.lng]).bindPopup(`<strong>${i+1}. ${s.name||'Uten navn'}</strong><br>${s.task||''}<br>Status: ${s.blocked?'Ikke mulig':(s.done?'Ferdig':'Utestår')}<br>Radius: ${s.radius||40} m`);
    const group = L.layerGroup([circle,marker]).addTo(map);
    markers.push({marker,circle,group});
  });
  fitToContent();
}
function fitToContent(){ if(!stops.length) return; const b=L.latLngBounds(stops.map(s=>[s.lat,s.lng])); map.fitBounds(b.pad(0.2)); }
function renderStops(){
  const tbody=document.querySelector('#stopsTbl tbody'); tbody.innerHTML='';
  stops.forEach((s,i)=>{
    const tr=document.createElement('tr');
    const badge=s.blocked?'<span class="badge blocked">Ikke mulig</span>':(s.done?'<span class="badge done">Ferdig</span>':'<span class="badge pending">Utestår</span>');
    tr.innerHTML=`
      <td class="seq">${i+1}</td>
      <td contenteditable="true" data-field="name">${s.name||''}</td>
      <td contenteditable="true" data-field="task">${s.task||''}</td>
      <td><input type="number" min="5" step="5" value="${s.radius||40}" style="width:80px"/></td>
      <td>${badge}<div class="small">${s.enteredAt?new Date(s.enteredAt).toLocaleString():''}</div></td>
      <td><div class="small">${s.blockedReason?('Begrunnelse: '+s.blockedReason):''}</div><div class="thumbs" id="thumbs-${i}"></div></td>
      <td style="min-width:240px">
        <button data-action="check" ${s.done?'disabled':''}>Sjekk inn</button>
        <button data-action="block">Ikke mulig</button>
        <button data-action="clearblock" ${s.blocked?'':'disabled'}>Fjern blokkering</button>
        <button data-action="photo">Foto</button>
        <button data-action="del">Slett</button>
      </td>`;
    tr.addEventListener('click',(ev)=>{ if(ev.target.tagName==='BUTTON'||ev.target.tagName==='INPUT') return; map.setView([s.lat,s.lng],17); if(markers[i]) markers[i].marker.openPopup(); });
    tr.querySelector('[data-field="name"]').addEventListener('input',(e)=>{ s.name=e.target.innerText.trim(); saveState(); redrawMarkers(); });
    tr.querySelector('[data-field="task"]').addEventListener('input',(e)=>{ s.task=e.target.innerText.trim(); saveState(); });
    tr.querySelector('input[type="number"]').addEventListener('change',(e)=>{ s.radius=Number(e.target.value)||40; saveState(); if(markers[i]) markers[i].circle.setRadius(s.radius); });
    tr.querySelector('button[data-action="check"]').addEventListener('click',()=>manualCheckIn(i));
    tr.querySelector('button[data-action="block"]').addEventListener('click',()=>markBlocked(i));
    tr.querySelector('button[data-action="clearblock"]').addEventListener('click',()=>clearBlocked(i));
    tr.querySelector('button[data-action="photo"]').addEventListener('click',()=>addPhoto(i));
    tr.querySelector('button[data-action="del"]').addEventListener('click',()=>removeStop(i));
    if(s.photos&&s.photos.length){ const cont=tr.querySelector('#thumbs-'+i); s.photos.forEach((ph,pidx)=>{ const img=document.createElement('img'); img.src=ph.dataUrl; img.alt=ph.name||('bilde_'+(pidx+1)); img.title=new Date(ph.ts).toLocaleString(); img.addEventListener('click',()=>{ const ov=document.getElementById('overlay'); const oi=document.getElementById('overlayImg'); oi.src=ph.dataUrl; ov.style.display='flex'; }); cont.appendChild(img); }); }
    tbody.appendChild(tr);
  });
}

function manualCheckIn(i){ if(!stops[i])return; stops[i].done=true; stops[i].blocked=false; stops[i].enteredAt=new Date().toISOString(); logs.push({idx:i+1,name:stops[i].name||'',task:stops[i].task||'',timestamp:stops[i].enteredAt,lat:stops[i].lat,lng:stops[i].lng,status:'done',reason:''}); saveState(); renderStops(); redrawMarkers(); }
function markBlocked(i){ if(!stops[i])return; const reason=prompt('Begrunnelse (f.eks. bil i veien, sperret port):',stops[i].blockedReason||''); stops[i].blocked=true; stops[i].done=false; stops[i].blockedReason=(reason||'').trim(); stops[i].enteredAt=new Date().toISOString(); logs.push({idx:i+1,name:stops[i].name||'',task:stops[i].task||'',timestamp:stops[i].enteredAt,lat:stops[i].lat,lng:stops[i].lng,status:'blocked',reason:stops[i].blockedReason}); saveState(); renderStops(); redrawMarkers(); }
function clearBlocked(i){ if(!stops[i])return; stops[i].blocked=false; saveState(); renderStops(); redrawMarkers(); }
async function addPhoto(i){ if(!stops[i])return; const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment'; input.onchange=async()=>{ const f=input.files&&input.files[0]; if(!f)return; const dataUrl=await resizeToDataURL(f,1600); const ph={name:f.name||'bilde.jpg',dataUrl,ts:Date.now()}; stops[i].photos=stops[i].photos||[]; stops[i].photos.push(ph); saveState(); renderStops(); }; input.click(); }
function resizeToDataURL(file,maxDim=1600){return new Promise((resolve,reject)=>{const reader=new FileReader(); reader.onload=()=>{const img=new Image(); img.onload=()=>{let{width,height}=img; const scale=Math.min(1,maxDim/Math.max(width,height)); const w=Math.round(width*scale),h=Math.round(height*scale); const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); resolve(canvas.toDataURL('image/jpeg',0.85));}; img.onerror=reject; img.src=reader.result;}; reader.onerror=reject; reader.readAsDataURL(file);}); }

function startTracking(){ if(!navigator.geolocation){alert('Geolokasjon ikke støttet.');return;} if(watchId)return; watchId=navigator.geolocation.watchPosition((pos)=>{ const {latitude,longitude,accuracy}=pos.coords; document.getElementById('posTxt').textContent=`${latitude.toFixed(5)}, ${longitude.toFixed(5)} (±${Math.round(accuracy)} m)`; L.circleMarker([latitude,longitude],{radius:6}).addTo(map); autoCheckInIfInside(pos); },(err)=>{ alert('Kunne ikke hente posisjon: '+err.message); },{enableHighAccuracy:true,maximumAge:5000,timeout:20000}); }
function stopTracking(){ if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; } }
function autoCheckInIfInside(pos){ const p={lat:pos.coords.latitude,lng:pos.coords.longitude}; let nextIdx=stops.findIndex(s=>!s.done && !s.blocked); if(nextIdx===-1) return; const s=stops[nextIdx]; const d=haversine(p,s); document.getElementById('nextTxt').textContent=`${s.name||'Uten navn'} (${d.toFixed(0)} m)`; if(d <= (s.radius||40)){ s.done=true; s.blocked=false; s.enteredAt=new Date().toISOString(); logs.push({idx:nextIdx+1,name:s.name||'',task:s.task||'',timestamp:s.enteredAt,lat:s.lat,lng:s.lng,status:'done-auto',reason:''}); saveState(); renderStops(); redrawMarkers(); nextIdx=stops.findIndex(s=>!s.done && !s.blocked); if(nextIdx!==-1) map.setView([stops[nextIdx].lat,stops[nextIdx].lng],16); } }

function navigateToNext(){
  const nextIdx = stops.findIndex(s => !s.done && !s.blocked);
  if (nextIdx === -1){ alert('Ingen flere stopp å navigere til.'); return; }
  const s = stops[nextIdx];
  const url = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}&travelmode=driving`;
  window.location.href = url;
}
function navigateAll(){
  const remaining = stops.filter(s => !s.done && !s.blocked);
  if (remaining.length === 0){ alert('Ingen stopp gjenstår.'); return; }
  const origin = 'Current+Location';
  const destination = `${remaining[remaining.length-1].lat},${remaining[remaining.length-1].lng}`;
  const middle = remaining.slice(0, -1).map(s => `${s.lat},${s.lng}`);
  const waypoints = middle.length ? '&waypoints=' + encodeURIComponent(middle.join('|')) : '';
  const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}&travelmode=driving`;
  window.location.href = url;
}

async function drawRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  if(stops.length<2) return;
  try{
    const coords = stops.map(s=>`${s.lng},${s.lat}`).join(';');
    const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
    const res = await fetch(url); const data = await res.json();
    if(data && data.routes && data.routes[0]){ const line = data.routes[0].geometry; routeLine = L.geoJSON(line).addTo(map); }
    else { routeLine = L.polyline(stops.map(s=>[s.lat,s.lng]), {weight:4}).addTo(map); }
  }catch(e){ routeLine = L.polyline(stops.map(s=>[s.lat,s.lng]), {weight:4}).addTo(map); }
}

async function geocodeAddress(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + ', Eidsvoll, Norway')}`;
  const res = await fetch(url, {headers:{'Accept-Language':'no'}});
  const data = await res.json();
  if(!data || !data[0]){ alert('Fant ikke adresse. Prøv mer spesifikt.'); return; }
  const best = data[0];
  const radius = Number(document.getElementById('radius').value) || 40;
  addStop({name:q, task:'Brøyting', lat:Number(best.lat), lng:Number(best.lon), radius, done:false, blocked:false, blockedReason:'', enteredAt:null, photos:[]});
  map.setView([Number(best.lat), Number(best.lon)], 17);
}

function exportCsv(){
  const header=['Rekkefølge','Navn','Oppgave','Status','Begrunnelse','Tidspunkt (ISO)','Lat','Lng','Antall bilder'];
  const rows=stops.map((s,i)=>{ const status=s.blocked?'blocked':(s.done?'done':'pending'); return [i+1,csvEscape(s.name||''),csvEscape(s.task||''),status,csvEscape(s.blockedReason||''),s.enteredAt||'',s.lat,s.lng,(s.photos||[]).length]; });
  const csv=[header.join(','),...rows.map(r=>r.join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='broeyting_logg.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
async function exportZip(){
  const zip=new JSZip();
  const header=['Rekkefølge','Navn','Oppgave','Status','Begrunnelse','Tidspunkt (ISO)','Lat','Lng','Antall bilder'];
  const rows=stops.map((s,i)=>{ const status=s.blocked?'blocked':(s.done?'done':'pending'); return [i+1,s.name||'',s.task||'',status,s.blockedReason||'',s.enteredAt||'',s.lat,s.lng,(s.photos||[]).length].map(v=>typeof v==='string'?`"${v.replace(/"/g,'""')}"`:v).join(','); });
  const csv=[header.join(','),...rows].join('\n'); zip.file('broeyting_logg.csv',csv);
  for(let i=0;i<stops.length;i++){ const s=stops[i]; if(!s.photos||!s.photos.length) continue; const folder=zip.folder(`${String(i+1).padStart(2,'0')}_${(s.name||'Uten_navn').replace(/[^a-zA-Z0-9_æøåÆØÅ -]/g,'_')}`); for(let p=0;p<s.photos.length;p++){ const ph=s.photos[p]; const base64=ph.dataUrl.split(',')[1]; folder.file(`${String(p+1).padStart(2,'0')}_${ph.name.replace(/[^a-zA-Z0-9_æøåÆØÅ .-]/g,'_')}`, base64,{base64:true}); } }
  const blob=await zip.generateAsync({type:'blob'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='broeyting_dokumentasjon.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

document.getElementById('btnGeocode').addEventListener('click',()=>{ const q=document.getElementById('addr').value.trim(); if(!q) return; geocodeAddress(q); });
document.getElementById('btnAddClick').addEventListener('click',(e)=>{ clickAddMode=!clickAddMode; e.target.classList.toggle('active',clickAddMode); if(clickAddMode) alert('Klikk i kartet for å legge til et punkt.'); });
document.getElementById('btnOptimize').addEventListener('click',()=>{ if(stops.length<=2) return; const center=map.getCenter(); let startIdx=0,bestD=Infinity; stops.forEach((s,i)=>{ const d=haversine({lat:center.lat,lng:center.lng},s); if(d<bestD){bestD=d; startIdx=i;} }); const order=(function(points,startIndex=0){ if(points.length<=2) return points.map((p,i)=>i); const remaining=new Set(points.map((_,i)=>i)); const out=[]; let cur=startIndex; out.push(cur); remaining.delete(cur); while(remaining.size){ let best=null,bd=Infinity; for(const i of remaining){ const d=haversine(points[cur],points[i]); if(d<bd){bd=d; best=i;} } out.push(best); remaining.delete(best); cur=best; } return out; })(stops.map(s=>({lat:s.lat,lng:s.lng})),startIdx); stops = order.map(i=>stops[i]); saveState(); renderStops(); redrawMarkers(); });
document.getElementById('btnDraw').addEventListener('click', drawRoute);
document.getElementById('btnNavNext').addEventListener('click', navigateToNext);
document.getElementById('btnNavAll').addEventListener('click', navigateAll);
document.getElementById('btnStartTracking').addEventListener('click', startTracking);
document.getElementById('btnStopTracking').addEventListener('click', stopTracking);
document.getElementById('btnExportCsv').addEventListener('click', exportCsv);
document.getElementById('btnExportZip').addEventListener('click', exportZip);
document.getElementById('btnLoadDemo').addEventListener('click', ()=>{ if(!confirm('Erstatt nåværende liste med demo-adresser?')) return; stops = DEMO_STOPS.map(d=>({...d,done:false,blocked:false,blockedReason:'',enteredAt:null,photos:[]})); saveState(); renderStops(); redrawMarkers(); fitToContent(); });
document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('Slette alle stopp og logger?')) return; stops=[]; logs=[]; saveState(); renderStops(); redrawMarkers(); });

loadState();
initMap();
renderStops();
redrawMarkers();
</script>
</body>
</html>
